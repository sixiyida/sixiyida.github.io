<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Guide and Code Explanation for SAA Graph">
<title>Spring AI Alibaba Graph ä½¿ç”¨æŒ‡å—ä¸æºç è§£è¯»</title>

<link rel='canonical' href='https://sixiyida.github.io/p/spring-ai-alibaba-graph-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/'>

<link rel="stylesheet" href="/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css"><meta property='og:title' content="Spring AI Alibaba Graph ä½¿ç”¨æŒ‡å—ä¸æºç è§£è¯»">
<meta property='og:description' content="Guide and Code Explanation for SAA Graph">
<meta property='og:url' content='https://sixiyida.github.io/p/spring-ai-alibaba-graph-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/'>
<meta property='og:site_name' content='sixiyida'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Java' /><meta property='article:tag' content='LLM' /><meta property='article:tag' content='Infrastructure' /><meta property='article:published_time' content='2025-07-15T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-07-15T00:00:00&#43;00:00'/>
<meta name="twitter:title" content="Spring AI Alibaba Graph ä½¿ç”¨æŒ‡å—ä¸æºç è§£è¯»">
<meta name="twitter:description" content="Guide and Code Explanation for SAA Graph">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_599050889a64db87.png" width="300"
                            height="299" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ˜€</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">sixiyida</a></h1>
            <h2 class="site-description">sixiyida&#39;s notes</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/sixiyida'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.xiaohongshu.com/user/profile/6329e87e000000002303d3d3'
                        target="_blank"
                        title="RedBook"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Created with Inkscape (http://www.inkscape.org/) -->

<svg
   version="1.1"
   id="svg1"
   width="256"
   height="256"
   viewBox="0 0 256 256"
   sodipodi:docname="XiaohongshuLOGO.png"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg">
  <defs
     id="defs1" />
  <sodipodi:namedview
     id="namedview1"
     pagecolor="#ffffff"
     bordercolor="#000000"
     borderopacity="0.25"
     inkscape:showpageshadow="2"
     inkscape:pageopacity="0.0"
     inkscape:pagecheckerboard="0"
     inkscape:deskcolor="#d1d1d1"
     inkscape:zoom="2.6914062"
     inkscape:cx="127.81422"
     inkscape:cy="128"
     inkscape:window-width="1600"
     inkscape:window-height="928"
     inkscape:window-x="0"
     inkscape:window-y="0"
     inkscape:window-maximized="1"
     inkscape:current-layer="g1" />
  <g
     inkscape:groupmode="layer"
     inkscape:label="Image"
     id="g1">
    <path
       style="fill:#ff2842;stroke:none"
       d="M 29,0.33332825 C 13.959937,3.4666748 1.5356731,15.204498 0,31 -1.586103,47.314209 0,64.597672 0,81 v 102 c 0,18.76035 -4.7369685,44.19888 7.3333335,60 C 20.372129,260.06897 44.156731,256 63,256 h 111 35 c 5.78276,0 12.33244,0.84741 18,-0.33333 15.0401,-3.13336 27.46432,-14.87115 29,-30.66667 1.58612,-16.31419 0,-33.59769 0,-50 V 73 C 256,54.239685 260.73697,28.801102 248.66667,13 235.62787,-4.0689697 211.84329,0 193,0 H 82 47 C 41.217228,0 34.667561,-0.84741211 29,0.33332825 M 120,91 l -7,19 h 12 l -10,24 9,1 c -0.98794,2.68155 -2.31718,7.73317 -4.33334,9.83334 C 118.18945,146.3721 115.92654,146 114,146 c -4.35942,0 -13.16798,1.80539 -15.5,-3 -1.069664,-2.20416 0.465553,-4.98451 1.333336,-7 1.813624,-4.21228 4.222554,-8.51549 5.166664,-13 -2.17548,0 -4.92464,0.42967 -7,-0.33333 -7.778526,-2.85974 0.874031,-15.36435 2.66666,-19.66667 1.25875,-3.020981 2.75652,-9.584732 5.5,-11.5 C 110.01874,88.810822 115.88325,90.674988 120,91 m -79,63 c 2.750713,0 6.837379,0.81721 8.5,-2 1.769028,-2.99753 0.5,-9.58963 0.5,-13 V 106 C 50,102.90659 48.438198,93.464493 51.166668,91.5 53.41069,89.884308 62.832935,90.226166 63.833332,93 65.47065,97.539825 64,105.16241 64,110 v 32 c 0,5.48389 0.949112,11.8645 -1.333332,17 -2.177158,4.89861 -12.303417,9.27243 -17.333336,5.5 C 43.120155,162.84012 41.545292,156.59013 41,154 M 193,91 v 5 c 3.72887,0 8.4108,-0.763367 12,0.333328 11.97635,3.659424 11,15.422502 11,25.666672 1.99706,0 4.04419,-0.15562 6,0.33333 11.49335,2.87334 10,14.36401 10,23.66667 0,4.95615 0.93086,10.82184 -2.33333,15 -3.59567,4.60246 -9.48195,4 -14.66667,4 -1.6116,0 -4.26318,0.51051 -5.66667,-0.5 -2.62326,-1.88875 -3.78159,-7.50485 -4.33333,-10.5 3.28711,0 9.2179,1.12517 11.83333,-1.33334 C 219.9164,149.76859 218.65411,138.43454 215,136.5 c -1.93661,-1.02527 -4.88672,-0.5 -7,-0.5 h -15 v 29 h -14 v -29 h -14 v -14 h 14 v -12 h -9 V 96 h 9 v -5 h 14 m -32,5 v 14 h -8 v 42 h 13 v 13 H 120 L 125.33334,152.5 138,152 v -42 h -8 V 96 h 31 m 57,14 c 0,-2.84204 -0.51608,-6.25871 0.33333,-9 3.34434,-10.793121 19.61577,-2.093994 11.5,6.83333 -0.92279,1.01507 -2.54419,1.51106 -3.83333,1.83334 C 223.43948,110.30679 220.61993,110 218,110 M 41,110 36.833332,147 30,159 24,143 27,110 h 14 m 46,0 3,33 -6,15 h -2 c -5.366936,-8.49765 -6.053299,-17.26251 -7,-27 -0.672195,-6.91406 -2,-14.04004 -2,-21 h 14 m 106,0 v 12 h 9 v -12 h -9 m -75,42 -5,13 H 91 L 96.333336,151.5 104,151.66666 Z"
       id="path1" />
  </g>
</svg>

                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about-me/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About Me</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://sixiyida.github.io/" selected>English</option>
                                
                                    <option value="https://sixiyida.github.io/zh-cn/" >ä¸­æ–‡</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#ç›®å½•">ç›®å½•</a></li>
    <li><a href="#1-å¼•è¨€ä¸æ¦‚è¿°">1. å¼•è¨€ä¸æ¦‚è¿°</a>
      <ol>
        <li><a href="#11-spring-ai-alibaba-graph-æ¦‚è¿°">1.1 Spring AI Alibaba Graph æ¦‚è¿°</a></li>
        <li><a href="#12-æ ¸å¿ƒç‰¹æ€§ä¸ä¼˜åŠ¿">1.2 æ ¸å¿ƒç‰¹æ€§ä¸ä¼˜åŠ¿</a>
          <ol>
            <li><a href="#javaç”Ÿæ€æ·±åº¦é›†æˆ">Javaç”Ÿæ€æ·±åº¦é›†æˆ</a></li>
            <li><a href="#ä¸°å¯Œçš„é¢„ç½®ç»„ä»¶">ä¸°å¯Œçš„é¢„ç½®ç»„ä»¶</a></li>
            <li><a href="#å£°æ˜å¼apiè®¾è®¡">å£°æ˜å¼APIè®¾è®¡</a></li>
            <li><a href="#ç”Ÿäº§çº§ç‰¹æ€§">ç”Ÿäº§çº§ç‰¹æ€§</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#å¿«é€Ÿå¼€å§‹å®¢æˆ·è¯„ä»·åˆ†ç±»ç³»ç»Ÿ">å¿«é€Ÿå¼€å§‹ï¼šå®¢æˆ·è¯„ä»·åˆ†ç±»ç³»ç»Ÿ</a>
      <ol>
        <li><a href="#ç³»ç»Ÿæ¶æ„">ç³»ç»Ÿæ¶æ„</a></li>
        <li><a href="#æ ¸å¿ƒä»£ç å®ç°">æ ¸å¿ƒä»£ç å®ç°</a></li>
      </ol>
    </li>
    <li><a href="#2-æ ¸å¿ƒæ¶æ„ä¸è®¾è®¡ç†å¿µ">2. æ ¸å¿ƒæ¶æ„ä¸è®¾è®¡ç†å¿µ</a>
      <ol>
        <li><a href="#21-æ•´ä½“æ•°æ®æµè½¬æ¶æ„">2.1 æ•´ä½“æ•°æ®æµè½¬æ¶æ„</a>
          <ol>
            <li><a href="#211-å®Œæ•´æ•°æ®æµè½¬å›¾">2.1.1 å®Œæ•´æ•°æ®æµè½¬å›¾</a></li>
            <li><a href="#212-æ ¸å¿ƒæ‰§è¡Œæµç¨‹è¯¦è§£">2.1.2 æ ¸å¿ƒæ‰§è¡Œæµç¨‹è¯¦è§£</a></li>
            <li><a href="#213-å…³é”®æ•°æ®ç»“æ„æµè½¬">2.1.3 å…³é”®æ•°æ®ç»“æ„æµè½¬</a></li>
          </ol>
        </li>
        <li><a href="#22-æ•´ä½“æ¶æ„è®¾è®¡">2.2 æ•´ä½“æ¶æ„è®¾è®¡</a>
          <ol>
            <li><a href="#221-ç³»ç»Ÿæ¶æ„æ€»è§ˆ">2.2.1 ç³»ç»Ÿæ¶æ„æ€»è§ˆ</a></li>
            <li><a href="#222-stategraphæ„å»ºæµç¨‹">2.2.2 StateGraphæ„å»ºæµç¨‹</a></li>
            <li><a href="#223-compiledgraphæ‰§è¡Œæµç¨‹">2.2.3 CompiledGraphæ‰§è¡Œæµç¨‹</a></li>
          </ol>
        </li>
        <li><a href="#23-æ ¸å¿ƒç»„ä»¶å…³ç³»å›¾">2.3 æ ¸å¿ƒç»„ä»¶å…³ç³»å›¾</a></li>
        <li><a href="#24-æ ¸å¿ƒè®¾è®¡ç†å¿µ">2.4 æ ¸å¿ƒè®¾è®¡ç†å¿µ</a>
          <ol>
            <li><a href="#241-å£°æ˜å¼ç¼–ç¨‹æ¨¡å‹">2.4.1 å£°æ˜å¼ç¼–ç¨‹æ¨¡å‹</a></li>
            <li><a href="#242-çŠ¶æ€é©±åŠ¨çš„æ‰§è¡Œæ¨¡å‹">2.4.2 çŠ¶æ€é©±åŠ¨çš„æ‰§è¡Œæ¨¡å‹</a></li>
            <li><a href="#243-å¼‚æ­¥ä¼˜å…ˆçš„è®¾è®¡">2.4.3 å¼‚æ­¥ä¼˜å…ˆçš„è®¾è®¡</a></li>
          </ol>
        </li>
        <li><a href="#25-springç”Ÿæ€é›†æˆ">2.5 Springç”Ÿæ€é›†æˆ</a>
          <ol>
            <li><a href="#251-ä¾èµ–æ³¨å…¥æ¶æ„">2.5.1 ä¾èµ–æ³¨å…¥æ¶æ„</a></li>
            <li><a href="#252-ä¾èµ–æ³¨å…¥æ”¯æŒ">2.5.2 ä¾èµ–æ³¨å…¥æ”¯æŒ</a></li>
            <li><a href="#253-è§‚æµ‹æ€§é›†æˆ">2.5.3 è§‚æµ‹æ€§é›†æˆ</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#3-æ ¸å¿ƒæ¦‚å¿µæ·±åº¦è§£æ">3. æ ¸å¿ƒæ¦‚å¿µæ·±åº¦è§£æ</a>
      <ol>
        <li><a href="#31-stategraph-çŠ¶æ€å›¾">3.1 StateGraph (çŠ¶æ€å›¾)</a>
          <ol>
            <li><a href="#311-stategraphç”Ÿå‘½å‘¨æœŸ">3.1.1 StateGraphç”Ÿå‘½å‘¨æœŸ</a></li>
            <li><a href="#312-åŸºæœ¬æ„é€ ">3.1.2 åŸºæœ¬æ„é€ </a></li>
            <li><a href="#313-èŠ‚ç‚¹ç®¡ç†æµç¨‹">3.1.3 èŠ‚ç‚¹ç®¡ç†æµç¨‹</a></li>
            <li><a href="#314-è¾¹ç®¡ç†æµç¨‹">3.1.4 è¾¹ç®¡ç†æµç¨‹</a></li>
            <li><a href="#315-å›¾éªŒè¯æœºåˆ¶">3.1.5 å›¾éªŒè¯æœºåˆ¶</a></li>
          </ol>
        </li>
        <li><a href="#32-overallstate-å…¨å±€çŠ¶æ€">3.2 OverAllState (å…¨å±€çŠ¶æ€)</a>
          <ol>
            <li><a href="#321-çŠ¶æ€ç®¡ç†æ¶æ„">3.2.1 çŠ¶æ€ç®¡ç†æ¶æ„</a></li>
            <li><a href="#322-çŠ¶æ€æ›´æ–°æµç¨‹">3.2.2 çŠ¶æ€æ›´æ–°æµç¨‹</a></li>
            <li><a href="#323-çŠ¶æ€ç­–ç•¥è¯¦è§£">3.2.3 çŠ¶æ€ç­–ç•¥è¯¦è§£</a></li>
          </ol>
        </li>
        <li><a href="#33-node-èŠ‚ç‚¹">3.3 Node (èŠ‚ç‚¹)</a>
          <ol>
            <li><a href="#331-èŠ‚ç‚¹æ‰§è¡Œæµç¨‹">3.3.1 èŠ‚ç‚¹æ‰§è¡Œæµç¨‹</a></li>
            <li><a href="#332-èŠ‚ç‚¹ç±»å‹å±‚æ¬¡ç»“æ„">3.3.2 èŠ‚ç‚¹ç±»å‹å±‚æ¬¡ç»“æ„</a></li>
            <li><a href="#333-å¹¶è¡ŒèŠ‚ç‚¹å¤„ç†æœºåˆ¶">3.3.3 å¹¶è¡ŒèŠ‚ç‚¹å¤„ç†æœºåˆ¶</a></li>
          </ol>
        </li>
        <li><a href="#34-edge-è¾¹">3.4 Edge (è¾¹)</a>
          <ol>
            <li><a href="#341-è¾¹çš„ç±»å‹ä¸ç»“æ„">3.4.1 è¾¹çš„ç±»å‹ä¸ç»“æ„</a></li>
            <li><a href="#342-æ¡ä»¶è¾¹è·¯ç”±æµç¨‹">3.4.2 æ¡ä»¶è¾¹è·¯ç”±æµç¨‹</a></li>
            <li><a href="#343-è¾¹éªŒè¯æœºåˆ¶">3.4.3 è¾¹éªŒè¯æœºåˆ¶</a></li>
          </ol>
        </li>
        <li><a href="#35-compiledgraph-ç¼–è¯‘å›¾">3.5 CompiledGraph (ç¼–è¯‘å›¾)</a>
          <ol>
            <li><a href="#351-ç¼–è¯‘è¿‡ç¨‹è¯¦è§£">3.5.1 ç¼–è¯‘è¿‡ç¨‹è¯¦è§£</a></li>
            <li><a href="#352-asyncnodegeneratoræ‰§è¡Œæœºåˆ¶">3.5.2 AsyncNodeGeneratoræ‰§è¡Œæœºåˆ¶</a></li>
            <li><a href="#353-çŠ¶æ€æµè½¬æ ¸å¿ƒé€»è¾‘">3.5.3 çŠ¶æ€æµè½¬æ ¸å¿ƒé€»è¾‘</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#4-é¢„å®šä¹‰ç»„ä»¶ä¸å·¥å…·ç®±">4. é¢„å®šä¹‰ç»„ä»¶ä¸å·¥å…·ç®±</a>
      <ol>
        <li><a href="#41-é¢„å®šä¹‰èŠ‚ç‚¹ç±»å‹">4.1 é¢„å®šä¹‰èŠ‚ç‚¹ç±»å‹</a>
          <ol>
            <li><a href="#411-èŠ‚ç‚¹åˆ†ç±»æ¶æ„">4.1.1 èŠ‚ç‚¹åˆ†ç±»æ¶æ„</a></li>
            <li><a href="#412-questionclassifiernode---æ™ºèƒ½åˆ†ç±»èŠ‚ç‚¹">4.1.2 QuestionClassifierNode - æ™ºèƒ½åˆ†ç±»èŠ‚ç‚¹</a></li>
            <li><a href="#413-llmnode---å¤§æ¨¡å‹è°ƒç”¨èŠ‚ç‚¹">4.1.3 LlmNode - å¤§æ¨¡å‹è°ƒç”¨èŠ‚ç‚¹</a></li>
            <li><a href="#414-toolnode---å·¥å…·è°ƒç”¨èŠ‚ç‚¹">4.1.4 ToolNode - å·¥å…·è°ƒç”¨èŠ‚ç‚¹</a></li>
            <li><a href="#415-knowledgeretrievalnode---çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹">4.1.5 KnowledgeRetrievalNode - çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹</a></li>
          </ol>
        </li>
        <li><a href="#42-é¢„å®šä¹‰agentç±»å‹">4.2 é¢„å®šä¹‰Agentç±»å‹</a>
          <ol>
            <li><a href="#421-reactagent---ååº”å¼agent">4.2.1 ReactAgent - ååº”å¼Agent</a></li>
            <li><a href="#422-reflectagent---åæ€agent">4.2.2 ReflectAgent - åæ€Agent</a></li>
            <li><a href="#423-reactagentwithhuman---äººæœºåä½œagent">4.2.3 ReactAgentWithHuman - äººæœºåä½œAgent</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#5-é«˜çº§ç‰¹æ€§ä¸æ‰©å±•èƒ½åŠ›">5. é«˜çº§ç‰¹æ€§ä¸æ‰©å±•èƒ½åŠ›</a>
      <ol>
        <li><a href="#51-å¯è§‚æµ‹æ€§">5.1 å¯è§‚æµ‹æ€§</a>
          <ol>
            <li><a href="#511-æ ¸å¿ƒç‰¹æ€§">5.1.1 æ ¸å¿ƒç‰¹æ€§</a></li>
            <li><a href="#512-å¿«é€Ÿæ¥å…¥">5.1.2 å¿«é€Ÿæ¥å…¥</a></li>
            <li><a href="#513-è¯¦ç»†æ–‡æ¡£">5.1.3 è¯¦ç»†æ–‡æ¡£</a></li>
          </ol>
        </li>
        <li><a href="#52-å¹¶è¡ŒèŠ‚ç‚¹ä¸æµå¼å¤„ç†">5.2 å¹¶è¡ŒèŠ‚ç‚¹ä¸æµå¼å¤„ç†</a>
          <ol>
            <li><a href="#521-å¹¶è¡ŒèŠ‚ç‚¹çš„ä¸¤ç§åˆ›å»ºæ–¹å¼">5.2.1 å¹¶è¡ŒèŠ‚ç‚¹çš„ä¸¤ç§åˆ›å»ºæ–¹å¼</a></li>
            <li><a href="#522-å¹¶è¡ŒèŠ‚ç‚¹çš„å†…éƒ¨æ‰§è¡Œæœºåˆ¶">5.2.2 å¹¶è¡ŒèŠ‚ç‚¹çš„å†…éƒ¨æ‰§è¡Œæœºåˆ¶</a></li>
            <li><a href="#523-å¹¶è¡Œæµå¼å¤„ç†çš„åˆå¹¶æœºåˆ¶">5.2.3 å¹¶è¡Œæµå¼å¤„ç†çš„åˆå¹¶æœºåˆ¶</a></li>
            <li><a href="#524-mergedgeneratoræ ¸å¿ƒå®ç°">5.2.4 MergedGeneratoræ ¸å¿ƒå®ç°</a></li>
            <li><a href="#525-æµå¼è¾“å‡ºé…ç½®">5.2.5 æµå¼è¾“å‡ºé…ç½®</a></li>
          </ol>
        </li>
        <li><a href="#53-å­å›¾èŠ‚ç‚¹">5.3 å­å›¾èŠ‚ç‚¹</a>
          <ol>
            <li><a href="#531-å­å›¾èŠ‚ç‚¹ç±»å‹">5.3.1 å­å›¾èŠ‚ç‚¹ç±»å‹</a></li>
            <li><a href="#532-å­å›¾å®šä¹‰ä¸ä½¿ç”¨">5.3.2 å­å›¾å®šä¹‰ä¸ä½¿ç”¨</a></li>
            <li><a href="#533-å­å›¾æ‰§è¡Œæµç¨‹">5.3.3 å­å›¾æ‰§è¡Œæµç¨‹</a></li>
            <li><a href="#534-å­å›¾çŠ¶æ€ç®¡ç†">5.3.4 å­å›¾çŠ¶æ€ç®¡ç†</a></li>
          </ol>
        </li>
        <li><a href="#54-ä¸­æ–­ä¸æ¢å¤æœºåˆ¶">5.4 ä¸­æ–­ä¸æ¢å¤æœºåˆ¶</a>
          <ol>
            <li><a href="#541-ä¸­æ–­æœºåˆ¶åŸç†">5.4.1 ä¸­æ–­æœºåˆ¶åŸç†</a></li>
            <li><a href="#542-ä¸­æ–­æ¡ä»¶é…ç½®">5.4.2 ä¸­æ–­æ¡ä»¶é…ç½®</a></li>
            <li><a href="#543-çŠ¶æ€å¿«ç…§ç®¡ç†">5.4.3 çŠ¶æ€å¿«ç…§ç®¡ç†</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#6-å¿«é€Ÿå¼€å§‹ä¸å®æˆ˜æŒ‡å—">6. å¿«é€Ÿå¼€å§‹ä¸å®æˆ˜æŒ‡å—</a>
      <ol>
        <li><a href="#61-ç¯å¢ƒå‡†å¤‡">6.1 ç¯å¢ƒå‡†å¤‡</a>
          <ol>
            <li><a href="#611-ä¾èµ–é…ç½®">6.1.1 ä¾èµ–é…ç½®</a></li>
          </ol>
        </li>
        <li><a href="#62-å¿«é€Ÿå¼€å§‹æµç¨‹">6.2 å¿«é€Ÿå¼€å§‹æµç¨‹</a>
          <ol>
            <li><a href="#621-åˆ›å»ºç¬¬ä¸€ä¸ªå·¥ä½œæµ">6.2.1 åˆ›å»ºç¬¬ä¸€ä¸ªå·¥ä½œæµ</a></li>
            <li><a href="#622-ä½¿ç”¨å·¥ä½œæµ">6.2.2 ä½¿ç”¨å·¥ä½œæµ</a></li>
          </ol>
        </li>
        <li><a href="#63-å®Œæ•´ç¤ºä¾‹é¡¹ç›®">6.3 å®Œæ•´ç¤ºä¾‹é¡¹ç›®</a></li>
        <li><a href="#64-ç¤¾åŒºæ”¯æŒ">6.4 ç¤¾åŒºæ”¯æŒ</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/programing/" >
                Programing
            </a>
        
            <a href="/categories/agent-development/" >
                Agent Development
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/spring-ai-alibaba-graph-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">Spring AI Alibaba Graph ä½¿ç”¨æŒ‡å—ä¸æºç è§£è¯»</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Guide and Code Explanation for SAA Graph
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jul 15, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    36 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="spring-ai-alibaba-graph-ä½¿ç”¨æŒ‡å—ä¸æºç è§£è¯»">Spring AI Alibaba Graph ä½¿ç”¨æŒ‡å—ä¸æºç è§£è¯»
</h1><blockquote>
<p>æ·±å…¥ç†è§£Spring AI Alibaba Graphçš„è®¾è®¡æ€è·¯ã€æ ¸å¿ƒèƒ½åŠ›ä¸æœ€ä½³å®è·µ</p></blockquote>
<h2 id="ç›®å½•">ç›®å½•
</h2><ul>
<li><a class="link" href="#1-%e5%bc%95%e8%a8%80%e4%b8%8e%e6%a6%82%e8%bf%b0" >1. å¼•è¨€ä¸æ¦‚è¿°</a></li>
<li><a class="link" href="#2-%e6%a0%b8%e5%bf%83%e6%9e%b6%e6%9e%84%e4%b8%8e%e8%ae%be%e8%ae%a1%e7%90%86%e5%bf%b5" >2. æ ¸å¿ƒæ¶æ„ä¸è®¾è®¡ç†å¿µ</a></li>
<li><a class="link" href="#3-%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" >3. æ ¸å¿ƒæ¦‚å¿µæ·±åº¦è§£æ</a></li>
<li><a class="link" href="#4-%e9%a2%84%e5%ae%9a%e4%b9%89%e7%bb%84%e4%bb%b6%e4%b8%8e%e5%b7%a5%e5%85%b7%e7%ae%b1" >4. é¢„å®šä¹‰ç»„ä»¶ä¸å·¥å…·ç®±</a></li>
<li><a class="link" href="#5-%e9%ab%98%e7%ba%a7%e7%89%b9%e6%80%a7%e4%b8%8e%e6%89%a9%e5%b1%95%e8%83%bd%e5%8a%9b" >5. é«˜çº§ç‰¹æ€§ä¸æ‰©å±•èƒ½åŠ›</a></li>
<li><a class="link" href="#6-%e5%bf%ab%e9%80%9f%e5%bc%80%e5%a7%8b%e4%b8%8e%e5%ae%9e%e6%88%98%e6%8c%87%e5%8d%97" >6. å¿«é€Ÿå¼€å§‹ä¸å®æˆ˜æŒ‡å—</a></li>
</ul>
<hr>
<h2 id="1-å¼•è¨€ä¸æ¦‚è¿°">1. å¼•è¨€ä¸æ¦‚è¿°
</h2><h3 id="11-spring-ai-alibaba-graph-æ¦‚è¿°">1.1 Spring AI Alibaba Graph æ¦‚è¿°
</h3><p>Spring AI Alibaba Graph æ˜¯ç¤¾åŒºæ ¸å¿ƒå®ç°ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯æ•´ä¸ªæ¡†æ¶åœ¨è®¾è®¡ç†å¿µä¸ŠåŒºåˆ«äº Spring AI åªåšåº•å±‚åŸå­æŠ½è±¡çš„åœ°æ–¹ï¼ŒSpring AI Alibaba æœŸæœ›å¸®åŠ©å¼€å‘è€…æ›´å®¹æ˜“çš„æ„å»ºæ™ºèƒ½ä½“åº”ç”¨ã€‚åŸºäº Graph å¼€å‘è€…å¯ä»¥æ„å»ºå·¥ä½œæµã€å¤šæ™ºèƒ½ä½“åº”ç”¨ã€‚</p>
<p>Spring AI Alibaba Graph åœ¨è®¾è®¡ç†å¿µä¸Šå€Ÿé‰´ LangGraphï¼Œå› æ­¤åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥ç†è§£ä¸ºæ˜¯ Java ç‰ˆçš„ LangGraph å®ç°ï¼Œç¤¾åŒºåœ¨æ­¤åŸºç¡€ä¸Šå¢åŠ äº†å¤§é‡é¢„ç½® Nodeã€ç®€åŒ–äº† State å®šä¹‰è¿‡ç¨‹ç­‰ï¼Œè®©å¼€å‘è€…æ›´å®¹æ˜“ç¼–å†™å¯¹ç­‰ä½ä»£ç å¹³å°çš„å·¥ä½œæµã€å¤šæ™ºèƒ½ä½“ç­‰ã€‚</p>
<h3 id="12-æ ¸å¿ƒç‰¹æ€§ä¸ä¼˜åŠ¿">1.2 æ ¸å¿ƒç‰¹æ€§ä¸ä¼˜åŠ¿
</h3><p>ç›¸æ¯”ä¼ ç»Ÿçš„AIåº”ç”¨å¼€å‘æ–¹å¼ï¼ŒSpring AI Alibaba Graphå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒä¼˜åŠ¿ï¼š</p>
<h4 id="javaç”Ÿæ€æ·±åº¦é›†æˆ">Javaç”Ÿæ€æ·±åº¦é›†æˆ
</h4><ul>
<li><strong>SpringåŸç”Ÿæ”¯æŒ</strong>ï¼šå®Œæ•´çš„ä¾èµ–æ³¨å…¥ã€é…ç½®ç®¡ç†ã€ç›‘æ§è§‚æµ‹</li>
<li><strong>é«˜å¹¶å‘å¤„ç†</strong>ï¼šJavaå¤©ç„¶çš„å¤šçº¿ç¨‹ä¼˜åŠ¿ï¼Œæ”¯æŒé«˜å¹¶å‘åœºæ™¯</li>
</ul>
<h4 id="ä¸°å¯Œçš„é¢„ç½®ç»„ä»¶">ä¸°å¯Œçš„é¢„ç½®ç»„ä»¶
</h4><ul>
<li><strong>15+ é¢„å®šä¹‰èŠ‚ç‚¹ç±»å‹</strong>ï¼šQuestionClassifierNodeã€LlmNodeã€ToolNodeã€KnowledgeRetrievalNodeç­‰</li>
<li><strong>å¤šç§Agentæ¨¡å¼</strong>ï¼šå†…ç½®Reactã€Reflectionã€Supervisorç­‰æ™ºèƒ½ä½“æ¨¡å¼</li>
<li><strong>ç®€åŒ–çš„Stateç®¡ç†</strong>ï¼šç»Ÿä¸€çš„çŠ¶æ€å®šä¹‰å’Œåˆå¹¶ç­–ç•¥</li>
</ul>
<h4 id="å£°æ˜å¼apiè®¾è®¡">å£°æ˜å¼APIè®¾è®¡
</h4><ul>
<li><strong>ç±»ä¼¼LangGraphçš„API</strong>ï¼šJavaå¼€å‘è€…æ›´å®¹æ˜“ä¸Šæ‰‹</li>
<li><strong>é“¾å¼è°ƒç”¨</strong>ï¼šç®€æ´çš„æµå¼APIï¼Œä»£ç æ›´åŠ ä¼˜é›…</li>
<li><strong>æ¡ä»¶åˆ†æ”¯</strong>ï¼šæ”¯æŒå¤æ‚çš„æ¡ä»¶é€»è¾‘å’Œå¹¶è¡Œå¤„ç†</li>
</ul>
<h4 id="ç”Ÿäº§çº§ç‰¹æ€§">ç”Ÿäº§çº§ç‰¹æ€§
</h4><ul>
<li><strong>è§‚æµ‹æ€§æ”¯æŒ</strong>ï¼šå®Œæ•´çš„æŒ‡æ ‡æ”¶é›†ã€é“¾è·¯è¿½è¸ª</li>
<li><strong>å®¹é”™æœºåˆ¶</strong>ï¼šæ”¯æŒæ£€æŸ¥ç‚¹ã€çŠ¶æ€æ¢å¤ã€é”™è¯¯å¤„ç†</li>
<li><strong>äººæœºåä½œ</strong>ï¼šHuman-in-the-loopæ”¯æŒï¼Œæ”¯æŒä¿®æ”¹çŠ¶æ€ã€æ¢å¤æ‰§è¡Œ</li>
</ul>
<h2 id="å¿«é€Ÿå¼€å§‹å®¢æˆ·è¯„ä»·åˆ†ç±»ç³»ç»Ÿ">å¿«é€Ÿå¼€å§‹ï¼šå®¢æˆ·è¯„ä»·åˆ†ç±»ç³»ç»Ÿ
</h2><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå…·ä½“ç¤ºä¾‹äº†è§£Spring AI Alibaba Graphçš„ä½¿ç”¨æ–¹å¼ã€‚è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•æ„å»ºä¸€ä¸ªå®¢æˆ·è¯„ä»·åˆ†ç±»ç³»ç»Ÿï¼š</p>
<h3 id="ç³»ç»Ÿæ¶æ„">ç³»ç»Ÿæ¶æ„
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">graph TD
</span></span><span class="line"><span class="cl">    A[ç”¨æˆ·è¾“å…¥] --&gt; B[è¯„ä»·åˆ†ç±»å™¨]
</span></span><span class="line"><span class="cl">    B --&gt; C{æ­£é¢/è´Ÿé¢?}
</span></span><span class="line"><span class="cl">    C --&gt;|æ­£é¢| D[è®°å½•å¥½è¯„]
</span></span><span class="line"><span class="cl">    C --&gt;|è´Ÿé¢| E[é—®é¢˜ç»†åˆ†å™¨]
</span></span><span class="line"><span class="cl">    E --&gt; F[é—®é¢˜å¤„ç†å™¨]
</span></span><span class="line"><span class="cl">    D --&gt; G[ç»“æŸ]
</span></span><span class="line"><span class="cl">    F --&gt; G
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ ¸å¿ƒä»£ç å®ç°">æ ¸å¿ƒä»£ç å®ç°
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CustomerServiceWorkflow</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="nf">customerServiceGraph</span><span class="p">(</span><span class="n">ChatModel</span><span class="w"> </span><span class="n">chatModel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ChatClient</span><span class="w"> </span><span class="n">chatClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChatClient</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="n">chatModel</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">defaultAdvisors</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SimpleLoggerAdvisor</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è¯„ä»·åˆ†ç±»å™¨ - åŒºåˆ†æ­£é¢/è´Ÿé¢è¯„ä»·</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">QuestionClassifierNode</span><span class="w"> </span><span class="n">feedbackClassifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QuestionClassifierNode</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">chatClient</span><span class="p">(</span><span class="n">chatClient</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">inputTextKey</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">outputKey</span><span class="p">(</span><span class="s">&#34;classifier_output&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">categories</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;positive feedback&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;negative feedback&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// é—®é¢˜ç»†åˆ†å™¨ - å¯¹è´Ÿé¢è¯„ä»·è¿›è¡Œç»†åˆ†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">QuestionClassifierNode</span><span class="w"> </span><span class="n">specificQuestionClassifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QuestionClassifierNode</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">chatClient</span><span class="p">(</span><span class="n">chatClient</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">inputTextKey</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">outputKey</span><span class="p">(</span><span class="s">&#34;classifier_output&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">categories</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;after-sale service&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;transportation&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;product quality&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;others&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// çŠ¶æ€å·¥å‚å®šä¹‰ - ç®€åŒ–çš„çŠ¶æ€ç®¡ç†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">KeyStrategyFactory</span><span class="w"> </span><span class="n">stateFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">strategies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;classifier_output&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;solution&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">strategies</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æ„å»ºå·¥ä½œæµ - å£°æ˜å¼API</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StateGraph</span><span class="p">(</span><span class="s">&#34;å®¢æˆ·æœåŠ¡è¯„ä»·å¤„ç†&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">stateFactory</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;feedback_classifier&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">feedbackClassifier</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;specific_question_classifier&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">specificQuestionClassifier</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;recorder&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">RecordingNode</span><span class="p">()))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;feedback_classifier&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addConditionalEdges</span><span class="p">(</span><span class="s">&#34;feedback_classifier&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">edge_async</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">FeedbackQuestionDispatcher</span><span class="p">()),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;positive&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;recorder&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;negative&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;specific_question_classifier&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;recorder&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥ä¸Šä»£ç åªå±•ç¤ºäº†å›¾ç»“æ„ï¼ˆStateGraphï¼‰çš„æ„å»ºï¼Œå…·ä½“çš„ä»£ç å®ç°æ‚¨å¯ä»¥å…³æ³¨<strong>spring-ai-alibaba-example</strong>ä»“åº“ï¼š<a class="link" href="https://github.com/springaialibaba/spring-ai-alibaba-examples/tree/main/spring-ai-alibaba-graph-example"  target="_blank" rel="noopener"
    >spring-ai-alibaba-example</a></p>
<p>è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†Spring AI Alibaba Graphçš„æ ¸å¿ƒç‰¹æ€§ï¼š</p>
<ul>
<li><strong>é¢„ç½®ç»„ä»¶</strong>ï¼šä½¿ç”¨QuestionClassifierNodeå¿«é€Ÿå®ç°åˆ†ç±»åŠŸèƒ½</li>
<li><strong>ç®€åŒ–çŠ¶æ€ç®¡ç†</strong>ï¼šé€šè¿‡KeyStrategyFactoryç»Ÿä¸€ç®¡ç†çŠ¶æ€</li>
<li><strong>å£°æ˜å¼API</strong>ï¼šé“¾å¼è°ƒç”¨æ„å»ºå¤æ‚å·¥ä½œæµ</li>
<li><strong>Spring Booté›†æˆ</strong>ï¼šé€šè¿‡@Configurationå’Œ@Beanå®Œæˆä¾èµ–æ³¨å…¥</li>
</ul>
<h2 id="2-æ ¸å¿ƒæ¶æ„ä¸è®¾è®¡ç†å¿µ">2. æ ¸å¿ƒæ¶æ„ä¸è®¾è®¡ç†å¿µ
</h2><h3 id="21-æ•´ä½“æ•°æ®æµè½¬æ¶æ„">2.1 æ•´ä½“æ•°æ®æµè½¬æ¶æ„
</h3><p>Spring AI Alibaba Graphé‡‡ç”¨å·¥ä½œæµæ¨¡å‹ï¼Œæ•´ä¸ªæ¡†æ¶çš„æ•°æ®æµè½¬éµå¾ª**&ldquo;æ„å»ºâ†’ç¼–è¯‘â†’æ‰§è¡Œ&rdquo;**çš„ä¸‰é˜¶æ®µæ¨¡å¼ï¼š</p>
<h4 id="211-å®Œæ•´æ•°æ®æµè½¬å›¾">2.1.1 å®Œæ•´æ•°æ®æµè½¬å›¾
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart TD
</span></span><span class="line"><span class="cl">    subgraph &#34;é˜¶æ®µ1: æ„å»ºé˜¶æ®µ&#34;
</span></span><span class="line"><span class="cl">        A[å¼€å‘è€…å®šä¹‰StateGraph] --&gt; B[æ·»åŠ èŠ‚ç‚¹ addNode]
</span></span><span class="line"><span class="cl">        B --&gt; C[æ·»åŠ è¾¹ addEdge/addConditionalEdges]
</span></span><span class="line"><span class="cl">        C --&gt; D[å®šä¹‰çŠ¶æ€ç­–ç•¥ KeyStrategyFactory]
</span></span><span class="line"><span class="cl">        D --&gt; E[å›¾ç»“æ„éªŒè¯ validateGraph]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;é˜¶æ®µ2: ç¼–è¯‘é˜¶æ®µ&#34;
</span></span><span class="line"><span class="cl">        E --&gt; F[StateGraph.compile]
</span></span><span class="line"><span class="cl">        F --&gt; G[å¤„ç†å­å›¾å±•å¼€]
</span></span><span class="line"><span class="cl">        G --&gt; H[æ£€æµ‹å¹¶è¡Œè¾¹æ¨¡å¼]
</span></span><span class="line"><span class="cl">        H --&gt; I[åˆ›å»ºParallelNode]
</span></span><span class="line"><span class="cl">        I --&gt; J[èŠ‚ç‚¹Actioné¢„å¤„ç†]
</span></span><span class="line"><span class="cl">        J --&gt; K[è¾¹è·¯ç”±ä¼˜åŒ–]
</span></span><span class="line"><span class="cl">        K --&gt; L[ç”ŸæˆCompiledGraph]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;é˜¶æ®µ3: æ‰§è¡Œé˜¶æ®µ&#34;
</span></span><span class="line"><span class="cl">        L --&gt; M{è°ƒç”¨æ–¹å¼}
</span></span><span class="line"><span class="cl">        M --&gt;|invoke| N[åŒæ­¥æ‰§è¡Œ]
</span></span><span class="line"><span class="cl">        M --&gt;|stream| O[æµå¼æ‰§è¡Œ]
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        N --&gt; P[åˆ›å»ºAsyncNodeGenerator]
</span></span><span class="line"><span class="cl">        O --&gt; P
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        P --&gt; Q[çŠ¶æ€æœºé©±åŠ¨æ‰§è¡Œ]
</span></span><span class="line"><span class="cl">        Q --&gt; R[èŠ‚ç‚¹è°ƒåº¦ä¸æ‰§è¡Œ]
</span></span><span class="line"><span class="cl">        R --&gt; S[çŠ¶æ€æ›´æ–°ä¸åˆå¹¶]
</span></span><span class="line"><span class="cl">        S --&gt; T[æ£€æŸ¥ç‚¹ä¿å­˜]
</span></span><span class="line"><span class="cl">        T --&gt; U[æ¡ä»¶åˆ¤æ–­ä¸è·¯ç”±]
</span></span><span class="line"><span class="cl">        U --&gt; V{æ˜¯å¦ç»“æŸ?}
</span></span><span class="line"><span class="cl">        V --&gt;|å¦| R
</span></span><span class="line"><span class="cl">        V --&gt;|æ˜¯| W[è¿”å›æœ€ç»ˆç»“æœ]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;æ•°æ®è½½ä½“&#34;
</span></span><span class="line"><span class="cl">        X[OverAllState&lt;br/&gt;å…¨å±€çŠ¶æ€ç®¡ç†]
</span></span><span class="line"><span class="cl">        Y[RunnableConfig&lt;br/&gt;æ‰§è¡Œé…ç½®]
</span></span><span class="line"><span class="cl">        Z[NodeOutput&lt;br/&gt;èŠ‚ç‚¹è¾“å‡º]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    R --&gt; X
</span></span><span class="line"><span class="cl">    X --&gt; S
</span></span><span class="line"><span class="cl">    Y --&gt; P
</span></span><span class="line"><span class="cl">    Z --&gt; W
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    style A fill:#e1f5fe
</span></span><span class="line"><span class="cl">    style L fill:#fff3e0
</span></span><span class="line"><span class="cl">    style W fill:#e8f5e8
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="212-æ ¸å¿ƒæ‰§è¡Œæµç¨‹è¯¦è§£">2.1.2 æ ¸å¿ƒæ‰§è¡Œæµç¨‹è¯¦è§£
</h4><p><strong>æ•°æ®æµè½¬çš„æ ¸å¿ƒç†å¿µ</strong>ï¼šæ•´ä¸ªæ¡†æ¶å›´ç»•<strong>OverAllState</strong>è¿™ä¸ªæ•°æ®è½½ä½“è¿›è¡Œæµè½¬ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯çŠ¶æ€çš„è½¬æ¢å™¨ï¼Œé€šè¿‡<strong>AsyncNodeGenerator</strong>è¿™ä¸ªçŠ¶æ€æœºæ¥é©±åŠ¨æ•´ä¸ªæµç¨‹çš„æ‰§è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sequenceDiagram
</span></span><span class="line"><span class="cl">    participant Dev as å¼€å‘è€…
</span></span><span class="line"><span class="cl">    participant SG as StateGraph
</span></span><span class="line"><span class="cl">    participant CG as CompiledGraph
</span></span><span class="line"><span class="cl">    participant ANG as AsyncNodeGenerator
</span></span><span class="line"><span class="cl">    participant Node as èŠ‚ç‚¹
</span></span><span class="line"><span class="cl">    participant State as OverAllState
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    Dev-&gt;&gt;SG: 1. æ„å»ºå›¾ç»“æ„
</span></span><span class="line"><span class="cl">    SG-&gt;&gt;SG: 2. éªŒè¯å›¾å®Œæ•´æ€§
</span></span><span class="line"><span class="cl">    SG-&gt;&gt;CG: 3. ç¼–è¯‘ä¼˜åŒ–
</span></span><span class="line"><span class="cl">    CG-&gt;&gt;CG: 4. å¤„ç†å­å›¾å’Œå¹¶è¡Œ
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    Dev-&gt;&gt;CG: 5. invoke/streamè°ƒç”¨
</span></span><span class="line"><span class="cl">    CG-&gt;&gt;State: 6. åˆå§‹åŒ–çŠ¶æ€
</span></span><span class="line"><span class="cl">    CG-&gt;&gt;ANG: 7. åˆ›å»ºæ‰§è¡Œå™¨
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    loop æ‰§è¡Œå¾ªç¯
</span></span><span class="line"><span class="cl">        ANG-&gt;&gt;ANG: 8. çŠ¶æ€æœºæ¨è¿›
</span></span><span class="line"><span class="cl">        ANG-&gt;&gt;Node: 9. è°ƒåº¦èŠ‚ç‚¹æ‰§è¡Œ
</span></span><span class="line"><span class="cl">        Node-&gt;&gt;Node: 10. ä¸šåŠ¡é€»è¾‘å¤„ç†
</span></span><span class="line"><span class="cl">        Node-&gt;&gt;State: 11. çŠ¶æ€æ›´æ–°
</span></span><span class="line"><span class="cl">        State-&gt;&gt;ANG: 12. çŠ¶æ€åˆå¹¶å®Œæˆ
</span></span><span class="line"><span class="cl">        ANG-&gt;&gt;ANG: 13. è·¯ç”±ä¸‹ä¸€èŠ‚ç‚¹
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    ANG-&gt;&gt;CG: 14. è¿”å›æœ€ç»ˆç»“æœ
</span></span><span class="line"><span class="cl">    CG-&gt;&gt;Dev: 15. å®Œæˆæ‰§è¡Œ
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="213-å…³é”®æ•°æ®ç»“æ„æµè½¬">2.1.3 å…³é”®æ•°æ®ç»“æ„æµè½¬
</h4><p><strong>StateGraph â†’ CompiledGraphè½¬æ¢</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">graph LR
</span></span><span class="line"><span class="cl">    subgraph &#34;StateGraph (é™æ€å®šä¹‰)&#34;
</span></span><span class="line"><span class="cl">        A[èŠ‚ç‚¹å®šä¹‰&lt;br/&gt;Map&amp;lt;String, Node&amp;gt;]
</span></span><span class="line"><span class="cl">        B[è¾¹å®šä¹‰&lt;br/&gt;Map&amp;lt;String, Edge&amp;gt;]
</span></span><span class="line"><span class="cl">        C[çŠ¶æ€ç­–ç•¥&lt;br/&gt;KeyStrategyFactory]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;ç¼–è¯‘å¤„ç†&#34;
</span></span><span class="line"><span class="cl">        D[èŠ‚ç‚¹é¢„å¤„ç†&lt;br/&gt;ActionFactory.apply]
</span></span><span class="line"><span class="cl">        E[è¾¹è·¯ç”±ä¼˜åŒ–&lt;br/&gt;EdgeValueå¤„ç†]
</span></span><span class="line"><span class="cl">        F[å¹¶è¡Œæ£€æµ‹&lt;br/&gt;ParallelNodeåˆ›å»º]
</span></span><span class="line"><span class="cl">        G[å­å›¾å±•å¼€&lt;br/&gt;SubGraphå¤„ç†]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;CompiledGraph (å¯æ‰§è¡Œ)&#34;
</span></span><span class="line"><span class="cl">        H[æ‰§è¡ŒèŠ‚ç‚¹&lt;br/&gt;Map&amp;lt;String, AsyncNodeActionWithConfig&amp;gt;]
</span></span><span class="line"><span class="cl">        I[è·¯ç”±æ˜ å°„&lt;br/&gt;Map&amp;lt;String, EdgeValue&amp;gt;]
</span></span><span class="line"><span class="cl">        J[é…ç½®ä¿¡æ¯&lt;br/&gt;CompileConfig]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    A --&gt; D
</span></span><span class="line"><span class="cl">    B --&gt; E
</span></span><span class="line"><span class="cl">    C --&gt; F
</span></span><span class="line"><span class="cl">    D --&gt; H
</span></span><span class="line"><span class="cl">    E --&gt; I
</span></span><span class="line"><span class="cl">    F --&gt; G
</span></span><span class="line"><span class="cl">    G --&gt; J
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>AsyncNodeGeneratoræ‰§è¡Œæœºåˆ¶</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">stateDiagram-v2
</span></span><span class="line"><span class="cl">    [*] --&gt; Initialize: åˆ›å»ºæ‰§è¡Œå™¨
</span></span><span class="line"><span class="cl">    Initialize --&gt; CheckResume: æ£€æŸ¥æ¢å¤æ¨¡å¼
</span></span><span class="line"><span class="cl">    CheckResume --&gt; LoadSnapshot: æ¢å¤æ¨¡å¼
</span></span><span class="line"><span class="cl">    CheckResume --&gt; StartExecution: æ­£å¸¸å¯åŠ¨
</span></span><span class="line"><span class="cl">    LoadSnapshot --&gt; StartExecution: åŠ è½½å®Œæˆ
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    StartExecution --&gt; ExecuteNode: æ‰§è¡Œå½“å‰èŠ‚ç‚¹
</span></span><span class="line"><span class="cl">    ExecuteNode --&gt; UpdateState: æ›´æ–°çŠ¶æ€
</span></span><span class="line"><span class="cl">    UpdateState --&gt; SaveCheckpoint: ä¿å­˜æ£€æŸ¥ç‚¹
</span></span><span class="line"><span class="cl">    SaveCheckpoint --&gt; RouteNext: è·¯ç”±ä¸‹ä¸€èŠ‚ç‚¹
</span></span><span class="line"><span class="cl">    RouteNext --&gt; CheckEnd: æ£€æŸ¥ç»“æŸæ¡ä»¶
</span></span><span class="line"><span class="cl">    CheckEnd --&gt; ExecuteNode: ç»§ç»­æ‰§è¡Œ
</span></span><span class="line"><span class="cl">    CheckEnd --&gt; [*]: æ‰§è¡Œå®Œæˆ
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    ExecuteNode --&gt; CheckInterrupt: æ£€æŸ¥ä¸­æ–­
</span></span><span class="line"><span class="cl">    CheckInterrupt --&gt; Interrupt: ä¸­æ–­æ‰§è¡Œ
</span></span><span class="line"><span class="cl">    Interrupt --&gt; [*]: ç­‰å¾…æ¢å¤
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-æ•´ä½“æ¶æ„è®¾è®¡">2.2 æ•´ä½“æ¶æ„è®¾è®¡
</h3><p>åŸºäºä¸Šè¿°æ•°æ®æµè½¬æœºåˆ¶ï¼ŒSpring AI Alibaba Graphçš„æ•´ä½“æ¶æ„è®¾è®¡å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li><strong>æ¸…æ™°çš„æ‰§è¡Œæµç¨‹</strong>ï¼šæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªå¤„ç†æ­¥éª¤ï¼Œè¾¹è¡¨ç¤ºæ•°æ®æµå‘</li>
<li><strong>çµæ´»çš„æ¡ä»¶åˆ†æ”¯</strong>ï¼šæ”¯æŒæ ¹æ®çŠ¶æ€åŠ¨æ€é€‰æ‹©æ‰§è¡Œè·¯å¾„</li>
<li><strong>å¹¶è¡Œå¤„ç†èƒ½åŠ›</strong>ï¼šå¤šä¸ªèŠ‚ç‚¹å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œæé«˜å¤„ç†æ•ˆç‡</li>
<li><strong>çŠ¶æ€å¯è¿½æº¯</strong>ï¼šå®Œæ•´çš„çŠ¶æ€å˜åŒ–å†å²ï¼Œä¾¿äºè°ƒè¯•å’Œç›‘æ§</li>
</ul>
<p><strong>æ¶æ„æ ¸å¿ƒç†å¿µ</strong>ï¼šSpring AI Alibaba Graphå°†å¤æ‚çš„AIä»»åŠ¡åˆ†è§£ä¸ºå¯ç»„åˆçš„åŸå­æ“ä½œï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸“æ³¨äºå•ä¸€èŒè´£ï¼Œé€šè¿‡çŠ¶æ€é©±åŠ¨çš„æ–¹å¼å®ç°èŠ‚ç‚¹é—´çš„åè°ƒã€‚è¿™ç§è®¾è®¡è®©å¼€å‘è€…å¯ä»¥åƒæ­ç§¯æœ¨ä¸€æ ·æ„å»ºå¤æ‚çš„AIåº”ç”¨ï¼Œæ—¢ä¿è¯äº†ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ï¼Œåˆæä¾›äº†è¶³å¤Ÿçš„çµæ´»æ€§ã€‚</p>
<h4 id="221-ç³»ç»Ÿæ¶æ„æ€»è§ˆ">2.2.1 ç³»ç»Ÿæ¶æ„æ€»è§ˆ
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">graph TB
</span></span><span class="line"><span class="cl">    subgraph &#34;ç”¨æˆ·å±‚&#34;
</span></span><span class="line"><span class="cl">        U1[Spring Bootåº”ç”¨]
</span></span><span class="line"><span class="cl">        U2[REST Controller]
</span></span><span class="line"><span class="cl">        U3[ä¸šåŠ¡é€»è¾‘]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;Spring AI Alibaba Graphæ ¸å¿ƒ&#34;
</span></span><span class="line"><span class="cl">        SG[StateGraph&lt;br/&gt;çŠ¶æ€å›¾å®šä¹‰&lt;br/&gt;å·¥ä½œæµè“å›¾]
</span></span><span class="line"><span class="cl">        CG[CompiledGraph&lt;br/&gt;ç¼–è¯‘æ‰§è¡Œå™¨&lt;br/&gt;è¿è¡Œæ—¶å¼•æ“]
</span></span><span class="line"><span class="cl">        OS[OverAllState&lt;br/&gt;å…¨å±€çŠ¶æ€&lt;br/&gt;æ•°æ®è½½ä½“]
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        subgraph &#34;èŠ‚ç‚¹å±‚&#34;
</span></span><span class="line"><span class="cl">            N1[LlmNode&lt;br/&gt;å¤§æ¨¡å‹èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">            N2[ToolNode&lt;br/&gt;å·¥å…·èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">            N3[QuestionClassifierNode&lt;br/&gt;åˆ†ç±»èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">            N4[CustomNode&lt;br/&gt;è‡ªå®šä¹‰èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">        end
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        subgraph &#34;Agentå±‚&#34;
</span></span><span class="line"><span class="cl">            A1[ReactAgent&lt;br/&gt;ååº”å¼Agent]
</span></span><span class="line"><span class="cl">            A2[ReflectAgent&lt;br/&gt;åæ€Agent]
</span></span><span class="line"><span class="cl">            A3[ReactAgentWithHuman&lt;br/&gt;äººæœºåä½œAgent]
</span></span><span class="line"><span class="cl">        end
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;åŸºç¡€è®¾æ–½å±‚&#34;
</span></span><span class="line"><span class="cl">        SC[Spring Container&lt;br/&gt;ä¾èµ–æ³¨å…¥]
</span></span><span class="line"><span class="cl">        OB[Observation&lt;br/&gt;è§‚æµ‹æ€§]
</span></span><span class="line"><span class="cl">        CP[Checkpoint&lt;br/&gt;æ£€æŸ¥ç‚¹]
</span></span><span class="line"><span class="cl">        SZ[Serialization&lt;br/&gt;åºåˆ—åŒ–]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;å¤–éƒ¨æœåŠ¡&#34;
</span></span><span class="line"><span class="cl">        LLM[å¤§è¯­è¨€æ¨¡å‹&lt;br/&gt;DashScope/OpenAI]
</span></span><span class="line"><span class="cl">        TOOL[å¤–éƒ¨å·¥å…·&lt;br/&gt;API/å‡½æ•°]
</span></span><span class="line"><span class="cl">        STORE[å­˜å‚¨æœåŠ¡&lt;br/&gt;Redis/DB]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    U1 --&gt; U2
</span></span><span class="line"><span class="cl">    U2 --&gt; U3
</span></span><span class="line"><span class="cl">    U3 --&gt; SG
</span></span><span class="line"><span class="cl">    SG --&gt; CG
</span></span><span class="line"><span class="cl">    CG --&gt; OS
</span></span><span class="line"><span class="cl">    CG --&gt; N1
</span></span><span class="line"><span class="cl">    CG --&gt; N2
</span></span><span class="line"><span class="cl">    CG --&gt; N3
</span></span><span class="line"><span class="cl">    CG --&gt; N4
</span></span><span class="line"><span class="cl">    A1 --&gt; SG
</span></span><span class="line"><span class="cl">    A2 --&gt; SG
</span></span><span class="line"><span class="cl">    A3 --&gt; SG
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    CG --&gt; SC
</span></span><span class="line"><span class="cl">    CG --&gt; OB
</span></span><span class="line"><span class="cl">    CG --&gt; CP
</span></span><span class="line"><span class="cl">    CG --&gt; SZ
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    N1 --&gt; LLM
</span></span><span class="line"><span class="cl">    N2 --&gt; TOOL
</span></span><span class="line"><span class="cl">    CP --&gt; STORE
</span></span><span class="line"><span class="cl">    SZ --&gt; STORE
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="222-stategraphæ„å»ºæµç¨‹">2.2.2 StateGraphæ„å»ºæµç¨‹
</h4><p><strong>StateGraphæ˜¯å·¥ä½œæµçš„è“å›¾è®¾è®¡å™¨</strong>ï¼Œå®ƒè´Ÿè´£å®šä¹‰æ•´ä¸ªå·¥ä½œæµçš„ç»“æ„å’Œæ‰§è¡Œé€»è¾‘ï¼Œå°±åƒå»ºç­‘å¸ˆç»˜åˆ¶å»ºç­‘å›¾çº¸ä¸€æ ·ã€‚é€šè¿‡å£°æ˜å¼çš„APIï¼Œå¼€å‘è€…å¯ä»¥è½»æ¾å®šä¹‰èŠ‚ç‚¹ã€è¾¹å’ŒçŠ¶æ€ç®¡ç†ç­–ç•¥ï¼Œæœ€ç»ˆç¼–è¯‘æˆå¯æ‰§è¡Œçš„CompiledGraphã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart TD
</span></span><span class="line"><span class="cl">    A[å¼€å§‹æ„å»ºStateGraph] --&gt; B[åˆ›å»ºStateGraphå®ä¾‹]
</span></span><span class="line"><span class="cl">    B --&gt; C[å®šä¹‰KeyStrategyFactory]
</span></span><span class="line"><span class="cl">    C --&gt; D[æ·»åŠ èŠ‚ç‚¹ addNode]
</span></span><span class="line"><span class="cl">    D --&gt; E{æ˜¯å¦è¿˜æœ‰èŠ‚ç‚¹?}
</span></span><span class="line"><span class="cl">    E --&gt;|æ˜¯| D
</span></span><span class="line"><span class="cl">    E --&gt;|å¦| F[æ·»åŠ è¾¹ addEdge]
</span></span><span class="line"><span class="cl">    F --&gt; G{æ˜¯å¦è¿˜æœ‰è¾¹?}
</span></span><span class="line"><span class="cl">    G --&gt;|æ˜¯| H[æ·»åŠ æ¡ä»¶è¾¹ addConditionalEdges]
</span></span><span class="line"><span class="cl">    H --&gt; G
</span></span><span class="line"><span class="cl">    G --&gt;|å¦| I[éªŒè¯å›¾ç»“æ„ validateGraph]
</span></span><span class="line"><span class="cl">    I --&gt; J{éªŒè¯é€šè¿‡?}
</span></span><span class="line"><span class="cl">    J --&gt;|å¦| K[æŠ›å‡ºGraphStateException]
</span></span><span class="line"><span class="cl">    J --&gt;|æ˜¯| L[ç¼–è¯‘å›¾ compile]
</span></span><span class="line"><span class="cl">    L --&gt; M[ç”ŸæˆCompiledGraph]
</span></span><span class="line"><span class="cl">    M --&gt; N[ç»“æŸ]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    style A fill:#e1f5fe
</span></span><span class="line"><span class="cl">    style N fill:#e8f5e8
</span></span><span class="line"><span class="cl">    style K fill:#ffebee
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å…³é”®è®¾è®¡æ€æƒ³</strong>ï¼šStateGraphé‡‡ç”¨äº†&quot;å…ˆå®šä¹‰åæ‰§è¡Œ&quot;çš„æ¨¡å¼ï¼Œå°†å·¥ä½œæµçš„ç»“æ„å®šä¹‰ä¸å®é™…æ‰§è¡Œåˆ†ç¦»ï¼Œè¿™æ ·å¯ä»¥åœ¨ç¼–è¯‘æ—¶è¿›è¡Œå„ç§éªŒè¯å’Œä¼˜åŒ–ï¼Œç¡®ä¿è¿è¡Œæ—¶çš„ç¨³å®šæ€§å’Œé«˜æ•ˆæ€§ã€‚</p>
<h4 id="223-compiledgraphæ‰§è¡Œæµç¨‹">2.2.3 CompiledGraphæ‰§è¡Œæµç¨‹
</h4><p><strong>CompiledGraphæ˜¯å·¥ä½œæµçš„è¿è¡Œæ—¶å¼•æ“</strong>ï¼Œå®ƒå°†StateGraphçš„é™æ€å®šä¹‰è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„åŠ¨æ€æµç¨‹ã€‚å°±åƒå°†å»ºç­‘å›¾çº¸å˜æˆçœŸæ­£çš„å»ºç­‘ç‰©ä¸€æ ·ï¼ŒCompiledGraphè´Ÿè´£åè°ƒå„ä¸ªç»„ä»¶çš„æ‰§è¡Œï¼Œç®¡ç†çŠ¶æ€æµè½¬ï¼Œç¡®ä¿æ•´ä¸ªå·¥ä½œæµæŒ‰ç…§é¢„æœŸè¿è¡Œã€‚</p>
<p><strong>AsyncNodeGeneratoræ˜¯æ•´ä¸ªå›¾æµè½¬æ‰§è¡Œçš„å”¯ä¸€çŠ¶æ€æœº</strong>ï¼Œå®ƒæ§åˆ¶ç€å·¥ä½œæµçš„æ¯ä¸€æ­¥æ‰§è¡Œï¼ŒåŒ…æ‹¬èŠ‚ç‚¹è°ƒåº¦ã€çŠ¶æ€æ›´æ–°ã€æ¡ä»¶åˆ¤æ–­å’Œå¼‚å¸¸å¤„ç†ã€‚è¿™ç§å•ä¸€çŠ¶æ€æœºçš„è®¾è®¡ç¡®ä¿äº†æ‰§è¡Œçš„ä¸€è‡´æ€§å’Œå¯é¢„æµ‹æ€§ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sequenceDiagram
</span></span><span class="line"><span class="cl">    participant Client as å®¢æˆ·ç«¯
</span></span><span class="line"><span class="cl">    participant CG as CompiledGraph
</span></span><span class="line"><span class="cl">    participant ANG as AsyncNodeGenerator
</span></span><span class="line"><span class="cl">    participant Node as èŠ‚ç‚¹
</span></span><span class="line"><span class="cl">    participant State as OverAllState
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    Client-&gt;&gt;CG: invoke(inputs)
</span></span><span class="line"><span class="cl">    CG-&gt;&gt;CG: stateCreate(inputs)
</span></span><span class="line"><span class="cl">    CG-&gt;&gt;ANG: new AsyncNodeGenerator(state, config)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    loop æ‰§è¡Œå¾ªç¯
</span></span><span class="line"><span class="cl">        ANG-&gt;&gt;ANG: next()
</span></span><span class="line"><span class="cl">        ANG-&gt;&gt;ANG: æ£€æŸ¥æœ€å¤§è¿­ä»£æ¬¡æ•°
</span></span><span class="line"><span class="cl">        ANG-&gt;&gt;ANG: æ£€æŸ¥ä¸­æ–­æ¡ä»¶
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        alt èµ·å§‹èŠ‚ç‚¹
</span></span><span class="line"><span class="cl">            ANG-&gt;&gt;ANG: å¤„ç†STARTèŠ‚ç‚¹
</span></span><span class="line"><span class="cl">            ANG-&gt;&gt;ANG: ç¡®å®šä¸‹ä¸€ä¸ªèŠ‚ç‚¹
</span></span><span class="line"><span class="cl">        else æ™®é€šèŠ‚ç‚¹
</span></span><span class="line"><span class="cl">            ANG-&gt;&gt;Node: æ‰§è¡ŒèŠ‚ç‚¹åŠ¨ä½œ
</span></span><span class="line"><span class="cl">            Node-&gt;&gt;State: æ›´æ–°çŠ¶æ€
</span></span><span class="line"><span class="cl">            State--&gt;&gt;ANG: è¿”å›æ›´æ–°ç»“æœ
</span></span><span class="line"><span class="cl">            ANG-&gt;&gt;ANG: ç¡®å®šä¸‹ä¸€ä¸ªèŠ‚ç‚¹
</span></span><span class="line"><span class="cl">        else ç»“æŸèŠ‚ç‚¹
</span></span><span class="line"><span class="cl">            ANG-&gt;&gt;ANG: å¤„ç†ENDèŠ‚ç‚¹
</span></span><span class="line"><span class="cl">            ANG--&gt;&gt;CG: è¿”å›æœ€ç»ˆç»“æœ
</span></span><span class="line"><span class="cl">        end
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        ANG-&gt;&gt;ANG: æ·»åŠ æ£€æŸ¥ç‚¹
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    CG--&gt;&gt;Client: è¿”å›æœ€ç»ˆçŠ¶æ€
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ ¸å¿ƒæ‰§è¡Œæœºåˆ¶</strong>ï¼šCompiledGraphé‡‡ç”¨äº†åŸºäºè¿­ä»£å™¨æ¨¡å¼çš„å¼‚æ­¥æ‰§è¡Œæœºåˆ¶ï¼Œæ¯æ¬¡è°ƒç”¨next()æ–¹æ³•éƒ½ä¼šæ¨è¿›å·¥ä½œæµçš„æ‰§è¡Œï¼Œè¿™ç§è®¾è®¡æ—¢æ”¯æŒåŒæ­¥è°ƒç”¨ï¼Œä¹Ÿæ”¯æŒæµå¼å¤„ç†ï¼Œä¸ºä¸åŒçš„ä½¿ç”¨åœºæ™¯æä¾›äº†çµæ´»æ€§ã€‚</p>
<h3 id="23-æ ¸å¿ƒç»„ä»¶å…³ç³»å›¾">2.3 æ ¸å¿ƒç»„ä»¶å…³ç³»å›¾
</h3><p><strong>ç»„ä»¶èŒè´£è¯´æ˜</strong>ï¼š</p>
<ul>
<li><strong>StateGraph</strong>ï¼šå·¥ä½œæµçš„æ¶æ„å¸ˆï¼Œè´Ÿè´£å®šä¹‰æ•´ä¸ªæµç¨‹çš„ç»“æ„å’Œè§„åˆ™</li>
<li><strong>CompiledGraph</strong>ï¼šå·¥ä½œæµçš„æŒ‡æŒ¥å®˜ï¼Œè´Ÿè´£åè°ƒå’Œç®¡ç†æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹</li>
<li><strong>OverAllState</strong>ï¼šå·¥ä½œæµçš„è®°å¿†ä¸­å¿ƒï¼Œè´Ÿè´£å­˜å‚¨å’Œç®¡ç†æ‰€æœ‰çŠ¶æ€æ•°æ®</li>
<li><strong>Node</strong>ï¼šå·¥ä½œæµçš„æ‰§è¡Œå•å…ƒï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸“æ³¨äºç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘</li>
<li><strong>Edge</strong>ï¼šå·¥ä½œæµçš„è¿æ¥å™¨ï¼Œå®šä¹‰èŠ‚ç‚¹ä¹‹é—´çš„è½¬æ¢å…³ç³»å’Œæ¡ä»¶</li>
<li><strong>AsyncNodeGenerator</strong>ï¼šå·¥ä½œæµçš„æ‰§è¡Œå¼•æ“ï¼Œæ˜¯æ¨åŠ¨æ•´ä¸ªæµç¨‹è¿è½¬çš„æ ¸å¿ƒçŠ¶æ€æœº</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">classDiagram
</span></span><span class="line"><span class="cl">    class StateGraph {
</span></span><span class="line"><span class="cl">        +String name
</span></span><span class="line"><span class="cl">        +Nodes nodes
</span></span><span class="line"><span class="cl">        +Edges edges
</span></span><span class="line"><span class="cl">        +KeyStrategyFactory keyStrategyFactory
</span></span><span class="line"><span class="cl">        +addNode(String id, NodeAction action)
</span></span><span class="line"><span class="cl">        +addEdge(String source, String target)
</span></span><span class="line"><span class="cl">        +addConditionalEdges(String source, EdgeCondition condition, Map mappings)
</span></span><span class="line"><span class="cl">        +compile(CompileConfig config) CompiledGraph
</span></span><span class="line"><span class="cl">        +validateGraph()
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class CompiledGraph {
</span></span><span class="line"><span class="cl">        +StateGraph stateGraph
</span></span><span class="line"><span class="cl">        +CompileConfig compileConfig
</span></span><span class="line"><span class="cl">        +Map~String,AsyncNodeActionWithConfig~ nodes
</span></span><span class="line"><span class="cl">        +Map~String,EdgeValue~ edges
</span></span><span class="line"><span class="cl">        +invoke(Map input) Optional~OverAllState~
</span></span><span class="line"><span class="cl">        +stream(Map input) AsyncGenerator~NodeOutput~
</span></span><span class="line"><span class="cl">        +resume(HumanFeedback feedback) Optional~OverAllState~
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class OverAllState {
</span></span><span class="line"><span class="cl">        +Map~String,Object~ data
</span></span><span class="line"><span class="cl">        +Map~String,KeyStrategy~ keyStrategies
</span></span><span class="line"><span class="cl">        +Boolean resume
</span></span><span class="line"><span class="cl">        +HumanFeedback humanFeedback
</span></span><span class="line"><span class="cl">        +String interruptMessage
</span></span><span class="line"><span class="cl">        +value(String key) Optional~Object~
</span></span><span class="line"><span class="cl">        +updateState(Map updates)
</span></span><span class="line"><span class="cl">        +registerKeyAndStrategy(String key, KeyStrategy strategy)
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class Node {
</span></span><span class="line"><span class="cl">        +String id
</span></span><span class="line"><span class="cl">        +ActionFactory actionFactory
</span></span><span class="line"><span class="cl">        +apply(CompileConfig config) AsyncNodeActionWithConfig
</span></span><span class="line"><span class="cl">        +isParallel() boolean
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class Edge {
</span></span><span class="line"><span class="cl">        +String sourceId
</span></span><span class="line"><span class="cl">        +EdgeValue targetValue
</span></span><span class="line"><span class="cl">        +validate(Nodes nodes)
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class AsyncNodeGenerator {
</span></span><span class="line"><span class="cl">        +Map~String,Object~ currentState
</span></span><span class="line"><span class="cl">        +String currentNodeId
</span></span><span class="line"><span class="cl">        +String nextNodeId
</span></span><span class="line"><span class="cl">        +OverAllState overAllState
</span></span><span class="line"><span class="cl">        +RunnableConfig config
</span></span><span class="line"><span class="cl">        +next() Data~NodeOutput~
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    StateGraph --&gt; CompiledGraph : compile()
</span></span><span class="line"><span class="cl">    StateGraph --&gt; Node : contains
</span></span><span class="line"><span class="cl">    StateGraph --&gt; Edge : contains
</span></span><span class="line"><span class="cl">    CompiledGraph --&gt; OverAllState : manages
</span></span><span class="line"><span class="cl">    CompiledGraph --&gt; AsyncNodeGenerator : creates
</span></span><span class="line"><span class="cl">    Node --&gt; OverAllState : processes
</span></span><span class="line"><span class="cl">    AsyncNodeGenerator --&gt; Node : executes
</span></span><span class="line"><span class="cl">    AsyncNodeGenerator --&gt; OverAllState : updates
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="24-æ ¸å¿ƒè®¾è®¡ç†å¿µ">2.4 æ ¸å¿ƒè®¾è®¡ç†å¿µ
</h3><h4 id="241-å£°æ˜å¼ç¼–ç¨‹æ¨¡å‹">2.4.1 å£°æ˜å¼ç¼–ç¨‹æ¨¡å‹
</h4><p>å€Ÿé‰´LangGraphçš„è®¾è®¡ç†å¿µï¼ŒSpring AI Alibaba Graphé‡‡ç”¨å£°æ˜å¼ç¼–ç¨‹æ¨¡å‹ï¼Œå¼€å‘è€…åªéœ€è¦æè¿°&quot;åšä»€ä¹ˆ&quot;ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// å£°æ˜å¼å®šä¹‰å·¥ä½œæµ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">StateGraph</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StateGraph</span><span class="p">(</span><span class="s">&#34;å®¢æˆ·æœåŠ¡å·¥ä½œæµ&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">stateFactory</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;feedback_classifier&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">feedbackClassifier</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;specific_question_classifier&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">specificQuestionClassifier</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;recorder&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">recorderNode</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;feedback_classifier&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addConditionalEdges</span><span class="p">(</span><span class="s">&#34;feedback_classifier&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">edge_async</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">FeedbackQuestionDispatcher</span><span class="p">()),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;positive&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;recorder&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;negative&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;specific_question_classifier&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;recorder&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="242-çŠ¶æ€é©±åŠ¨çš„æ‰§è¡Œæ¨¡å‹">2.4.2 çŠ¶æ€é©±åŠ¨çš„æ‰§è¡Œæ¨¡å‹
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart LR
</span></span><span class="line"><span class="cl">    subgraph &#34;çŠ¶æ€ç®¡ç†æµç¨‹&#34;
</span></span><span class="line"><span class="cl">        S1[åˆå§‹çŠ¶æ€] --&gt; N1[èŠ‚ç‚¹1æ‰§è¡Œ]
</span></span><span class="line"><span class="cl">        N1 --&gt; U1[çŠ¶æ€æ›´æ–°]
</span></span><span class="line"><span class="cl">        U1 --&gt; S2[æ–°çŠ¶æ€]
</span></span><span class="line"><span class="cl">        S2 --&gt; N2[èŠ‚ç‚¹2æ‰§è¡Œ]
</span></span><span class="line"><span class="cl">        N2 --&gt; U2[çŠ¶æ€æ›´æ–°]
</span></span><span class="line"><span class="cl">        U2 --&gt; S3[æœ€ç»ˆçŠ¶æ€]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;çŠ¶æ€ç»“æ„&#34;
</span></span><span class="line"><span class="cl">        OS[OverAllState]
</span></span><span class="line"><span class="cl">        OS --&gt; D[data: Map&lt;String,Object&gt;]
</span></span><span class="line"><span class="cl">        OS --&gt; KS[keyStrategies: Map&lt;String,KeyStrategy&gt;]
</span></span><span class="line"><span class="cl">        OS --&gt; R[resume: Boolean]
</span></span><span class="line"><span class="cl">        OS --&gt; HF[humanFeedback: HumanFeedback]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;çŠ¶æ€ç­–ç•¥&#34;
</span></span><span class="line"><span class="cl">        RS[ReplaceStrategy&lt;br/&gt;æ›¿æ¢ç­–ç•¥]
</span></span><span class="line"><span class="cl">        AS[AppendStrategy&lt;br/&gt;è¿½åŠ ç­–ç•¥]
</span></span><span class="line"><span class="cl">        CS[CustomStrategy&lt;br/&gt;è‡ªå®šä¹‰ç­–ç•¥]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    U1 --&gt; OS
</span></span><span class="line"><span class="cl">    U2 --&gt; OS
</span></span><span class="line"><span class="cl">    KS --&gt; RS
</span></span><span class="line"><span class="cl">    KS --&gt; AS
</span></span><span class="line"><span class="cl">    KS --&gt; CS
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰€æœ‰çš„æ•°æ®æµè½¬éƒ½é€šè¿‡<code>OverAllState</code>è¿›è¡Œç®¡ç†ï¼Œç¡®ä¿çŠ¶æ€çš„ä¸€è‡´æ€§å’Œå¯è¿½æº¯æ€§ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// çŠ¶æ€å·¥å‚å®šä¹‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">KeyStrategyFactory</span><span class="w"> </span><span class="n">stateFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">strategies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;classifier_output&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;solution&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">strategies</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">};</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="243-å¼‚æ­¥ä¼˜å…ˆçš„è®¾è®¡">2.4.3 å¼‚æ­¥ä¼˜å…ˆçš„è®¾è®¡
</h4><p>æ¡†æ¶ä¼˜å…ˆæ”¯æŒå¼‚æ­¥å¤„ç†ï¼Œæé«˜ç³»ç»Ÿçš„ååé‡å’Œå“åº”æ€§ï¼ŒåŒæ—¶è¿˜åŸç”Ÿæ”¯æŒäº†<strong>èŠ‚ç‚¹å†…æ¨¡å‹æµå¼é€ä¼ </strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">graph TD
</span></span><span class="line"><span class="cl">    subgraph &#34;å¼‚æ­¥æ‰§è¡Œæ¨¡å‹&#34;
</span></span><span class="line"><span class="cl">        A1[AsyncNodeAction] --&gt; CF1[CompletableFuture]
</span></span><span class="line"><span class="cl">        A2[AsyncNodeActionWithConfig] --&gt; CF2[CompletableFuture]
</span></span><span class="line"><span class="cl">        A3[AsyncCommandAction] --&gt; CF3[CompletableFuture]
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        CF1 --&gt; ANG[AsyncNodeGenerator]
</span></span><span class="line"><span class="cl">        CF2 --&gt; ANG
</span></span><span class="line"><span class="cl">        CF3 --&gt; ANG
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        ANG --&gt; AG[AsyncGenerator]
</span></span><span class="line"><span class="cl">        AG --&gt; Stream[Stream Processing]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;å¹¶è¡Œå¤„ç†&#34;
</span></span><span class="line"><span class="cl">        PN[ParallelNode] --&gt; PA1[Action1]
</span></span><span class="line"><span class="cl">        PN --&gt; PA2[Action2]
</span></span><span class="line"><span class="cl">        PN --&gt; PA3[Action3]
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        PA1 --&gt; CF4[CompletableFuture]
</span></span><span class="line"><span class="cl">        PA2 --&gt; CF5[CompletableFuture]
</span></span><span class="line"><span class="cl">        PA3 --&gt; CF6[CompletableFuture]
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        CF4 --&gt; ALLOF[CompletableFuture.allOf]
</span></span><span class="line"><span class="cl">        CF5 --&gt; ALLOF
</span></span><span class="line"><span class="cl">        CF6 --&gt; ALLOF
</span></span><span class="line"><span class="cl">    end
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// å¼‚æ­¥èŠ‚ç‚¹å®šä¹‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">AsyncNodeAction</span><span class="w"> </span><span class="n">asyncNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CustomNodeAction</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// å¹¶è¡ŒèŠ‚ç‚¹å¤„ç†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ParallelNode</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">record</span> <span class="nc">AsyncParallelNodeAction</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AsyncNodeActionWithConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actions</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">channels</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">AsyncNodeActionWithConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">RunnableConfig</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">futures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actions</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">action</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="n">CompletableFuture</span><span class="o">[]</span><span class="p">::</span><span class="k">new</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">allOf</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">thenApply</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// åˆå¹¶æ‰€æœ‰ç»“æœ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">futures</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">result</span><span class="p">.</span><span class="na">putAll</span><span class="p">(</span><span class="n">future</span><span class="p">.</span><span class="na">join</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="25-springç”Ÿæ€é›†æˆ">2.5 Springç”Ÿæ€é›†æˆ
</h3><p>Spring AI Alibaba Graphä¸Springç”Ÿæ€æ·±åº¦é›†æˆï¼Œæ‚¨å¯ä»¥è½»æ¾åœ¨æ‚¨çš„Springåº”ç”¨ä¸­å¼•å…¥AIæ¨¡å‹å·¥ä½œæµä»¥å¼€å‘æ™ºèƒ½Javaåº”ç”¨ã€‚</p>
<h4 id="251-ä¾èµ–æ³¨å…¥æ¶æ„">2.5.1 ä¾èµ–æ³¨å…¥æ¶æ„
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">graph TB
</span></span><span class="line"><span class="cl">    subgraph &#34;Spring Bootåº”ç”¨å±‚&#34;
</span></span><span class="line"><span class="cl">        APP[Spring Boot Application]
</span></span><span class="line"><span class="cl">        CTRL[REST Controller]
</span></span><span class="line"><span class="cl">        SVC[Service Layer]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;Graphé…ç½®å±‚&#34;
</span></span><span class="line"><span class="cl">        CONF[GraphConfiguration]
</span></span><span class="line"><span class="cl">        BEAN1[@Bean StateGraph]
</span></span><span class="line"><span class="cl">        BEAN2[@Bean CompiledGraph]
</span></span><span class="line"><span class="cl">        BEAN3[@Bean ChatModel]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;Springå®¹å™¨ç®¡ç†&#34;
</span></span><span class="line"><span class="cl">        IOC[IoC Container]
</span></span><span class="line"><span class="cl">        DI[Dependency Injection]
</span></span><span class="line"><span class="cl">        AOP[AOP Support]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;è§‚æµ‹æ€§é›†æˆ&#34;
</span></span><span class="line"><span class="cl">        OBS[ObservationRegistry]
</span></span><span class="line"><span class="cl">        METRICS[Metrics Collection]
</span></span><span class="line"><span class="cl">        TRACING[Distributed Tracing]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    APP --&gt; CTRL
</span></span><span class="line"><span class="cl">    CTRL --&gt; SVC
</span></span><span class="line"><span class="cl">    SVC --&gt; BEAN2
</span></span><span class="line"><span class="cl">    CONF --&gt; BEAN1
</span></span><span class="line"><span class="cl">    CONF --&gt; BEAN2
</span></span><span class="line"><span class="cl">    CONF --&gt; BEAN3
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    IOC --&gt; DI
</span></span><span class="line"><span class="cl">    DI --&gt; CONF
</span></span><span class="line"><span class="cl">    AOP --&gt; OBS
</span></span><span class="line"><span class="cl">    OBS --&gt; METRICS
</span></span><span class="line"><span class="cl">    OBS --&gt; TRACING
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="252-ä¾èµ–æ³¨å…¥æ”¯æŒ">2.5.2 ä¾èµ–æ³¨å…¥æ”¯æŒ
</h4><p>ä»¥ä¸‹ä»£ç æ¼”ç¤ºäº†Spring AI Alibaba Graphæ˜¯å¦‚ä½•è¢«IOCå®¹å™¨æ‰€ç®¡ç†çš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GraphConfiguration</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="nf">workflowGraph</span><span class="p">(</span><span class="n">ChatModel</span><span class="w"> </span><span class="n">chatModel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ChatClient</span><span class="w"> </span><span class="n">chatClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChatClient</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="n">chatModel</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">defaultAdvisors</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SimpleLoggerAdvisor</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æ„å»ºå›¾å®šä¹‰...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">stateGraph</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompiledGraph</span><span class="w"> </span><span class="nf">compiledGraph</span><span class="p">(</span><span class="n">StateGraph</span><span class="w"> </span><span class="n">stateGraph</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                      </span><span class="n">ObservationRegistry</span><span class="w"> </span><span class="n">observationRegistry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">stateGraph</span><span class="p">.</span><span class="na">compile</span><span class="p">(</span><span class="n">CompileConfig</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">withLifecycleListener</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">GraphObservationLifecycleListener</span><span class="p">(</span><span class="n">observationRegistry</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="253-è§‚æµ‹æ€§é›†æˆ">2.5.3 è§‚æµ‹æ€§é›†æˆ
</h4><p>Spring AI Alibaba GraphåŸºäºMicrometerå†…ç½®äº†å¯è§‚æµ‹æ”¯æŒï¼Œå¯ä»¥æ— ç¼é›†æˆSpring Bootå¯è§‚æµ‹æ€§ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GraphController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">GraphController</span><span class="p">(</span><span class="nd">@Qualifier</span><span class="p">(</span><span class="s">&#34;workflowGraph&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="n">stateGraph</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="n">ObjectProvider</span><span class="o">&lt;</span><span class="n">ObservationRegistry</span><span class="o">&gt;</span><span class="w"> </span><span class="n">observationRegistry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">compiledGraph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stateGraph</span><span class="p">.</span><span class="na">compile</span><span class="p">(</span><span class="n">CompileConfig</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">withLifecycleListener</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">GraphObservationLifecycleListener</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">observationRegistry</span><span class="p">.</span><span class="na">getIfUnique</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ObservationRegistry</span><span class="p">.</span><span class="na">NOOP</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-æ ¸å¿ƒæ¦‚å¿µæ·±åº¦è§£æ">3. æ ¸å¿ƒæ¦‚å¿µæ·±åº¦è§£æ
</h2><h3 id="31-stategraph-çŠ¶æ€å›¾">3.1 StateGraph (çŠ¶æ€å›¾)
</h3><p><strong>StateGraphæ˜¯æ•´ä¸ªæ¡†æ¶çš„è®¾è®¡è“å›¾</strong>ï¼Œå®ƒå°±åƒå»ºç­‘å¸ˆçš„è®¾è®¡å›¾çº¸ä¸€æ ·ï¼Œå®šä¹‰äº†å·¥ä½œæµçš„å®Œæ•´ç»“æ„å’Œæ‰§è¡Œé€»è¾‘ã€‚StateGraphé‡‡ç”¨å£°æ˜å¼APIï¼Œè®©å¼€å‘è€…å¯ä»¥ç”¨ç®€æ´çš„ä»£ç æè¿°å¤æ‚çš„ä¸šåŠ¡æµç¨‹ï¼Œè€Œä¸éœ€è¦å…³å¿ƒåº•å±‚çš„æ‰§è¡Œç»†èŠ‚ã€‚</p>
<p><strong>æ ¸å¿ƒè®¾è®¡ç†å¿µ</strong>ï¼šStateGraphå°†å¤æ‚çš„å·¥ä½œæµæŠ½è±¡ä¸ºèŠ‚ç‚¹å’Œè¾¹çš„ç»„åˆï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªå…·ä½“çš„æ“ä½œï¼Œè¾¹å®šä¹‰äº†æ“ä½œä¹‹é—´çš„æµè½¬å…³ç³»ã€‚è¿™ç§æŠ½è±¡è®©å¼€å‘è€…å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘çš„è®¾è®¡ï¼Œè€Œä¸æ˜¯æ‰§è¡Œæœºåˆ¶çš„å®ç°ã€‚</p>
<h4 id="311-stategraphç”Ÿå‘½å‘¨æœŸ">3.1.1 StateGraphç”Ÿå‘½å‘¨æœŸ
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">stateDiagram-v2
</span></span><span class="line"><span class="cl">    [*] --&gt; Created: new StateGraph()
</span></span><span class="line"><span class="cl">    Created --&gt; Building: æ·»åŠ èŠ‚ç‚¹å’Œè¾¹
</span></span><span class="line"><span class="cl">    Building --&gt; Building: addNode() / addEdge()
</span></span><span class="line"><span class="cl">    Building --&gt; Validating: validateGraph()
</span></span><span class="line"><span class="cl">    Validating --&gt; Invalid: éªŒè¯å¤±è´¥
</span></span><span class="line"><span class="cl">    Invalid --&gt; [*]: æŠ›å‡ºå¼‚å¸¸
</span></span><span class="line"><span class="cl">    Validating --&gt; Valid: éªŒè¯é€šè¿‡
</span></span><span class="line"><span class="cl">    Valid --&gt; Compiled: compile()
</span></span><span class="line"><span class="cl">    Compiled --&gt; Executing: invoke() / stream()
</span></span><span class="line"><span class="cl">    Executing --&gt; Completed: æ‰§è¡Œå®Œæˆ
</span></span><span class="line"><span class="cl">    Completed --&gt; [*]
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="312-åŸºæœ¬æ„é€ ">3.1.2 åŸºæœ¬æ„é€ 
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StateGraph</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// æ ¸å¿ƒæ•°æ®ç»“æ„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Nodes</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Nodes</span><span class="p">();</span><span class="w">  </span><span class="c1">// å­˜å‚¨æ‰€æœ‰èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Edges</span><span class="w"> </span><span class="n">edges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Edges</span><span class="p">();</span><span class="w">  </span><span class="c1">// å­˜å‚¨æ‰€æœ‰è¾¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ç‰¹æ®ŠèŠ‚ç‚¹å¸¸é‡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;__END__&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">START</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;__START__&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ERROR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;__ERROR__&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// çŠ¶æ€ç®¡ç†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">KeyStrategyFactory</span><span class="w"> </span><span class="n">keyStrategyFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">PlainTextStateSerializer</span><span class="w"> </span><span class="n">stateSerializer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="313-èŠ‚ç‚¹ç®¡ç†æµç¨‹">3.1.3 èŠ‚ç‚¹ç®¡ç†æµç¨‹
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart TD
</span></span><span class="line"><span class="cl">    A[addNodeè°ƒç”¨] --&gt; B{æ£€æŸ¥èŠ‚ç‚¹ID}
</span></span><span class="line"><span class="cl">    B --&gt;|IDä¸ºEND| C[æŠ›å‡ºå¼‚å¸¸]
</span></span><span class="line"><span class="cl">    B --&gt;|IDåˆæ³•| D{æ£€æŸ¥æ˜¯å¦é‡å¤}
</span></span><span class="line"><span class="cl">    D --&gt;|é‡å¤| E[æŠ›å‡ºé‡å¤èŠ‚ç‚¹å¼‚å¸¸]
</span></span><span class="line"><span class="cl">    D --&gt;|ä¸é‡å¤| F[åˆ›å»ºNodeå¯¹è±¡]
</span></span><span class="line"><span class="cl">    F --&gt; G[æ·»åŠ åˆ°nodesé›†åˆ]
</span></span><span class="line"><span class="cl">    G --&gt; H[è¿”å›StateGraphå®ä¾‹]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;èŠ‚ç‚¹ç±»å‹&#34;
</span></span><span class="line"><span class="cl">        I[æ™®é€šèŠ‚ç‚¹&lt;br/&gt;AsyncNodeAction]
</span></span><span class="line"><span class="cl">        J[å¸¦é…ç½®èŠ‚ç‚¹&lt;br/&gt;AsyncNodeActionWithConfig]
</span></span><span class="line"><span class="cl">        K[å­å›¾èŠ‚ç‚¹&lt;br/&gt;StateGraph]
</span></span><span class="line"><span class="cl">        L[å‘½ä»¤èŠ‚ç‚¹&lt;br/&gt;AsyncCommandAction]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    F --&gt; I
</span></span><span class="line"><span class="cl">    F --&gt; J
</span></span><span class="line"><span class="cl">    F --&gt; K
</span></span><span class="line"><span class="cl">    F --&gt; L
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ”¯æŒçš„èŠ‚ç‚¹æ·»åŠ æ–¹å¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// æ·»åŠ æ™®é€šèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="nf">addNode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">AsyncNodeAction</span><span class="w"> </span><span class="n">action</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Node</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">AsyncNodeActionWithConfig</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">action</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">addNode</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// æ·»åŠ å¸¦é…ç½®çš„èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="nf">addNode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">AsyncNodeActionWithConfig</span><span class="w"> </span><span class="n">actionWithConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Node</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">actionWithConfig</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">addNode</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// æ·»åŠ å­å›¾èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="nf">addNode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="n">subGraph</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">subGraph</span><span class="p">.</span><span class="na">validateGraph</span><span class="p">();</span><span class="w"> </span><span class="c1">// å…ˆéªŒè¯å­å›¾</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SubStateGraphNode</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">subGraph</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">addNode</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="314-è¾¹ç®¡ç†æµç¨‹">3.1.4 è¾¹ç®¡ç†æµç¨‹
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart TD
</span></span><span class="line"><span class="cl">    A[&#34;addEdgeè°ƒç”¨&#34;] --&gt; B{&#34;è¾¹ç±»å‹&#34;}
</span></span><span class="line"><span class="cl">    B --&gt;|é™æ€è¾¹| C[&#34;addEdge(source, target)&#34;]
</span></span><span class="line"><span class="cl">    B --&gt;|æ¡ä»¶è¾¹| D[&#34;addConditionalEdges(source, condition, mappings)&#34;]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    C --&gt; E{&#34;æ£€æŸ¥æºèŠ‚ç‚¹&#34;}
</span></span><span class="line"><span class="cl">    E --&gt;|æºèŠ‚ç‚¹ä¸ºEND| F[&#34;æŠ›å‡ºå¼‚å¸¸&#34;]
</span></span><span class="line"><span class="cl">    E --&gt;|æºèŠ‚ç‚¹åˆæ³•| G[&#34;åˆ›å»ºEdgeå¯¹è±¡&#34;]
</span></span><span class="line"><span class="cl">    G --&gt; H[&#34;æ·»åŠ åˆ°edgesé›†åˆ&#34;]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    D --&gt; I{&#34;æ£€æŸ¥æ˜ å°„&#34;}
</span></span><span class="line"><span class="cl">    I --&gt;|æ˜ å°„ä¸ºç©º| J[&#34;æŠ›å‡ºå¼‚å¸¸&#34;]
</span></span><span class="line"><span class="cl">    I --&gt;|æ˜ å°„æœ‰æ•ˆ| K[&#34;åˆ›å»ºæ¡ä»¶è¾¹&#34;]
</span></span><span class="line"><span class="cl">    K --&gt; L{&#34;æ£€æŸ¥æ˜¯å¦é‡å¤&#34;}
</span></span><span class="line"><span class="cl">    L --&gt;|é‡å¤| M[&#34;æŠ›å‡ºé‡å¤è¾¹å¼‚å¸¸&#34;]
</span></span><span class="line"><span class="cl">    L --&gt;|ä¸é‡å¤| N[&#34;æ·»åŠ åˆ°edgesé›†åˆ&#34;]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    H --&gt; O[&#34;è¿”å›StateGraph&#34;]
</span></span><span class="line"><span class="cl">    N --&gt; O
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="315-å›¾éªŒè¯æœºåˆ¶">3.1.5 å›¾éªŒè¯æœºåˆ¶
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart TD
</span></span><span class="line"><span class="cl">    A[validateGraphå¼€å§‹] --&gt; B[æ£€æŸ¥å…¥å£ç‚¹]
</span></span><span class="line"><span class="cl">    B --&gt; C{STARTè¾¹æ˜¯å¦å­˜åœ¨?}
</span></span><span class="line"><span class="cl">    C --&gt;|å¦| D[æŠ›å‡ºç¼ºå°‘å…¥å£ç‚¹å¼‚å¸¸]
</span></span><span class="line"><span class="cl">    C --&gt;|æ˜¯| E[éªŒè¯STARTè¾¹]
</span></span><span class="line"><span class="cl">    E --&gt; F[éªŒè¯æ‰€æœ‰èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">    F --&gt; G[éªŒè¯æ‰€æœ‰è¾¹]
</span></span><span class="line"><span class="cl">    G --&gt; H{æ‰€æœ‰éªŒè¯é€šè¿‡?}
</span></span><span class="line"><span class="cl">    H --&gt;|å¦| I[æŠ›å‡ºGraphStateException]
</span></span><span class="line"><span class="cl">    H --&gt;|æ˜¯| J[éªŒè¯æˆåŠŸ]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;è¾¹éªŒè¯é€»è¾‘&#34;
</span></span><span class="line"><span class="cl">        K[æ£€æŸ¥æºèŠ‚ç‚¹å­˜åœ¨æ€§]
</span></span><span class="line"><span class="cl">        L[æ£€æŸ¥ç›®æ ‡èŠ‚ç‚¹å­˜åœ¨æ€§]
</span></span><span class="line"><span class="cl">        M[æ£€æŸ¥æ¡ä»¶è¾¹æ˜ å°„]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    G --&gt; K
</span></span><span class="line"><span class="cl">    G --&gt; L
</span></span><span class="line"><span class="cl">    G --&gt; M
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="32-overallstate-å…¨å±€çŠ¶æ€">3.2 OverAllState (å…¨å±€çŠ¶æ€)
</h3><p><strong>OverAllStateæ˜¯å·¥ä½œæµçš„æ•°æ®ä¸­æ¢</strong>ï¼Œå®ƒå°±åƒå·¥ä½œæµçš„è®°å¿†ç³»ç»Ÿä¸€æ ·ï¼Œè´Ÿè´£åœ¨å„ä¸ªèŠ‚ç‚¹ä¹‹é—´ä¼ é€’å’Œç®¡ç†çŠ¶æ€æ•°æ®ã€‚OverAllStateä¸ä»…å­˜å‚¨æ•°æ®ï¼Œè¿˜å®šä¹‰äº†æ•°æ®çš„åˆå¹¶ç­–ç•¥ï¼Œç¡®ä¿ä¸åŒèŠ‚ç‚¹äº§ç”Ÿçš„æ•°æ®èƒ½å¤Ÿæ­£ç¡®åœ°æ•´åˆåœ¨ä¸€èµ·ã€‚</p>
<p><strong>è®¾è®¡å·§æ€</strong>ï¼šOverAllStateé‡‡ç”¨äº†ç­–ç•¥æ¨¡å¼æ¥å¤„ç†çŠ¶æ€æ›´æ–°ï¼Œä¸åŒçš„æ•°æ®ç±»å‹å¯ä»¥é‡‡ç”¨ä¸åŒçš„åˆå¹¶ç­–ç•¥ï¼ˆå¦‚æ›¿æ¢ã€è¿½åŠ ã€åˆå¹¶ç­‰ï¼‰ï¼Œè¿™ç§è®¾è®¡è®©çŠ¶æ€ç®¡ç†å˜å¾—éå¸¸çµæ´»ï¼Œèƒ½å¤Ÿé€‚åº”å„ç§å¤æ‚çš„ä¸šåŠ¡åœºæ™¯ã€‚</p>
<h4 id="321-çŠ¶æ€ç®¡ç†æ¶æ„">3.2.1 çŠ¶æ€ç®¡ç†æ¶æ„
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">classDiagram
</span></span><span class="line"><span class="cl">    class OverAllState {
</span></span><span class="line"><span class="cl">        -Map~String,Object~ data
</span></span><span class="line"><span class="cl">        -Map~String,KeyStrategy~ keyStrategies
</span></span><span class="line"><span class="cl">        -Boolean resume
</span></span><span class="line"><span class="cl">        -HumanFeedback humanFeedback
</span></span><span class="line"><span class="cl">        -String interruptMessage
</span></span><span class="line"><span class="cl">        +value(String key) Optional~Object~
</span></span><span class="line"><span class="cl">        +updateState(Map updates)
</span></span><span class="line"><span class="cl">        +registerKeyAndStrategy(String key, KeyStrategy strategy)
</span></span><span class="line"><span class="cl">        +snapShot() Optional~OverAllState~
</span></span><span class="line"><span class="cl">        +withResume()
</span></span><span class="line"><span class="cl">        +withHumanFeedback(HumanFeedback feedback)
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class KeyStrategy {
</span></span><span class="line"><span class="cl">        &lt;&lt;interface&gt;&gt;
</span></span><span class="line"><span class="cl">        +apply(Object oldValue, Object newValue) Object
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class ReplaceStrategy {
</span></span><span class="line"><span class="cl">        +apply(Object oldValue, Object newValue) Object
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class AppendStrategy {
</span></span><span class="line"><span class="cl">        +apply(Object oldValue, Object newValue) Object
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class HumanFeedback {
</span></span><span class="line"><span class="cl">        +boolean approved
</span></span><span class="line"><span class="cl">        +String feedback
</span></span><span class="line"><span class="cl">        +Map~String,Object~ additionalData
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    OverAllState --&gt; KeyStrategy
</span></span><span class="line"><span class="cl">    OverAllState --&gt; HumanFeedback
</span></span><span class="line"><span class="cl">    KeyStrategy &lt;|-- ReplaceStrategy
</span></span><span class="line"><span class="cl">    KeyStrategy &lt;|-- AppendStrategy
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="322-çŠ¶æ€æ›´æ–°æµç¨‹">3.2.2 çŠ¶æ€æ›´æ–°æµç¨‹
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sequenceDiagram
</span></span><span class="line"><span class="cl">    participant Node as èŠ‚ç‚¹
</span></span><span class="line"><span class="cl">    participant State as OverAllState
</span></span><span class="line"><span class="cl">    participant Strategy as KeyStrategy
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    Node-&gt;&gt;State: è¿”å›æ›´æ–°Map
</span></span><span class="line"><span class="cl">    State-&gt;&gt;State: updateState(updates)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    loop éå†æ¯ä¸ªæ›´æ–°é¡¹
</span></span><span class="line"><span class="cl">        State-&gt;&gt;State: è·å–keyå¯¹åº”çš„ç­–ç•¥
</span></span><span class="line"><span class="cl">        State-&gt;&gt;Strategy: apply(oldValue, newValue)
</span></span><span class="line"><span class="cl">        Strategy--&gt;&gt;State: è¿”å›åˆå¹¶åçš„å€¼
</span></span><span class="line"><span class="cl">        State-&gt;&gt;State: æ›´æ–°dataä¸­çš„å€¼
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    State--&gt;&gt;Node: çŠ¶æ€æ›´æ–°å®Œæˆ
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="323-çŠ¶æ€ç­–ç•¥è¯¦è§£">3.2.3 çŠ¶æ€ç­–ç•¥è¯¦è§£
</h4><p><strong>ç­–ç•¥æ¨¡å¼æ¶æ„</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">classDiagram
</span></span><span class="line"><span class="cl">    class KeyStrategy {
</span></span><span class="line"><span class="cl">        &lt;&lt;interface&gt;&gt;
</span></span><span class="line"><span class="cl">        +apply(Object oldValue, Object newValue) Object
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class ReplaceStrategy {
</span></span><span class="line"><span class="cl">        +apply(Object oldValue, Object newValue) Object
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class AppendStrategy {
</span></span><span class="line"><span class="cl">        +apply(Object oldValue, Object newValue) Object
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    KeyStrategy &lt;|-- ReplaceStrategy
</span></span><span class="line"><span class="cl">    KeyStrategy &lt;|-- AppendStrategy
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å†…ç½®ç­–ç•¥å®ç°</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// æ›¿æ¢ç­–ç•¥ - æ–°å€¼è¦†ç›–æ—§å€¼</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ReplaceStrategy</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">oldValue</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">newValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">newValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// è¿½åŠ ç­–ç•¥ - æ–°å€¼è¿½åŠ åˆ°åˆ—è¡¨ï¼Œæ”¯æŒå¤æ‚çš„åˆ—è¡¨æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AppendStrategy</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">oldValue</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">newValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newValue</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">oldValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// å¤„ç†Optionalç±»å‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldValue</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">oldValueOptional</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">oldValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldValueOptional</span><span class="p">.</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">oldValueIsList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldValue</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;?&gt;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// å¤„ç†ç§»é™¤æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldValueIsList</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">newValue</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">AppenderChannel</span><span class="p">.</span><span class="na">RemoveIdentifier</span><span class="o">&lt;?&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">((</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">oldValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">removeFromList</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">AppenderChannel</span><span class="p">.</span><span class="na">RemoveIdentifier</span><span class="p">)</span><span class="w"> </span><span class="n">newValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">unmodifiableList</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// å¤„ç†æ–°å€¼ä¸ºé›†åˆçš„æƒ…å†µ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newValue</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">List</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">((</span><span class="n">List</span><span class="o">&lt;?&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">newValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newValue</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">isArray</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">((</span><span class="n">Object</span><span class="o">[]</span><span class="p">)</span><span class="w"> </span><span class="n">newValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newValue</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">Collection</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">((</span><span class="n">Collection</span><span class="o">&lt;?&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">newValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// åˆå¹¶é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldValueIsList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">oldList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">oldValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">oldValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// åˆå¹¶å¹¶å»é‡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">evaluateRemoval</span><span class="p">(</span><span class="n">oldList</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">Stream</span><span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">oldValues</span><span class="p">().</span><span class="na">stream</span><span class="p">(),</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">newValues</span><span class="p">().</span><span class="na">stream</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">distinct</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">oldList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">newValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">oldList</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arrayResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">arrayResult</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">list</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">arrayResult</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">newValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">arrayResult</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>è‡ªå®šä¹‰ç­–ç•¥ç¤ºä¾‹</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// è‡ªå®šä¹‰Mapåˆå¹¶ç­–ç•¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MapMergeStrategy</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">oldValue</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">newValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldValue</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">Map</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">newValue</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">Map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">merged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">((</span><span class="n">Map</span><span class="p">)</span><span class="w"> </span><span class="n">oldValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">merged</span><span class="p">.</span><span class="na">putAll</span><span class="p">((</span><span class="n">Map</span><span class="p">)</span><span class="w"> </span><span class="n">newValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">merged</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">newValue</span><span class="p">;</span><span class="w"> </span><span class="c1">// é»˜è®¤æ›¿æ¢</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// è‡ªå®šä¹‰å­—ç¬¦ä¸²è¿æ¥ç­–ç•¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StringConcatStrategy</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">separator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">StringConcatStrategy</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">separator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">separator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">separator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">oldValue</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">newValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldValue</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">newValue</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">oldValue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">separator</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">newValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">newValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ç­–ç•¥å·¥å‚æ¨¡å¼</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StrategyFactory</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">KeyStrategyFactory</span><span class="w"> </span><span class="nf">createDefaultFactory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">strategies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;messages&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppendStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;output&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">strategies</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">KeyStrategyFactory</span><span class="w"> </span><span class="nf">createCustomFactory</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">customStrategies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">strategies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// æ·»åŠ é»˜è®¤ç­–ç•¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;messages&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppendStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// è¦†ç›–è‡ªå®šä¹‰ç­–ç•¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">putAll</span><span class="p">(</span><span class="n">customStrategies</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">strategies</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="33-node-èŠ‚ç‚¹">3.3 Node (èŠ‚ç‚¹)
</h3><p><strong>Nodeæ˜¯å·¥ä½œæµçš„åŠŸèƒ½æ¨¡å—</strong>ï¼Œæ¯ä¸ªèŠ‚ç‚¹å°±åƒä¸€ä¸ªä¸“é—¨çš„å·¥ä½œç«™ï¼Œè´Ÿè´£æ‰§è¡Œç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘ã€‚Nodeçš„è®¾è®¡éµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªå…³æ³¨ä¸€ä»¶äº‹æƒ…ï¼Œè¿™æ ·æ—¢ä¿è¯äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼Œä¹Ÿæé«˜äº†èŠ‚ç‚¹çš„å¯å¤ç”¨æ€§ã€‚</p>
<p><strong>æ‰§è¡Œç‰¹æ€§</strong>ï¼šNodeæ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ‰§è¡Œæ¨¡å¼ï¼Œè¿˜æ”¯æŒå¹¶è¡Œæ‰§è¡Œå¤šä¸ªå­ä»»åŠ¡ã€‚è¿™ç§çµæ´»çš„æ‰§è¡Œæœºåˆ¶è®©Nodeæ—¢èƒ½å¤„ç†ç®€å•çš„æ•°æ®è½¬æ¢ï¼Œä¹Ÿèƒ½å¤„ç†å¤æ‚çš„å¤–éƒ¨æœåŠ¡è°ƒç”¨ï¼Œæ»¡è¶³å„ç§æ€§èƒ½è¦æ±‚ã€‚</p>
<h4 id="331-èŠ‚ç‚¹æ‰§è¡Œæµç¨‹">3.3.1 èŠ‚ç‚¹æ‰§è¡Œæµç¨‹
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart TD
</span></span><span class="line"><span class="cl">    A[èŠ‚ç‚¹å¼€å§‹æ‰§è¡Œ] --&gt; B[è·å–ActionFactory]
</span></span><span class="line"><span class="cl">    B --&gt; C[åº”ç”¨CompileConfig]
</span></span><span class="line"><span class="cl">    C --&gt; D[åˆ›å»ºAsyncNodeActionWithConfig]
</span></span><span class="line"><span class="cl">    D --&gt; E[è°ƒç”¨applyæ–¹æ³•]
</span></span><span class="line"><span class="cl">    E --&gt; F[ä¼ å…¥OverAllStateå’ŒRunnableConfig]
</span></span><span class="line"><span class="cl">    F --&gt; G[æ‰§è¡Œä¸šåŠ¡é€»è¾‘]
</span></span><span class="line"><span class="cl">    G --&gt; H[è¿”å›CompletableFuture]
</span></span><span class="line"><span class="cl">    H --&gt; I{æ˜¯å¦åŒ…å«AsyncGenerator?}
</span></span><span class="line"><span class="cl">    I --&gt;|æ˜¯| J[å¤„ç†æµå¼è¾“å‡º]
</span></span><span class="line"><span class="cl">    I --&gt;|å¦| K[ç›´æ¥è¿”å›ç»“æœ]
</span></span><span class="line"><span class="cl">    J --&gt; L[çŠ¶æ€æ›´æ–°]
</span></span><span class="line"><span class="cl">    K --&gt; L
</span></span><span class="line"><span class="cl">    L --&gt; M[èŠ‚ç‚¹æ‰§è¡Œå®Œæˆ]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;èŠ‚ç‚¹ç±»å‹&#34;
</span></span><span class="line"><span class="cl">        N1[LlmNode&lt;br/&gt;å¤§æ¨¡å‹è°ƒç”¨]
</span></span><span class="line"><span class="cl">        N2[ToolNode&lt;br/&gt;å·¥å…·è°ƒç”¨]
</span></span><span class="line"><span class="cl">        N3[QuestionClassifierNode&lt;br/&gt;æ–‡æœ¬åˆ†ç±»]
</span></span><span class="line"><span class="cl">        N4[ParallelNode&lt;br/&gt;å¹¶è¡Œæ‰§è¡Œ]
</span></span><span class="line"><span class="cl">        N5[SubGraphNode&lt;br/&gt;å­å›¾èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    D --&gt; N1
</span></span><span class="line"><span class="cl">    D --&gt; N2
</span></span><span class="line"><span class="cl">    D --&gt; N3
</span></span><span class="line"><span class="cl">    D --&gt; N4
</span></span><span class="line"><span class="cl">    D --&gt; N5
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="332-èŠ‚ç‚¹ç±»å‹å±‚æ¬¡ç»“æ„">3.3.2 èŠ‚ç‚¹ç±»å‹å±‚æ¬¡ç»“æ„
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">classDiagram
</span></span><span class="line"><span class="cl">    class Node {
</span></span><span class="line"><span class="cl">        +String id
</span></span><span class="line"><span class="cl">        +ActionFactory actionFactory
</span></span><span class="line"><span class="cl">        +apply(CompileConfig config) AsyncNodeActionWithConfig
</span></span><span class="line"><span class="cl">        +isParallel() boolean
</span></span><span class="line"><span class="cl">        +withIdUpdated(Function newId) Node
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class ParallelNode {
</span></span><span class="line"><span class="cl">        +String PARALLEL_PREFIX
</span></span><span class="line"><span class="cl">        +List~AsyncNodeActionWithConfig~ actions
</span></span><span class="line"><span class="cl">        +Map~String,KeyStrategy~ channels
</span></span><span class="line"><span class="cl">        +isParallel() boolean
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class SubStateGraphNode {
</span></span><span class="line"><span class="cl">        +String id
</span></span><span class="line"><span class="cl">        +StateGraph subGraph
</span></span><span class="line"><span class="cl">        +formatId(String nodeId) String
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class SubCompiledGraphNode {
</span></span><span class="line"><span class="cl">        +String id
</span></span><span class="line"><span class="cl">        +CompiledGraph subGraph
</span></span><span class="line"><span class="cl">        +formatId(String nodeId) String
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class CommandNode {
</span></span><span class="line"><span class="cl">        +String id
</span></span><span class="line"><span class="cl">        +AsyncCommandAction action
</span></span><span class="line"><span class="cl">        +Map~String,String~ mappings
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    Node &lt;|-- ParallelNode
</span></span><span class="line"><span class="cl">    Node &lt;|-- SubStateGraphNode
</span></span><span class="line"><span class="cl">    Node &lt;|-- SubCompiledGraphNode
</span></span><span class="line"><span class="cl">    Node &lt;|-- CommandNode
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="333-å¹¶è¡ŒèŠ‚ç‚¹å¤„ç†æœºåˆ¶">3.3.3 å¹¶è¡ŒèŠ‚ç‚¹å¤„ç†æœºåˆ¶
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sequenceDiagram
</span></span><span class="line"><span class="cl">    participant PNode as ParallelNode
</span></span><span class="line"><span class="cl">    participant Action1 as Action1
</span></span><span class="line"><span class="cl">    participant Action2 as Action2
</span></span><span class="line"><span class="cl">    participant Action3 as Action3
</span></span><span class="line"><span class="cl">    participant CF as CompletableFuture
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    PNode-&gt;&gt;Action1: apply(state, config)
</span></span><span class="line"><span class="cl">    PNode-&gt;&gt;Action2: apply(state, config)
</span></span><span class="line"><span class="cl">    PNode-&gt;&gt;Action3: apply(state, config)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    Action1--&gt;&gt;CF: CompletableFuture1
</span></span><span class="line"><span class="cl">    Action2--&gt;&gt;CF: CompletableFuture2
</span></span><span class="line"><span class="cl">    Action3--&gt;&gt;CF: CompletableFuture3
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    CF-&gt;&gt;CF: CompletableFuture.allOf()
</span></span><span class="line"><span class="cl">    CF-&gt;&gt;PNode: æ‰€æœ‰ä»»åŠ¡å®Œæˆ
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    PNode-&gt;&gt;PNode: åˆå¹¶ç»“æœ
</span></span><span class="line"><span class="cl">    PNode--&gt;&gt;PNode: è¿”å›åˆå¹¶åçš„çŠ¶æ€
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="34-edge-è¾¹">3.4 Edge (è¾¹)
</h3><p><strong>Edgeæ˜¯å·¥ä½œæµçš„è·¯ç”±å™¨</strong>ï¼Œå®ƒå†³å®šäº†æ•°æ®åœ¨èŠ‚ç‚¹ä¹‹é—´çš„æµè½¬è·¯å¾„ã€‚Edgeä¸ä»…ä»…æ˜¯ç®€å•çš„è¿æ¥çº¿ï¼Œå®ƒè¿˜åŒ…å«äº†å¤æ‚çš„æ¡ä»¶åˆ¤æ–­é€»è¾‘ï¼Œèƒ½å¤Ÿæ ¹æ®å½“å‰çŠ¶æ€åŠ¨æ€å†³å®šä¸‹ä¸€æ­¥çš„æ‰§è¡Œè·¯å¾„ã€‚</p>
<p><strong>æ™ºèƒ½è·¯ç”±</strong>ï¼šEdgeæ”¯æŒé™æ€è·¯ç”±å’ŒåŠ¨æ€è·¯ç”±ä¸¤ç§æ¨¡å¼ã€‚é™æ€è¾¹æä¾›å›ºå®šçš„è½¬æ¢è·¯å¾„ï¼Œè€Œæ¡ä»¶è¾¹åˆ™å¯ä»¥æ ¹æ®çŠ¶æ€å†…å®¹è¿›è¡Œæ™ºèƒ½åˆ¤æ–­ï¼Œè¿™ç§è®¾è®¡è®©å·¥ä½œæµå…·å¤‡äº†å¼ºå¤§çš„æ¡ä»¶åˆ†æ”¯èƒ½åŠ›ï¼Œèƒ½å¤Ÿå¤„ç†å„ç§å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>
<h4 id="341-è¾¹çš„ç±»å‹ä¸ç»“æ„">3.4.1 è¾¹çš„ç±»å‹ä¸ç»“æ„
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">classDiagram
</span></span><span class="line"><span class="cl">    class Edge {
</span></span><span class="line"><span class="cl">        +String sourceId
</span></span><span class="line"><span class="cl">        +EdgeValue targetValue
</span></span><span class="line"><span class="cl">        +validate(Nodes nodes)
</span></span><span class="line"><span class="cl">        +List~EdgeValue~ targets()
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class EdgeValue {
</span></span><span class="line"><span class="cl">        &lt;&lt;sealed interface&gt;&gt;
</span></span><span class="line"><span class="cl">        +String id()
</span></span><span class="line"><span class="cl">        +EdgeCondition value()
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class EdgeValue_Const {
</span></span><span class="line"><span class="cl">        +String value
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class EdgeValue_Condition {
</span></span><span class="line"><span class="cl">        +EdgeCondition condition
</span></span><span class="line"><span class="cl">        +Map~String,String~ mappings
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    class EdgeCondition {
</span></span><span class="line"><span class="cl">        +AsyncCommandAction action
</span></span><span class="line"><span class="cl">        +Map~String,String~ mappings
</span></span><span class="line"><span class="cl">        +apply(OverAllState state, RunnableConfig config) CompletableFuture~Command~
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    Edge --&gt; EdgeValue
</span></span><span class="line"><span class="cl">    EdgeValue &lt;|-- EdgeValue_Const
</span></span><span class="line"><span class="cl">    EdgeValue &lt;|-- EdgeValue_Condition
</span></span><span class="line"><span class="cl">    EdgeValue_Condition --&gt; EdgeCondition
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="342-æ¡ä»¶è¾¹è·¯ç”±æµç¨‹">3.4.2 æ¡ä»¶è¾¹è·¯ç”±æµç¨‹
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart TD
</span></span><span class="line"><span class="cl">    A[åˆ°è¾¾æ¡ä»¶è¾¹] --&gt; B[è·å–EdgeCondition]
</span></span><span class="line"><span class="cl">    B --&gt; C[æ‰§è¡Œcondition.apply]
</span></span><span class="line"><span class="cl">    C --&gt; D[è·å–Commandç»“æœ]
</span></span><span class="line"><span class="cl">    D --&gt; E[æå–gotoNodeå€¼]
</span></span><span class="line"><span class="cl">    E --&gt; F[åœ¨mappingsä¸­æŸ¥æ‰¾]
</span></span><span class="line"><span class="cl">    F --&gt; G{æ‰¾åˆ°æ˜ å°„?}
</span></span><span class="line"><span class="cl">    G --&gt;|æ˜¯| H[è¿”å›ç›®æ ‡èŠ‚ç‚¹ID]
</span></span><span class="line"><span class="cl">    G --&gt;|å¦| I[æŠ›å‡ºæ˜ å°„ç¼ºå¤±å¼‚å¸¸]
</span></span><span class="line"><span class="cl">    H --&gt; J[è·³è½¬åˆ°ç›®æ ‡èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;æ¡ä»¶è¯„ä¼°ç¤ºä¾‹&#34;
</span></span><span class="line"><span class="cl">        K[FeedbackQuestionDispatcher]
</span></span><span class="line"><span class="cl">        K --&gt; L[åˆ†æclassifier_output]
</span></span><span class="line"><span class="cl">        L --&gt; M{åŒ…å«positive?}
</span></span><span class="line"><span class="cl">        M --&gt;|æ˜¯| N[è¿”å›positive]
</span></span><span class="line"><span class="cl">        M --&gt;|å¦| O[è¿”å›negative]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    C --&gt; K
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="343-è¾¹éªŒè¯æœºåˆ¶">3.4.3 è¾¹éªŒè¯æœºåˆ¶
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Edge</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="n">Nodes</span><span class="w"> </span><span class="n">nodes</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">GraphStateException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// éªŒè¯æºèŠ‚ç‚¹å­˜åœ¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">nodes</span><span class="p">.</span><span class="na">anyMatchById</span><span class="p">(</span><span class="n">sourceId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">Errors</span><span class="p">.</span><span class="na">missingNodeInEdgeMapping</span><span class="p">.</span><span class="na">exception</span><span class="p">(</span><span class="n">sourceId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// éªŒè¯ç›®æ ‡èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">EdgeValue</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">targets</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="na">id</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// é™æ€è¾¹ï¼šç›´æ¥éªŒè¯ç›®æ ‡èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">nodes</span><span class="p">.</span><span class="na">anyMatchById</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="na">id</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">END</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="na">id</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="n">Errors</span><span class="p">.</span><span class="na">missingNodeInEdgeMapping</span><span class="p">.</span><span class="na">exception</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="na">id</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="na">value</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// æ¡ä»¶è¾¹ï¼šéªŒè¯æ˜ å°„ä¸­çš„æ‰€æœ‰ç›®æ ‡èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">targetNodeId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="na">value</span><span class="p">().</span><span class="na">mappings</span><span class="p">().</span><span class="na">values</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">nodes</span><span class="p">.</span><span class="na">anyMatchById</span><span class="p">(</span><span class="n">targetNodeId</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">END</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">targetNodeId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">throw</span><span class="w"> </span><span class="n">Errors</span><span class="p">.</span><span class="na">missingNodeInEdgeMapping</span><span class="p">.</span><span class="na">exception</span><span class="p">(</span><span class="n">targetNodeId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="35-compiledgraph-ç¼–è¯‘å›¾">3.5 CompiledGraph (ç¼–è¯‘å›¾)
</h3><p><strong>CompiledGraphæ˜¯å·¥ä½œæµçš„æ‰§è¡Œå¼•æ“</strong>ï¼Œå®ƒå°†StateGraphçš„é™æ€å®šä¹‰è½¬æ¢ä¸ºé«˜æ•ˆçš„è¿è¡Œæ—¶ä»£ç ã€‚å°±åƒå°†é«˜çº§è¯­è¨€ç¼–è¯‘æˆæœºå™¨ç ä¸€æ ·ï¼ŒCompiledGraphå¯¹å·¥ä½œæµè¿›è¡Œäº†å„ç§ä¼˜åŒ–ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹é¢„å¤„ç†ã€è¾¹è·¯ç”±ä¼˜åŒ–ã€çŠ¶æ€ç®¡ç†ç­–ç•¥ç­‰ã€‚</p>
<p><strong>è¿è¡Œæ—¶ä¼˜åŒ–</strong>ï¼šCompiledGraphåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šè¿›è¡Œå¤šç§ä¼˜åŒ–ï¼Œå¦‚èŠ‚ç‚¹ä¾èµ–åˆ†æã€å¹¶è¡Œæ‰§è¡Œè§„åˆ’ã€çŠ¶æ€è®¿é—®ä¼˜åŒ–ç­‰ï¼Œè¿™äº›ä¼˜åŒ–ç¡®ä¿äº†å·¥ä½œæµåœ¨è¿è¡Œæ—¶çš„é«˜æ•ˆæ€§å’Œç¨³å®šæ€§ã€‚</p>
<h4 id="351-ç¼–è¯‘è¿‡ç¨‹è¯¦è§£">3.5.1 ç¼–è¯‘è¿‡ç¨‹è¯¦è§£
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart TD
</span></span><span class="line"><span class="cl">    A[StateGraph.compile] --&gt; B[åˆ›å»ºCompiledGraph]
</span></span><span class="line"><span class="cl">    B --&gt; C[å¤„ç†èŠ‚ç‚¹å’Œè¾¹]
</span></span><span class="line"><span class="cl">    C --&gt; D[æ£€æŸ¥ä¸­æ–­é…ç½®]
</span></span><span class="line"><span class="cl">    D --&gt; E[åˆ›å»ºèŠ‚ç‚¹æ˜ å°„]
</span></span><span class="line"><span class="cl">    E --&gt; F[åˆ›å»ºè¾¹æ˜ å°„]
</span></span><span class="line"><span class="cl">    F --&gt; G[å¤„ç†å­å›¾èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">    G --&gt; H[ç”Ÿæˆæœ€ç»ˆCompiledGraph]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;ProcessedNodesEdgesAndConfig&#34;
</span></span><span class="line"><span class="cl">        I[å¤„ç†æ™®é€šèŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">        J[å¤„ç†å­å›¾èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">        K[å¤„ç†å¹¶è¡ŒèŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">        L[å¤„ç†ä¸­æ–­é…ç½®]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    C --&gt; I
</span></span><span class="line"><span class="cl">    C --&gt; J
</span></span><span class="line"><span class="cl">    C --&gt; K
</span></span><span class="line"><span class="cl">    C --&gt; L
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="352-asyncnodegeneratoræ‰§è¡Œæœºåˆ¶">3.5.2 AsyncNodeGeneratoræ‰§è¡Œæœºåˆ¶
</h4><p><strong>AsyncNodeGeneratoræ˜¯å·¥ä½œæµæ‰§è¡Œçš„æ ¸å¿ƒçŠ¶æ€æœº</strong>ï¼Œå®ƒè´Ÿè´£æ¨åŠ¨æ•´ä¸ªå·¥ä½œæµçš„è¿è¡Œã€‚AsyncNodeGeneratoré‡‡ç”¨äº†åŸºäºè¿­ä»£å™¨çš„è®¾è®¡æ¨¡å¼ï¼Œæ¯æ¬¡è°ƒç”¨next()æ–¹æ³•éƒ½ä¼šæ‰§è¡Œä¸€ä¸ªæ­¥éª¤ï¼Œè¿™ç§è®¾è®¡æ—¢æ”¯æŒåŒæ­¥æ‰§è¡Œï¼Œä¹Ÿæ”¯æŒå¼‚æ­¥æµå¼å¤„ç†ã€‚</p>
<p><strong>æ‰§è¡Œæ§åˆ¶</strong>ï¼šAsyncNodeGeneratorå†…ç½®äº†å®Œå–„çš„æ‰§è¡Œæ§åˆ¶æœºåˆ¶ï¼ŒåŒ…æ‹¬æœ€å¤§è¿­ä»£æ¬¡æ•°æ£€æŸ¥ã€ä¸­æ–­æ¡ä»¶å¤„ç†ã€é”™è¯¯æ¢å¤ç­‰ï¼Œç¡®ä¿å·¥ä½œæµåœ¨å„ç§æƒ…å†µä¸‹éƒ½èƒ½ç¨³å®šè¿è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">stateDiagram-v2
</span></span><span class="line"><span class="cl">    [*] --&gt; Initializing: åˆ›å»ºAsyncNodeGenerator
</span></span><span class="line"><span class="cl">    Initializing --&gt; CheckingResume: æ£€æŸ¥æ˜¯å¦æ¢å¤æ¨¡å¼
</span></span><span class="line"><span class="cl">    CheckingResume --&gt; Resuming: æ¢å¤æ¨¡å¼
</span></span><span class="line"><span class="cl">    CheckingResume --&gt; Starting: æ­£å¸¸å¯åŠ¨
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    Resuming --&gt; LoadingCheckpoint: åŠ è½½æ£€æŸ¥ç‚¹
</span></span><span class="line"><span class="cl">    LoadingCheckpoint --&gt; RestoringState: æ¢å¤çŠ¶æ€
</span></span><span class="line"><span class="cl">    RestoringState --&gt; Ready: å‡†å¤‡æ‰§è¡Œ
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    Starting --&gt; InitializingState: åˆå§‹åŒ–çŠ¶æ€
</span></span><span class="line"><span class="cl">    InitializingState --&gt; Ready: å‡†å¤‡æ‰§è¡Œ
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    Ready --&gt; Executing: å¼€å§‹æ‰§è¡Œ
</span></span><span class="line"><span class="cl">    Executing --&gt; CheckingIteration: æ£€æŸ¥è¿­ä»£æ¬¡æ•°
</span></span><span class="line"><span class="cl">    CheckingIteration --&gt; MaxIterationReached: è¾¾åˆ°æœ€å¤§è¿­ä»£
</span></span><span class="line"><span class="cl">    CheckingIteration --&gt; CheckingInterrupt: æ£€æŸ¥ä¸­æ–­
</span></span><span class="line"><span class="cl">    CheckingInterrupt --&gt; Interrupted: ä¸­æ–­æ‰§è¡Œ
</span></span><span class="line"><span class="cl">    CheckingInterrupt --&gt; ExecutingNode: æ‰§è¡ŒèŠ‚ç‚¹
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    ExecutingNode --&gt; UpdatingState: æ›´æ–°çŠ¶æ€
</span></span><span class="line"><span class="cl">    UpdatingState --&gt; SavingCheckpoint: ä¿å­˜æ£€æŸ¥ç‚¹
</span></span><span class="line"><span class="cl">    SavingCheckpoint --&gt; DeterminingNext: ç¡®å®šä¸‹ä¸€èŠ‚ç‚¹
</span></span><span class="line"><span class="cl">    DeterminingNext --&gt; CheckingEnd: æ£€æŸ¥æ˜¯å¦ç»“æŸ
</span></span><span class="line"><span class="cl">    CheckingEnd --&gt; Completed: æ‰§è¡Œå®Œæˆ
</span></span><span class="line"><span class="cl">    CheckingEnd --&gt; Executing: ç»§ç»­æ‰§è¡Œ
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    MaxIterationReached --&gt; [*]
</span></span><span class="line"><span class="cl">    Interrupted --&gt; [*]
</span></span><span class="line"><span class="cl">    Completed --&gt; [*]
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="353-çŠ¶æ€æµè½¬æ ¸å¿ƒé€»è¾‘">3.5.3 çŠ¶æ€æµè½¬æ ¸å¿ƒé€»è¾‘
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AsyncNodeGenerator</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">NodeOutput</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">AsyncGenerator</span><span class="o">&lt;</span><span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Data</span><span class="o">&lt;</span><span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 1. æ£€æŸ¥æœ€å¤§è¿­ä»£æ¬¡æ•°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">iteration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxIterations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">format</span><span class="p">(</span><span class="s">&#34;Maximum number of iterations (%d) reached!&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">maxIterations</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 2. æ£€æŸ¥æ˜¯å¦ç»“æŸ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextNodeId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">currentNodeId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">releaseThread</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">Data</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Output</span><span class="o">&gt;</span><span class="n">done</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="na">done</span><span class="p">(</span><span class="n">currentState</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 3. å¤„ç†STARTèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">START</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">currentNodeId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">doListeners</span><span class="p">(</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="n">nextNodeCommand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getEntryPoint</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">nextNodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextNodeCommand</span><span class="p">.</span><span class="na">gotoNode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">currentState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextNodeCommand</span><span class="p">.</span><span class="na">update</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addCheckpoint</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="n">currentState</span><span class="p">,</span><span class="w"> </span><span class="n">nextNodeId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="na">isPresent</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">streamMode</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">StreamMode</span><span class="p">.</span><span class="na">SNAPSHOTS</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="o">?</span><span class="w"> </span><span class="n">buildStateSnapshot</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="na">get</span><span class="p">())</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">buildNodeOutput</span><span class="p">(</span><span class="n">currentNodeId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">currentNodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextNodeId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">output</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 4. å¤„ç†ENDèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">END</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">nextNodeId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">nextNodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">currentNodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">doListeners</span><span class="p">(</span><span class="n">END</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">buildNodeOutput</span><span class="p">(</span><span class="n">END</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 5. æ£€æŸ¥ä¸­æ–­æ¡ä»¶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldInterruptAfter</span><span class="p">(</span><span class="n">currentNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">nextNodeId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="na">done</span><span class="p">(</span><span class="n">currentNodeId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldInterruptBefore</span><span class="p">(</span><span class="n">nextNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">currentNodeId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="na">done</span><span class="p">(</span><span class="n">currentNodeId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 6. æ‰§è¡ŒèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">currentNodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextNodeId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">currentNodeId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">evaluateAction</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">overAllState</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-é¢„å®šä¹‰ç»„ä»¶ä¸å·¥å…·ç®±">4. é¢„å®šä¹‰ç»„ä»¶ä¸å·¥å…·ç®±
</h2><h3 id="41-é¢„å®šä¹‰èŠ‚ç‚¹ç±»å‹">4.1 é¢„å®šä¹‰èŠ‚ç‚¹ç±»å‹
</h3><p><strong>Spring AI Alibaba Graphæä¾›äº†ä¸°å¯Œçš„é¢„å®šä¹‰èŠ‚ç‚¹å·¥å…·ç®±</strong>ï¼Œè¿™äº›èŠ‚ç‚¹å°±åƒä¹é«˜ç§¯æœ¨ä¸€æ ·ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ç»„åˆè¿™äº›é¢„å®šä¹‰èŠ‚ç‚¹å¿«é€Ÿæ„å»ºå¤æ‚çš„AIåº”ç”¨ã€‚æ¯ä¸ªé¢„å®šä¹‰èŠ‚ç‚¹éƒ½ç»è¿‡äº†ç²¾å¿ƒè®¾è®¡å’Œä¼˜åŒ–ï¼Œä¸ä»…åŠŸèƒ½å¼ºå¤§ï¼Œè€Œä¸”æ˜“äºä½¿ç”¨ã€‚</p>
<p><strong>è®¾è®¡ç†å¿µ</strong>ï¼šé¢„å®šä¹‰èŠ‚ç‚¹çš„è®¾è®¡éµå¾ªäº†&quot;å¼€ç®±å³ç”¨&quot;çš„åŸåˆ™ï¼Œå¼€å‘è€…åªéœ€è¦æä¾›å¿…è¦çš„é…ç½®å‚æ•°ï¼Œå°±èƒ½ç«‹å³ä½¿ç”¨è¿™äº›èŠ‚ç‚¹çš„å¼ºå¤§åŠŸèƒ½ï¼Œå¤§å¤§é™ä½äº†AIåº”ç”¨çš„å¼€å‘é—¨æ§›ã€‚</p>
<h4 id="411-èŠ‚ç‚¹åˆ†ç±»æ¶æ„">4.1.1 èŠ‚ç‚¹åˆ†ç±»æ¶æ„
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">graph TB
</span></span><span class="line"><span class="cl">    subgraph &#34;é¢„å®šä¹‰èŠ‚ç‚¹ä½“ç³»&#34;
</span></span><span class="line"><span class="cl">        A[NodeActionæ¥å£]
</span></span><span class="line"><span class="cl">        A --&gt; B[LlmNode&lt;br/&gt;å¤§æ¨¡å‹èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">        A --&gt; C[ToolNode&lt;br/&gt;å·¥å…·èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">        A --&gt; D[QuestionClassifierNode&lt;br/&gt;åˆ†ç±»èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">        A --&gt; E[KnowledgeRetrievalNode&lt;br/&gt;æ£€ç´¢èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">        A --&gt; F[ParameterParsingNode&lt;br/&gt;å‚æ•°è§£æèŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">        A --&gt; G[McpNode&lt;br/&gt;MCPåè®®èŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">        A --&gt; H[AnswerNode&lt;br/&gt;ç­”æ¡ˆç”ŸæˆèŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">        A --&gt; I[ListOperatorNode&lt;br/&gt;åˆ—è¡¨æ“ä½œèŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">        A --&gt; J[CodeExecutorNode&lt;br/&gt;ä»£ç æ‰§è¡ŒèŠ‚ç‚¹]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;èŠ‚ç‚¹ç‰¹æ€§&#34;
</span></span><span class="line"><span class="cl">        K[Builderæ¨¡å¼æ„å»º]
</span></span><span class="line"><span class="cl">        L[çŠ¶æ€é©±åŠ¨]
</span></span><span class="line"><span class="cl">        M[å¼‚æ­¥æ”¯æŒ]
</span></span><span class="line"><span class="cl">        N[æµå¼å¤„ç†]
</span></span><span class="line"><span class="cl">        O[é”™è¯¯å¤„ç†]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    B --&gt; K
</span></span><span class="line"><span class="cl">    C --&gt; L
</span></span><span class="line"><span class="cl">    D --&gt; M
</span></span><span class="line"><span class="cl">    E --&gt; N
</span></span><span class="line"><span class="cl">    F --&gt; O
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="412-questionclassifiernode---æ™ºèƒ½åˆ†ç±»èŠ‚ç‚¹">4.1.2 QuestionClassifierNode - æ™ºèƒ½åˆ†ç±»èŠ‚ç‚¹
</h4><p><strong>QuestionClassifierNodeæ˜¯å·¥ä½œæµçš„æ™ºèƒ½åˆ†æ‹£å‘˜</strong>ï¼Œå®ƒèƒ½å¤Ÿç†è§£æ–‡æœ¬å†…å®¹å¹¶å°†å…¶å½’ç±»åˆ°é¢„å®šä¹‰çš„ç±»åˆ«ä¸­ã€‚è¿™ä¸ªèŠ‚ç‚¹å†…ç½®äº†å°‘æ ·æœ¬å­¦ä¹ æœºåˆ¶ï¼Œå³ä½¿æ²¡æœ‰å¤§é‡è®­ç»ƒæ•°æ®ï¼Œä¹Ÿèƒ½å®ç°å‡†ç¡®çš„åˆ†ç±»æ•ˆæœã€‚</p>
<p><strong>æ ¸å¿ƒä¼˜åŠ¿</strong>ï¼šQuestionClassifierNodeé‡‡ç”¨äº†æç¤ºå·¥ç¨‹çš„æœ€ä½³å®è·µï¼Œé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æç¤ºè¯æ¨¡æ¿å’Œå°‘æ ·æœ¬ç¤ºä¾‹ï¼Œè®©å¤§è¯­è¨€æ¨¡å‹èƒ½å¤Ÿå‡†ç¡®ç†è§£åˆ†ç±»ä»»åŠ¡çš„è¦æ±‚ï¼Œå®ç°é«˜è´¨é‡çš„æ–‡æœ¬åˆ†ç±»ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart TD
</span></span><span class="line"><span class="cl">    A[QuestionClassifierNodeæ‰§è¡Œ] --&gt; B[ä»çŠ¶æ€è·å–è¾“å…¥æ–‡æœ¬]
</span></span><span class="line"><span class="cl">    B --&gt; C[æ„å»ºåˆ†ç±»æç¤ºè¯]
</span></span><span class="line"><span class="cl">    C --&gt; D[æ·»åŠ å°‘æ ·æœ¬ç¤ºä¾‹]
</span></span><span class="line"><span class="cl">    D --&gt; E[è°ƒç”¨ChatClient]
</span></span><span class="line"><span class="cl">    E --&gt; F[è§£æåˆ†ç±»ç»“æœ]
</span></span><span class="line"><span class="cl">    F --&gt; G[æ›´æ–°çŠ¶æ€]
</span></span><span class="line"><span class="cl">    G --&gt; H[è¿”å›åˆ†ç±»ç»“æœ]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;æç¤ºè¯æ„å»º&#34;
</span></span><span class="line"><span class="cl">        I[ç³»ç»Ÿæç¤ºè¯æ¨¡æ¿]
</span></span><span class="line"><span class="cl">        J[åˆ†ç±»ç±»åˆ«åˆ—è¡¨]
</span></span><span class="line"><span class="cl">        K[åˆ†ç±»æŒ‡ä»¤]
</span></span><span class="line"><span class="cl">        L[å°‘æ ·æœ¬ç¤ºä¾‹]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    C --&gt; I
</span></span><span class="line"><span class="cl">    C --&gt; J
</span></span><span class="line"><span class="cl">    C --&gt; K
</span></span><span class="line"><span class="cl">    C --&gt; L
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;è¾“å‡ºæ ¼å¼&#34;
</span></span><span class="line"><span class="cl">        M[JSONæ ¼å¼]
</span></span><span class="line"><span class="cl">        M --&gt; N[keywords: å…³é”®è¯åˆ—è¡¨]
</span></span><span class="line"><span class="cl">        M --&gt; O[category_name: åˆ†ç±»åç§°]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    F --&gt; M
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>åº”ç”¨åœºæ™¯</strong>ï¼šQuestionClassifierNodeç‰¹åˆ«é€‚åˆå®¢æœç³»ç»Ÿçš„é—®é¢˜åˆ†ç±»ã€å†…å®¹å®¡æ ¸çš„ç±»å‹åˆ¤æ–­ã€é‚®ä»¶çš„è‡ªåŠ¨åˆ†æ‹£ç­‰åœºæ™¯ï¼Œèƒ½å¤Ÿæ˜¾è‘—æé«˜ä¸šåŠ¡å¤„ç†çš„è‡ªåŠ¨åŒ–ç¨‹åº¦ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">QuestionClassifierNode</span><span class="w"> </span><span class="n">classifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QuestionClassifierNode</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">chatClient</span><span class="p">(</span><span class="n">chatClient</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">inputTextKey</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">outputKey</span><span class="p">(</span><span class="s">&#34;classifier_output&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">categories</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;positive feedback&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;negative feedback&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">classificationInstructions</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s">&#34;Try to understand the user&#39;s feeling when giving feedback.&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ ¸å¿ƒå®ç°åŸç†ï¼š</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. ä»çŠ¶æ€è·å–è¾“å…¥æ–‡æœ¬</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">hasLength</span><span class="p">(</span><span class="n">inputTextKey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">inputText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="n">inputTextKey</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">inputText</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. æ„å»ºå°‘æ ·æœ¬å­¦ä¹ æ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">UserMessage</span><span class="p">(</span><span class="n">QUESTION_CLASSIFIER_USER_PROMPT_1</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AssistantMessage</span><span class="p">(</span><span class="n">QUESTION_CLASSIFIER_ASSISTANT_PROMPT_1</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">UserMessage</span><span class="p">(</span><span class="n">QUESTION_CLASSIFIER_USER_PROMPT_2</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AssistantMessage</span><span class="p">(</span><span class="n">QUESTION_CLASSIFIER_ASSISTANT_PROMPT_2</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. è°ƒç”¨å¤§æ¨¡å‹è¿›è¡Œåˆ†ç±»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ChatResponse</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chatClient</span><span class="p">.</span><span class="na">prompt</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">system</span><span class="p">(</span><span class="n">systemPromptTemplate</span><span class="p">.</span><span class="na">render</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;inputText&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">inputText</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;categories&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">categories</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;classificationInstructions&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">classificationInstructions</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">user</span><span class="p">(</span><span class="n">inputText</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">messages</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">call</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">chatResponse</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 4. è¿”å›åˆ†ç±»ç»“æœ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">updatedState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">updatedState</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">outputKey</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getResult</span><span class="p">().</span><span class="na">getOutput</span><span class="p">().</span><span class="na">getText</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">updatedState</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="413-llmnode---å¤§æ¨¡å‹è°ƒç”¨èŠ‚ç‚¹">4.1.3 LlmNode - å¤§æ¨¡å‹è°ƒç”¨èŠ‚ç‚¹
</h4><p><strong>LlmNodeæ˜¯å·¥ä½œæµçš„æ™ºèƒ½å¤§è„‘</strong>ï¼Œå®ƒå°è£…äº†ä¸å¤§è¯­è¨€æ¨¡å‹çš„æ‰€æœ‰äº¤äº’é€»è¾‘ï¼Œè®©å¼€å‘è€…å¯ä»¥è½»æ¾åœ°åœ¨å·¥ä½œæµä¸­ä½¿ç”¨AIçš„å¼ºå¤§èƒ½åŠ›ã€‚LlmNodeä¸ä»…æ”¯æŒç®€å•çš„æ–‡æœ¬ç”Ÿæˆï¼Œè¿˜æ”¯æŒå¤æ‚çš„å¯¹è¯ç®¡ç†å’Œæµå¼è¾“å‡ºã€‚</p>
<p><strong>æ™ºèƒ½ç‰¹æ€§</strong>ï¼šLlmNodeå†…ç½®äº†æç¤ºè¯æ¨¡æ¿å¼•æ“ï¼Œæ”¯æŒåŠ¨æ€å‚æ•°æ›¿æ¢ï¼Œè¿˜èƒ½ç®¡ç†å®Œæ•´çš„å¯¹è¯å†å²ï¼Œè¿™äº›ç‰¹æ€§è®©å®ƒèƒ½å¤Ÿå¤„ç†å„ç§å¤æ‚çš„AIäº¤äº’åœºæ™¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart TD
</span></span><span class="line"><span class="cl">    A[LlmNodeæ‰§è¡Œ] --&gt; B[åˆå§‹åŒ–èŠ‚ç‚¹çŠ¶æ€]
</span></span><span class="line"><span class="cl">    B --&gt; C{æ˜¯å¦æµå¼æ¨¡å¼?}
</span></span><span class="line"><span class="cl">    C --&gt;|æ˜¯| D[åˆ›å»ºæµå¼å“åº”]
</span></span><span class="line"><span class="cl">    C --&gt;|å¦| E[åˆ›å»ºåŒæ­¥å“åº”]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    D --&gt; F[æ„å»ºStreamingChatGenerator]
</span></span><span class="line"><span class="cl">    F --&gt; G[è¿”å›AsyncGenerator]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    E --&gt; H[è°ƒç”¨ChatClient]
</span></span><span class="line"><span class="cl">    H --&gt; I[è·å–å“åº”ç»“æœ]
</span></span><span class="line"><span class="cl">    I --&gt; J[æ›´æ–°æ¶ˆæ¯çŠ¶æ€]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    G --&gt; K[æµå¼è¾“å‡ºå¤„ç†]
</span></span><span class="line"><span class="cl">    J --&gt; L[åŒæ­¥ç»“æœè¿”å›]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;çŠ¶æ€åˆå§‹åŒ–&#34;
</span></span><span class="line"><span class="cl">        M[userPromptKey â†’ userPrompt]
</span></span><span class="line"><span class="cl">        N[systemPromptKey â†’ systemPrompt]
</span></span><span class="line"><span class="cl">        O[paramsKey â†’ params]
</span></span><span class="line"><span class="cl">        P[messagesKey â†’ messages]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    B --&gt; M
</span></span><span class="line"><span class="cl">    B --&gt; N
</span></span><span class="line"><span class="cl">    B --&gt; O
</span></span><span class="line"><span class="cl">    B --&gt; P
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;æ¨¡æ¿æ¸²æŸ“&#34;
</span></span><span class="line"><span class="cl">        Q[PromptTemplate.render]
</span></span><span class="line"><span class="cl">        Q --&gt; R[å‚æ•°æ›¿æ¢]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    M --&gt; Q
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æµå¼å¤„ç†ä¼˜åŠ¿</strong>ï¼šLlmNodeåŸç”Ÿæ”¯æŒæµå¼è¾“å‡ºï¼Œè¿™æ„å‘³ç€ç”¨æˆ·å¯ä»¥å®æ—¶çœ‹åˆ°AIçš„ç”Ÿæˆè¿‡ç¨‹ï¼Œè€Œä¸éœ€è¦ç­‰å¾…å®Œæ•´çš„å“åº”ï¼Œå¤§å¤§æå‡äº†ç”¨æˆ·ä½“éªŒã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">LlmNode</span><span class="w"> </span><span class="n">llmNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LlmNode</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">chatClient</span><span class="p">(</span><span class="n">chatClient</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">systemPromptTemplate</span><span class="p">(</span><span class="s">&#34;You are a helpful assistant.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">userPromptTemplate</span><span class="p">(</span><span class="s">&#34;Please process: {input}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">messagesKey</span><span class="p">(</span><span class="s">&#34;messages&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">outputKey</span><span class="p">(</span><span class="s">&#34;llm_response&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">stream</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w">  </span><span class="c1">// å¯ç”¨æµå¼è¾“å‡º</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ ¸å¿ƒç‰¹æ€§ï¼š</strong></p>
<ul>
<li><strong>æ¨¡æ¿æ”¯æŒ</strong>ï¼šæ”¯æŒç³»ç»Ÿæç¤ºè¯å’Œç”¨æˆ·æç¤ºè¯æ¨¡æ¿</li>
<li><strong>æ¶ˆæ¯å†å²</strong>ï¼šæ”¯æŒæ¶ˆæ¯å†å²ç®¡ç†</li>
<li><strong>æµå¼è¾“å‡º</strong>ï¼šåŸç”Ÿæ”¯æŒæµå¼å¤„ç†</li>
<li><strong>å‚æ•°æ¸²æŸ“</strong>ï¼šæ”¯æŒåŠ¨æ€å‚æ•°æ›¿æ¢</li>
</ul>
<h4 id="414-toolnode---å·¥å…·è°ƒç”¨èŠ‚ç‚¹">4.1.4 ToolNode - å·¥å…·è°ƒç”¨èŠ‚ç‚¹
</h4><p><strong>ToolNodeæ˜¯å·¥ä½œæµçš„ä¸‡èƒ½å·¥å…·ç®±</strong>ï¼Œå®ƒè®©AIèƒ½å¤Ÿè°ƒç”¨å¤–éƒ¨å·¥å…·å’ŒAPIï¼Œæå¤§åœ°æ‰©å±•äº†AIçš„èƒ½åŠ›è¾¹ç•Œã€‚ToolNodeä¸ä»…èƒ½æ‰§è¡Œå•ä¸ªå·¥å…·è°ƒç”¨ï¼Œè¿˜èƒ½å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå·¥å…·ï¼Œæ˜¾è‘—æé«˜äº†å¤„ç†æ•ˆç‡ã€‚</p>
<p><strong>æ ¸å¿ƒä»·å€¼</strong>ï¼šToolNodeå°†AIä»çº¯æ–‡æœ¬ç”Ÿæˆæ‰©å±•åˆ°äº†å®é™…çš„è¡ŒåŠ¨èƒ½åŠ›ï¼Œè®©AIèƒ½å¤ŸæŸ¥è¯¢æ•°æ®åº“ã€è°ƒç”¨APIã€æ‰§è¡Œè®¡ç®—ç­‰ï¼ŒçœŸæ­£å®ç°äº†AI Agentçš„æ¦‚å¿µã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sequenceDiagram
</span></span><span class="line"><span class="cl">    participant TN as ToolNode
</span></span><span class="line"><span class="cl">    participant State as OverAllState
</span></span><span class="line"><span class="cl">    participant AM as AssistantMessage
</span></span><span class="line"><span class="cl">    participant TC as ToolCallback
</span></span><span class="line"><span class="cl">    participant TR as ToolResponse
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    TN-&gt;&gt;State: è·å–llm_responseæˆ–messages
</span></span><span class="line"><span class="cl">    State--&gt;&gt;TN: è¿”å›AssistantMessage
</span></span><span class="line"><span class="cl">    TN-&gt;&gt;AM: æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
</span></span><span class="line"><span class="cl">    AM--&gt;&gt;TN: è¿”å›ToolCallåˆ—è¡¨
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    loop éå†æ¯ä¸ªToolCall
</span></span><span class="line"><span class="cl">        TN-&gt;&gt;TC: æ‰§è¡Œå·¥å…·è°ƒç”¨
</span></span><span class="line"><span class="cl">        TC--&gt;&gt;TN: è¿”å›å·¥å…·ç»“æœ
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    TN-&gt;&gt;TR: æ„å»ºToolResponseMessage
</span></span><span class="line"><span class="cl">    TR--&gt;&gt;State: æ›´æ–°messagesçŠ¶æ€
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>çµæ´»æ€§è®¾è®¡</strong>ï¼šToolNodeæ”¯æŒå„ç§ç±»å‹çš„å·¥å…·è°ƒç”¨ï¼Œä»ç®€å•çš„å‡½æ•°è°ƒç”¨åˆ°å¤æ‚çš„APIé›†æˆï¼Œéƒ½èƒ½è½»æ¾å¤„ç†ï¼Œè¿™ç§çµæ´»æ€§è®©AIåº”ç”¨èƒ½å¤Ÿé€‚åº”å„ç§ä¸šåŠ¡åœºæ™¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ToolNode</span><span class="w"> </span><span class="n">toolNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ToolNode</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">toolCallbacks</span><span class="p">(</span><span class="n">toolCallbacks</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">llmResponseKey</span><span class="p">(</span><span class="s">&#34;llm_response&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">outputKey</span><span class="p">(</span><span class="s">&#34;tool_response&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ‰§è¡Œæœºåˆ¶ï¼š</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. è·å–åŠ©æ‰‹æ¶ˆæ¯ï¼ˆåŒ…å«å·¥å…·è°ƒç”¨ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">assistantMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">AssistantMessage</span><span class="p">)</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">llmResponseKey</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="s">&#34;messages&#34;</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">messages</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">messages</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. æ‰§è¡Œå·¥å…·è°ƒç”¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ToolResponseMessage</span><span class="w"> </span><span class="n">toolResponseMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executeFunction</span><span class="p">(</span><span class="n">assistantMessage</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. è¿”å›å·¥å…·å“åº”</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">updatedState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">updatedState</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;messages&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">toolResponseMessage</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">hasLength</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">outputKey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">updatedState</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">outputKey</span><span class="p">,</span><span class="w"> </span><span class="n">toolResponseMessage</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">updatedState</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="415-knowledgeretrievalnode---çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹">4.1.5 KnowledgeRetrievalNode - çŸ¥è¯†æ£€ç´¢èŠ‚ç‚¹
</h4><p><strong>KnowledgeRetrievalNodeæ˜¯å·¥ä½œæµçš„çŸ¥è¯†ä¸“å®¶</strong>ï¼Œå®ƒèƒ½å¤Ÿä»åºå¤§çš„çŸ¥è¯†åº“ä¸­å¿«é€Ÿæ‰¾åˆ°ä¸é—®é¢˜ç›¸å…³çš„ä¿¡æ¯ï¼Œä¸ºAIæä¾›å‡†ç¡®çš„èƒŒæ™¯çŸ¥è¯†ã€‚è¿™ä¸ªèŠ‚ç‚¹ç»“åˆäº†å‘é‡æ£€ç´¢å’Œé‡æ’åºæŠ€æœ¯ï¼Œç¡®ä¿æ£€ç´¢ç»“æœçš„å‡†ç¡®æ€§å’Œç›¸å…³æ€§ã€‚</p>
<p><strong>æŠ€æœ¯ä¼˜åŠ¿</strong>ï¼šKnowledgeRetrievalNodeé‡‡ç”¨äº†å…ˆè¿›çš„RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æŠ€æœ¯ï¼Œé€šè¿‡å‘é‡ç›¸ä¼¼åº¦è®¡ç®—æ‰¾åˆ°ç›¸å…³æ–‡æ¡£ï¼Œå†é€šè¿‡é‡æ’åºæ¨¡å‹è¿›ä¸€æ­¥ä¼˜åŒ–ç»“æœè´¨é‡ï¼Œè¿™ç§ä¸¤é˜¶æ®µçš„è®¾è®¡ç¡®ä¿äº†æ£€ç´¢çš„ç²¾å‡†æ€§ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart TD
</span></span><span class="line"><span class="cl">    A[KnowledgeRetrievalNodeæ‰§è¡Œ] --&gt; B[è·å–æŸ¥è¯¢æ–‡æœ¬]
</span></span><span class="line"><span class="cl">    B --&gt; C[å‘é‡æ£€ç´¢]
</span></span><span class="line"><span class="cl">    C --&gt; D[ç›¸ä¼¼åº¦è¿‡æ»¤]
</span></span><span class="line"><span class="cl">    D --&gt; E{å¯ç”¨é‡æ’åº?}
</span></span><span class="line"><span class="cl">    E --&gt;|æ˜¯| F[è°ƒç”¨é‡æ’åºæ¨¡å‹]
</span></span><span class="line"><span class="cl">    E --&gt;|å¦| G[ç›´æ¥è¿”å›ç»“æœ]
</span></span><span class="line"><span class="cl">    F --&gt; H[é‡æ’åºç»“æœ]
</span></span><span class="line"><span class="cl">    H --&gt; I[æ„å»ºæ£€ç´¢ç»“æœ]
</span></span><span class="line"><span class="cl">    G --&gt; I
</span></span><span class="line"><span class="cl">    I --&gt; J[æ›´æ–°çŠ¶æ€]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;æ£€ç´¢é…ç½®&#34;
</span></span><span class="line"><span class="cl">        K[topK: è¿”å›æ•°é‡]
</span></span><span class="line"><span class="cl">        L[similarityThreshold: ç›¸ä¼¼åº¦é˜ˆå€¼]
</span></span><span class="line"><span class="cl">        M[enableRanker: æ˜¯å¦é‡æ’åº]
</span></span><span class="line"><span class="cl">        N[rerankModel: é‡æ’åºæ¨¡å‹]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    C --&gt; K
</span></span><span class="line"><span class="cl">    D --&gt; L
</span></span><span class="line"><span class="cl">    F --&gt; M
</span></span><span class="line"><span class="cl">    F --&gt; N
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>åº”ç”¨ä»·å€¼</strong>ï¼šKnowledgeRetrievalNodeè®©AIèƒ½å¤ŸåŸºäºä¼ä¸šçš„ç§æœ‰çŸ¥è¯†åº“å›ç­”é—®é¢˜ï¼Œè¿™å¯¹äºæ„å»ºä¼ä¸šçº§AIåŠ©æ‰‹ã€æ™ºèƒ½å®¢æœç­‰åº”ç”¨å…·æœ‰é‡è¦æ„ä¹‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">KnowledgeRetrievalNode</span><span class="w"> </span><span class="n">retrievalNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KnowledgeRetrievalNode</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">vectorStore</span><span class="p">(</span><span class="n">vectorStore</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">userPromptKey</span><span class="p">(</span><span class="s">&#34;query&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">topK</span><span class="p">(</span><span class="n">5</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">similarityThreshold</span><span class="p">(</span><span class="n">0</span><span class="p">.</span><span class="na">7</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">enableRanker</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">rerankModel</span><span class="p">(</span><span class="n">rerankModel</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">outputKey</span><span class="p">(</span><span class="s">&#34;retrieved_docs&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="42-é¢„å®šä¹‰agentç±»å‹">4.2 é¢„å®šä¹‰Agentç±»å‹
</h3><h4 id="421-reactagent---ååº”å¼agent">4.2.1 ReactAgent - ååº”å¼Agent
</h4><p><strong>ReactAgentæ˜¯å·¥ä½œæµçš„æ™ºèƒ½å†³ç­–è€…</strong>ï¼Œå®ƒå®ç°äº†ç»å…¸çš„ReActï¼ˆReasoning and Actingï¼‰æ¨¡å¼ï¼Œèƒ½å¤Ÿæ ¹æ®å½“å‰æƒ…å†µåŠ¨æ€å†³å®šæ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·ã€‚ReactAgentå°±åƒä¸€ä¸ªæœ‰ç»éªŒçš„åŠ©æ‰‹ï¼ŒçŸ¥é“ä»€ä¹ˆæ—¶å€™éœ€è¦æŸ¥æ‰¾ä¿¡æ¯ï¼Œä»€ä¹ˆæ—¶å€™å¯ä»¥ç›´æ¥å›ç­”ã€‚</p>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šReactAgentå°†æ¨ç†å’Œè¡ŒåŠ¨ç»“åˆåœ¨ä¸€èµ·ï¼Œè®©AIä¸ä»…èƒ½æ€è€ƒï¼Œè¿˜èƒ½è¡ŒåŠ¨ã€‚è¿™ç§è®¾è®¡è®©AIå…·å¤‡äº†è§£å†³å¤æ‚é—®é¢˜çš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿé€šè¿‡å¤šè½®æ¨ç†å’Œå·¥å…·è°ƒç”¨æ¥å®Œæˆå¤æ‚ä»»åŠ¡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">stateDiagram-v2
</span></span><span class="line"><span class="cl">    [*] --&gt; START
</span></span><span class="line"><span class="cl">    START --&gt; LLM: å¼€å§‹æ¨ç†
</span></span><span class="line"><span class="cl">    LLM --&gt; Think: åˆ†ææ˜¯å¦éœ€è¦å·¥å…·
</span></span><span class="line"><span class="cl">    Think --&gt; Tool: éœ€è¦å·¥å…·
</span></span><span class="line"><span class="cl">    Think --&gt; END: ä¸éœ€è¦å·¥å…·
</span></span><span class="line"><span class="cl">    Tool --&gt; LLM: å·¥å…·æ‰§è¡Œå®Œæˆ
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    note right of Think
</span></span><span class="line"><span class="cl">        æ£€æŸ¥AssistantMessage
</span></span><span class="line"><span class="cl">        æ˜¯å¦åŒ…å«ToolCalls
</span></span><span class="line"><span class="cl">    end note
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    note right of Tool
</span></span><span class="line"><span class="cl">        æ‰§è¡Œå·¥å…·è°ƒç”¨
</span></span><span class="line"><span class="cl">        è·å–å¤–éƒ¨ä¿¡æ¯
</span></span><span class="line"><span class="cl">    end note
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ™ºèƒ½å¾ªç¯</strong>ï¼šReactAgentçš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ä¸€ä¸ªæ™ºèƒ½å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¼šè¯„ä¼°å½“å‰çŠ¶æ€ï¼Œå†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼Œè¿™ç§è®¾è®¡è®©AIèƒ½å¤Ÿå¤„ç†å„ç§å¤æ‚å’ŒåŠ¨æ€çš„ä»»åŠ¡åœºæ™¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ReactAgent</span><span class="w"> </span><span class="n">reactAgent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReactAgent</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;weatherAgent&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">chatClient</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">toolCallbacks</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">10</span><span class="w">  </span><span class="c1">// æœ€å¤§è¿­ä»£æ¬¡æ•°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// ç¼–è¯‘å¹¶ä½¿ç”¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">CompiledGraph</span><span class="w"> </span><span class="n">compiledGraph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reactAgent</span><span class="p">.</span><span class="na">getAndCompileGraph</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å†…éƒ¨å›¾ç»“æ„æ„å»ºï¼š</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="nf">initGraph</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">GraphStateException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StateGraph</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StateGraph</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">keyStrategyFactory</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// æ·»åŠ æ ¸å¿ƒèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">graph</span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;llm&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">llmNode</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">graph</span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;tool&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">toolNode</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// æ„å»ºæ‰§è¡Œæµç¨‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">graph</span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;llm&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="p">.</span><span class="na">addConditionalEdges</span><span class="p">(</span><span class="s">&#34;llm&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">edge_async</span><span class="p">(</span><span class="k">this</span><span class="p">::</span><span class="n">think</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;continue&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;tool&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;end&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;tool&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;llm&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">graph</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// å†³ç­–é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">think</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iterations</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_iterations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;end&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="s">&#34;messages&#34;</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">AssistantMessage</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">AssistantMessage</span><span class="p">)</span><span class="w"> </span><span class="n">messages</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">messages</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">hasToolCalls</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&#34;continue&#34;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&#34;end&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="422-reflectagent---åæ€agent">4.2.2 ReflectAgent - åæ€Agent
</h4><p><strong>ReflectAgentæ˜¯å·¥ä½œæµçš„è´¨é‡ç›‘ç£è€…</strong>ï¼Œå®ƒå®ç°äº†åæ€æ¨¡å¼ï¼Œèƒ½å¤Ÿå¯¹è‡ªå·±çš„è¾“å‡ºè¿›è¡Œè¯„ä¼°å’Œæ”¹è¿›ã€‚ReflectAgentå°±åƒä¸€ä¸ªä¸¥æ ¼çš„ç¼–è¾‘ï¼Œä¼šåå¤æ£€æŸ¥å’Œä¿®æ”¹å†…å®¹ï¼Œç›´åˆ°è¾¾åˆ°æ»¡æ„çš„è´¨é‡æ ‡å‡†ã€‚</p>
<p><strong>è‡ªæˆ‘æ”¹è¿›æœºåˆ¶</strong>ï¼šReflectAgenté‡‡ç”¨äº†åŒèŠ‚ç‚¹åä½œçš„è®¾è®¡ï¼Œä¸€ä¸ªèŠ‚ç‚¹è´Ÿè´£ç”Ÿæˆå†…å®¹ï¼Œå¦ä¸€ä¸ªèŠ‚ç‚¹è´Ÿè´£è¯„ä¼°è´¨é‡ï¼Œé€šè¿‡å¤šè½®è¿­ä»£ä¸æ–­æå‡è¾“å‡ºè´¨é‡ã€‚è¿™ç§è®¾è®¡è®©AIå…·å¤‡äº†è‡ªæˆ‘å®Œå–„çš„èƒ½åŠ›ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">graph TD
</span></span><span class="line"><span class="cl">    A[START] --&gt; B[GraphèŠ‚ç‚¹&lt;br/&gt;ç”Ÿæˆå†…å®¹]
</span></span><span class="line"><span class="cl">    B --&gt; C[æ£€æŸ¥è¿­ä»£æ¬¡æ•°]
</span></span><span class="line"><span class="cl">    C --&gt; D{è¾¾åˆ°æœ€å¤§è¿­ä»£?}
</span></span><span class="line"><span class="cl">    D --&gt;|æ˜¯| E[END]
</span></span><span class="line"><span class="cl">    D --&gt;|å¦| F[ReflectionèŠ‚ç‚¹&lt;br/&gt;è¯„ä¼°è´¨é‡]
</span></span><span class="line"><span class="cl">    F --&gt; G[æ£€æŸ¥æœ€åæ¶ˆæ¯ç±»å‹]
</span></span><span class="line"><span class="cl">    G --&gt; H{æ˜¯ç”¨æˆ·æ¶ˆæ¯?}
</span></span><span class="line"><span class="cl">    H --&gt;|æ˜¯| B
</span></span><span class="line"><span class="cl">    H --&gt;|å¦| E
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;åæ€å¾ªç¯&#34;
</span></span><span class="line"><span class="cl">        I[ç”Ÿæˆåˆå§‹å†…å®¹]
</span></span><span class="line"><span class="cl">        J[åæ€è¯„ä¼°]
</span></span><span class="line"><span class="cl">        K[åŸºäºåæ€æ”¹è¿›]
</span></span><span class="line"><span class="cl">        L[é‡å¤ç›´åˆ°æ»¡æ„]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    B --&gt; I
</span></span><span class="line"><span class="cl">    F --&gt; J
</span></span><span class="line"><span class="cl">    B --&gt; K
</span></span><span class="line"><span class="cl">    G --&gt; L
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>è´¨é‡ä¿è¯</strong>ï¼šReflectAgentç‰¹åˆ«é€‚åˆå¯¹è¾“å‡ºè´¨é‡è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œå¦‚æ–‡æ¡£å†™ä½œã€ä»£ç ç”Ÿæˆã€åˆ›æ„å†…å®¹ç­‰ï¼Œé€šè¿‡åæ€æœºåˆ¶ç¡®ä¿æœ€ç»ˆè¾“å‡ºçš„è´¨é‡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ReflectAgent</span><span class="w"> </span><span class="n">reflectAgent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReflectAgent</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">graph</span><span class="p">(</span><span class="n">assistantGraphNode</span><span class="p">)</span><span class="w">      </span><span class="c1">// ç”ŸæˆèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">reflection</span><span class="p">(</span><span class="n">judgeGraphNode</span><span class="p">)</span><span class="w">     </span><span class="c1">// è¯„åˆ¤èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">maxIterations</span><span class="p">(</span><span class="n">3</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ‰§è¡Œæµç¨‹è¯¦è§£ï¼š</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="nf">createReflectionGraph</span><span class="p">(</span><span class="n">NodeAction</span><span class="w"> </span><span class="n">graph</span><span class="p">,</span><span class="w"> </span><span class="n">NodeAction</span><span class="w"> </span><span class="n">reflection</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxIterations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StateGraph</span><span class="w"> </span><span class="n">stateGraph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StateGraph</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">keyStrategyHashMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">keyStrategyHashMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">MESSAGES</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">keyStrategyHashMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ITERATION_NUM</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">keyStrategyHashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="n">GRAPH_NODE_ID</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">graph</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="n">REFLECTION_NODE_ID</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">reflection</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="n">GRAPH_NODE_ID</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addConditionalEdges</span><span class="p">(</span><span class="n">GRAPH_NODE_ID</span><span class="p">,</span><span class="w"> </span><span class="n">edge_async</span><span class="p">(</span><span class="k">this</span><span class="p">::</span><span class="n">graphCount</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">REFLECTION_NODE_ID</span><span class="p">,</span><span class="w"> </span><span class="n">REFLECTION_NODE_ID</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addConditionalEdges</span><span class="p">(</span><span class="n">REFLECTION_NODE_ID</span><span class="p">,</span><span class="w"> </span><span class="n">edge_async</span><span class="p">(</span><span class="k">this</span><span class="p">::</span><span class="n">apply</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">GRAPH_NODE_ID</span><span class="p">,</span><span class="w"> </span><span class="n">GRAPH_NODE_ID</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stateGraph</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// è¿­ä»£æ¬¡æ•°æ£€æŸ¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">graphCount</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iterationNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="n">ITERATION_NUM</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="na">updateState</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">ITERATION_NUM</span><span class="p">,</span><span class="w"> </span><span class="n">iterationNum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">iterationNum</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxIterations</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">REFLECTION_NODE_ID</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// æ¶ˆæ¯ç±»å‹æ£€æŸ¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="n">MESSAGES</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">messages</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">END</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Message</span><span class="w"> </span><span class="n">lastMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">messages</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">messages</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">lastMessage</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">UserMessage</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">GRAPH_NODE_ID</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">END</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="423-reactagentwithhuman---äººæœºåä½œagent">4.2.3 ReactAgentWithHuman - äººæœºåä½œAgent
</h4><p><strong>ReactAgentWithHumanæ˜¯å·¥ä½œæµçš„äººæœºåä½œä¸“å®¶</strong>ï¼Œå®ƒåœ¨ReactAgentçš„åŸºç¡€ä¸Šå¢åŠ äº†äººå·¥å¹²é¢„èƒ½åŠ›ï¼Œè®©AIå’Œäººç±»èƒ½å¤Ÿåä½œå®Œæˆå¤æ‚ä»»åŠ¡ã€‚è¿™ç§è®¾è®¡ç‰¹åˆ«é€‚åˆéœ€è¦äººå·¥å®¡æ ¸ã€å†³ç­–ç¡®è®¤æˆ–ä¸“ä¸šåˆ¤æ–­çš„åœºæ™¯ã€‚</p>
<p><strong>åä½œæœºåˆ¶</strong>ï¼šReactAgentWithHumanå†…ç½®äº†å®Œå–„çš„ä¸­æ–­å’Œæ¢å¤æœºåˆ¶ï¼Œå½“é‡åˆ°éœ€è¦äººå·¥å¹²é¢„çš„æƒ…å†µæ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æš‚åœæ‰§è¡Œï¼Œç­‰å¾…äººå·¥å¤„ç†ï¼Œç„¶åæ— ç¼æ¢å¤æ‰§è¡Œã€‚è¿™ç§è®¾è®¡è®©äººæœºåä½œå˜å¾—è‡ªç„¶è€Œæµç•…ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart TD
</span></span><span class="line"><span class="cl">    A[START] --&gt; B[AgentèŠ‚ç‚¹&lt;br/&gt;LLMæ¨ç†]
</span></span><span class="line"><span class="cl">    B --&gt; C[HumanèŠ‚ç‚¹&lt;br/&gt;äººå·¥æ£€æŸ¥]
</span></span><span class="line"><span class="cl">    C --&gt; D{äººå·¥å†³ç­–}
</span></span><span class="line"><span class="cl">    D --&gt;|ç»§ç»­Agent| B
</span></span><span class="line"><span class="cl">    D --&gt;|è°ƒç”¨å·¥å…·| E[ToolèŠ‚ç‚¹&lt;br/&gt;å·¥å…·æ‰§è¡Œ]
</span></span><span class="line"><span class="cl">    D --&gt;|ç»“æŸ| F[END]
</span></span><span class="line"><span class="cl">    E --&gt; B
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;HumanèŠ‚ç‚¹é€»è¾‘&#34;
</span></span><span class="line"><span class="cl">        G[æ£€æŸ¥ä¸­æ–­æ¡ä»¶]
</span></span><span class="line"><span class="cl">        H[ç­‰å¾…äººå·¥åé¦ˆ]
</span></span><span class="line"><span class="cl">        I[æ ¹æ®åé¦ˆå†³ç­–]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    C --&gt; G
</span></span><span class="line"><span class="cl">    C --&gt; H
</span></span><span class="line"><span class="cl">    C --&gt; I
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;ä¸­æ–­æ¢å¤æœºåˆ¶&#34;
</span></span><span class="line"><span class="cl">        J[ä¿å­˜çŠ¶æ€å¿«ç…§]
</span></span><span class="line"><span class="cl">        K[ç­‰å¾…äººå·¥å¤„ç†]
</span></span><span class="line"><span class="cl">        L[åŠ è½½çŠ¶æ€æ¢å¤]
</span></span><span class="line"><span class="cl">        M[ç»§ç»­æ‰§è¡Œ]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    H --&gt; J
</span></span><span class="line"><span class="cl">    J --&gt; K
</span></span><span class="line"><span class="cl">    K --&gt; L
</span></span><span class="line"><span class="cl">    L --&gt; M
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>äººæœºåä½œå®ç°ï¼š</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="nf">initGraph</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">GraphStateException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StateGraph</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StateGraph</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">keyStrategyFactory</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;agent&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">llmNode</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;human&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">humanNode</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;tool&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">toolNode</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;agent&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;agent&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;human&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addConditionalEdges</span><span class="p">(</span><span class="s">&#34;human&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">edge_async</span><span class="p">(</span><span class="n">humanNode</span><span class="p">::</span><span class="n">think</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;agent&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;agent&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;tool&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;tool&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;end&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;tool&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;agent&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">graph</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// HumanNodeçš„å†³ç­–é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">think</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// æ£€æŸ¥æ˜¯å¦éœ€è¦ä¸­æ–­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldInterruptFunc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">shouldInterruptFunc</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">state</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è®¾ç½®ä¸­æ–­æ¶ˆæ¯ï¼Œç­‰å¾…äººå·¥å¤„ç†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">state</span><span class="p">.</span><span class="na">setInterruptMessage</span><span class="p">(</span><span class="s">&#34;ç­‰å¾…äººå·¥å®¡æ‰¹&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;human_interrupt&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// æ£€æŸ¥æ˜¯å¦éœ€è¦å·¥å…·è°ƒç”¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="s">&#34;messages&#34;</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">messages</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">lastMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">messages</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">messages</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastMessage</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">AssistantMessage</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">((</span><span class="n">AssistantMessage</span><span class="p">)</span><span class="w"> </span><span class="n">lastMessage</span><span class="p">).</span><span class="na">hasToolCalls</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;tool&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;agent&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5-é«˜çº§ç‰¹æ€§ä¸æ‰©å±•èƒ½åŠ›">5. é«˜çº§ç‰¹æ€§ä¸æ‰©å±•èƒ½åŠ›
</h2><h3 id="51-å¯è§‚æµ‹æ€§">5.1 å¯è§‚æµ‹æ€§
</h3><p>Spring AI Alibaba Graphæä¾›äº†ä¼ä¸šçº§çš„å…¨é“¾è·¯è§‚æµ‹èƒ½åŠ›ï¼ŒåŸºäºOpenTelemetryå’ŒMicrometeræ ‡å‡†ï¼Œå®ç°äº†ä»Graphæ‰§è¡Œåˆ°æ¨¡å‹è°ƒç”¨çš„å®Œæ•´è¿½è¸ªã€‚</p>
<h4 id="511-æ ¸å¿ƒç‰¹æ€§">5.1.1 æ ¸å¿ƒç‰¹æ€§
</h4><ul>
<li><strong>å…¨é“¾è·¯å¯è§‚æµ‹</strong>ï¼šå®æ—¶è¿½è¸ªæ¯ä¸ªèŠ‚ç‚¹çš„è¾“å…¥ã€è¾“å‡ºå’ŒçŠ¶æ€å˜åŒ–</li>
<li><strong>æµå¼æ•°æ®é‡‡é›†</strong>ï¼šæ”¯æŒå¼‚æ­¥ã€å¹¶è¡Œã€æµå¼èŠ‚ç‚¹çš„è§‚æµ‹</li>
<li><strong>å¼‚å¸¸æº¯æº</strong>ï¼šå¿«é€Ÿå®šä½å¼‚å¸¸èŠ‚ç‚¹å’Œæ•°æ®</li>
<li><strong>å¤šå¹³å°æ”¯æŒ</strong>ï¼šå…¼å®¹Langfuseã€Jaegerã€Zipkinã€Prometheusç­‰ä¸»æµå¹³å°</li>
</ul>
<h4 id="512-å¿«é€Ÿæ¥å…¥">5.1.2 å¿«é€Ÿæ¥å…¥
</h4><p><strong>ä½¿ç”¨è§‚æµ‹æ€§Starter</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud.ai<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-ai-alibaba-starter-graph-observation<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>${spring-ai-alibaba.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">CompiledGraph</span><span class="w"> </span><span class="nf">compiledGraph</span><span class="p">(</span><span class="n">StateGraph</span><span class="w"> </span><span class="n">observabilityGraph</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="n">CompileConfig</span><span class="w"> </span><span class="n">observationCompileConfig</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">GraphStateException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">observabilityGraph</span><span class="p">.</span><span class="na">compile</span><span class="p">(</span><span class="n">observationCompileConfig</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="513-è¯¦ç»†æ–‡æ¡£">5.1.3 è¯¦ç»†æ–‡æ¡£
</h4><p>å…³äºSpring AI Alibaba Graphè§‚æµ‹æ€§çš„å®Œæ•´æ¶æ„è®¾è®¡ã€å®ç°åŸç†ã€é…ç½®æ–¹å¼ã€æœ€ä½³å®è·µç­‰è¯¦ç»†å†…å®¹ï¼Œè¯·å‚è€ƒå®˜æ–¹è§‚æµ‹æ€§æ–‡æ¡£ï¼š</p>
<p><strong>ğŸ“š Graphè§‚æµ‹æ€§å®Œæ•´æŒ‡å—</strong>ï¼š<a class="link" href="https://www.yuque.com/disaster-4qc4i/xhs01z/qrh6lv7m3sexgvr4"  target="_blank" rel="noopener"
    >Spring AI Alibaba Graphè§‚æµ‹æ€§è®¾è®¡ä¸å®ç°</a></p>
<p>è¯¥æ–‡æ¡£æ¶µç›–ï¼š</p>
<ul>
<li>è§‚æµ‹æ€§è®¾è®¡ç†å¿µä¸æ¶æ„</li>
<li>å¹¶è¡Œä¸æµå¼è§‚æµ‹å®ç°</li>
<li>å¤šå¹³å°é›†æˆé…ç½®</li>
<li>Langfuseç­‰å¯è§†åŒ–å¹³å°ä½¿ç”¨</li>
<li>æœ€ä½³å®è·µä¸æ‰©å±•å»ºè®®</li>
</ul>
<p><strong>ğŸ”— å®Œæ•´ç¤ºä¾‹ä»£ç </strong>ï¼š<a class="link" href="https://github.com/springaialibaba/spring-ai-alibaba-examples/tree/main/spring-ai-alibaba-graph-example/graph-observability-langfuse"  target="_blank" rel="noopener"
    >graph-observability-langfuse</a></p>
<h3 id="52-å¹¶è¡ŒèŠ‚ç‚¹ä¸æµå¼å¤„ç†">5.2 å¹¶è¡ŒèŠ‚ç‚¹ä¸æµå¼å¤„ç†
</h3><h4 id="521-å¹¶è¡ŒèŠ‚ç‚¹çš„ä¸¤ç§åˆ›å»ºæ–¹å¼">5.2.1 å¹¶è¡ŒèŠ‚ç‚¹çš„ä¸¤ç§åˆ›å»ºæ–¹å¼
</h4><p><strong>Spring AI Alibaba Graphæä¾›äº†ä¸¤ç§åˆ›å»ºå¹¶è¡ŒèŠ‚ç‚¹çš„æ–¹å¼</strong>ï¼Œè¿™ä¸¤ç§æ–¹å¼åœ¨åº•å±‚å®ç°ä¸Šæœ‰æ‰€ä¸åŒï¼Œä½†éƒ½èƒ½å®ç°å¹¶è¡Œå¤„ç†çš„æ•ˆæœã€‚</p>
<h5 id="æ–¹å¼ä¸€ç›´æ¥åˆ›å»ºparallelnode">æ–¹å¼ä¸€ï¼šç›´æ¥åˆ›å»ºParallelNode
</h5><p>ç›´æ¥åˆ›å»ºä¸€ä¸ªParallelNodeå®ä¾‹ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°StateGraphä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// åˆ›å»ºå¹¶è¡Œä»»åŠ¡åˆ—è¡¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">AsyncNodeActionWithConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">parallelActions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">node_async</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DataProcessingNode1</span><span class="p">()),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">node_async</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DataProcessingNode2</span><span class="p">()),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">node_async</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DataProcessingNode3</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// å®šä¹‰çŠ¶æ€åˆå¹¶ç­–ç•¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">channels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;results&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppendStrategy</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;metadata&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// åˆ›å»ºå¹¶è¡ŒèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ParallelNode</span><span class="w"> </span><span class="n">parallelNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ParallelNode</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;data_processing&#34;</span><span class="p">,</span><span class="w">           </span><span class="c1">// èŠ‚ç‚¹å†…éƒ¨ID  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">parallelActions</span><span class="p">,</span><span class="w">            </span><span class="c1">// å¹¶è¡Œä»»åŠ¡åˆ—è¡¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">channels</span><span class="w">                    </span><span class="c1">// KeyStrategyæ˜ å°„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// æ·»åŠ åˆ°StateGraph</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">stateGraph</span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;parallel_tasks&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">parallelNode</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ–¹å¼äºŒé€šè¿‡stategraphæè¿°å¹¶è¡Œè¾¹">æ–¹å¼äºŒï¼šé€šè¿‡StateGraphæè¿°å¹¶è¡Œè¾¹
</h5><p><strong>è¿™æ˜¯æ›´å¸¸ç”¨çš„æ–¹å¼</strong>ï¼Œé€šè¿‡æ·»åŠ å¤šä¸ªæŒ‡å‘ç›¸åŒç›®æ ‡çš„è¾¹æ¥å®šä¹‰å¹¶è¡Œç»“æ„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">StateGraph</span><span class="w"> </span><span class="n">workflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StateGraph</span><span class="p">(</span><span class="n">keyStrategyFactory</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;source&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">sourceNode</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;task1&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">task1Node</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;task2&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">task2Node</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;task3&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">task3Node</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;merger&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">mergerNode</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// åˆ›å»ºå¹¶è¡Œåˆ†æ”¯ - ä»sourceåˆ°å¤šä¸ªä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;source&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;task1&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;source&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;task2&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;source&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;task3&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// æ±‡èšåˆ°mergerèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;task1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;merger&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;task2&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;merger&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;task3&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;merger&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;source&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;merger&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ç¼–è¯‘æ—¶è½¬æ¢æœºåˆ¶</strong>ï¼š</p>
<p>å½“StateGraphç¼–è¯‘æ—¶ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶è¡Œè¾¹æ¨¡å¼ï¼Œå¹¶åœ¨å†…éƒ¨åˆ›å»ºParallelNodeï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// CompiledGraphç¼–è¯‘è¿‡ç¨‹ä¸­çš„å¤„ç†é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">targets</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// æ£€æµ‹åˆ°å¹¶è¡Œè¾¹ï¼Œè·å–æ‰€æœ‰å¹¶è¡Œç›®æ ‡èŠ‚ç‚¹çš„Action</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parallelNodeStream</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">target</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="na">id</span><span class="p">()))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">toList</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// è‡ªåŠ¨åˆ›å»ºParallelNode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="n">parallelNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ParallelNode</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">sourceId</span><span class="p">(),</span><span class="w"> </span><span class="n">actions</span><span class="p">,</span><span class="w"> </span><span class="n">keyStrategyMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// æ›¿æ¢åŸæœ‰èŠ‚ç‚¹å’Œè¾¹çš„æ˜ å°„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">nodes</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">parallelNode</span><span class="p">.</span><span class="na">id</span><span class="p">(),</span><span class="w"> </span><span class="n">parallelNode</span><span class="p">.</span><span class="na">actionFactory</span><span class="p">().</span><span class="na">apply</span><span class="p">(</span><span class="n">compileConfig</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">edges</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">sourceId</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">EdgeValue</span><span class="p">(</span><span class="n">parallelNode</span><span class="p">.</span><span class="na">id</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="522-å¹¶è¡ŒèŠ‚ç‚¹çš„å†…éƒ¨æ‰§è¡Œæœºåˆ¶">5.2.2 å¹¶è¡ŒèŠ‚ç‚¹çš„å†…éƒ¨æ‰§è¡Œæœºåˆ¶
</h4><p><strong>ParallelNodeçš„æ ¸å¿ƒå®ç°</strong>åŸºäºCompletableFuture.allOf()ï¼Œå®ç°çœŸæ­£çš„å¹¶è¡Œæ‰§è¡Œï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ParallelNode</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">record</span> <span class="nc">AsyncParallelNodeAction</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AsyncNodeActionWithConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actions</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">channels</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">AsyncNodeActionWithConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">RunnableConfig</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partialMergedStates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">asyncGenerators</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰Action</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="n">futures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actions</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">action</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">thenApply</span><span class="p">(</span><span class="n">partialState</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="c1">// åˆ†ç¦»æ™®é€šç»“æœå’ŒAsyncGenerator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">partialState</span><span class="p">.</span><span class="na">forEach</span><span class="p">((</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">AsyncGenerator</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">GeneratorSubscriber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="p">((</span><span class="n">List</span><span class="p">)</span><span class="w"> </span><span class="n">asyncGenerators</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">())).</span><span class="na">add</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">partialMergedStates</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="c1">// ç«‹å³æ›´æ–°çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">state</span><span class="p">.</span><span class="na">updateState</span><span class="p">(</span><span class="n">partialMergedStates</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="n">action</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">toList</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">allOf</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">thenApply</span><span class="p">((</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">CollectionUtils</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">asyncGenerators</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="o">?</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="na">data</span><span class="p">()</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">:</span><span class="w"> </span><span class="n">asyncGenerators</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="523-å¹¶è¡Œæµå¼å¤„ç†çš„åˆå¹¶æœºåˆ¶">5.2.3 å¹¶è¡Œæµå¼å¤„ç†çš„åˆå¹¶æœºåˆ¶
</h4><p><strong>æ ¸å¿ƒæŒ‘æˆ˜</strong>ï¼šå½“å¤šä¸ªå¹¶è¡Œåˆ†æ”¯éƒ½äº§ç”Ÿæµå¼è¾“å‡ºæ—¶ï¼Œå¦‚ä½•å°†è¿™äº›å¼‚æ­¥æµåˆå¹¶æˆç»Ÿä¸€çš„è¾“å‡ºæµï¼Ÿ</p>
<p>Spring AI Alibaba Graphé€šè¿‡<code>AsyncGeneratorUtils.createMergedGenerator</code>åœ¨<strong>æ¡†æ¶å†…æ ¸ä¸­</strong>è§£å†³äº†è¿™ä¸ªå¤æ‚é—®é¢˜ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart TD
</span></span><span class="line"><span class="cl">    A[å¹¶è¡ŒèŠ‚ç‚¹å¯åŠ¨] --&gt; B[åˆ†æ”¯1: AsyncGenerator]
</span></span><span class="line"><span class="cl">    A --&gt; C[åˆ†æ”¯2: AsyncGenerator]
</span></span><span class="line"><span class="cl">    A --&gt; D[åˆ†æ”¯3: AsyncGenerator]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    B --&gt; E[AsyncGeneratorUtils.createMergedGenerator]
</span></span><span class="line"><span class="cl">    C --&gt; E
</span></span><span class="line"><span class="cl">    D --&gt; E
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    E --&gt; F[è½®è¯¢æ‰€æœ‰Generator]
</span></span><span class="line"><span class="cl">    F --&gt; G[StampedLockå¹¶å‘æ§åˆ¶]
</span></span><span class="line"><span class="cl">    G --&gt; H[KeyStrategyçŠ¶æ€åˆå¹¶]
</span></span><span class="line"><span class="cl">    H --&gt; I[ç»Ÿä¸€è¾“å‡ºæµ]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    subgraph &#34;åˆå¹¶ç­–ç•¥&#34;
</span></span><span class="line"><span class="cl">        J[ReplaceStrategy&lt;br/&gt;æ›¿æ¢åˆå¹¶]
</span></span><span class="line"><span class="cl">        K[AppendStrategy&lt;br/&gt;è¿½åŠ åˆå¹¶]
</span></span><span class="line"><span class="cl">        L[CustomStrategy&lt;br/&gt;è‡ªå®šä¹‰åˆå¹¶]
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    H --&gt; J
</span></span><span class="line"><span class="cl">    H --&gt; K
</span></span><span class="line"><span class="cl">    H --&gt; L
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="524-mergedgeneratoræ ¸å¿ƒå®ç°">5.2.4 MergedGeneratoræ ¸å¿ƒå®ç°
</h4><p><strong>AsyncGeneratorUtils.createMergedGenerator</strong>æ˜¯æ¡†æ¶å†…æ ¸çš„æ ¸å¿ƒç®—æ³•ï¼Œå®ç°äº†å¤šä¸ªå¼‚æ­¥æµçš„æ™ºèƒ½åˆå¹¶ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AsyncGenerator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">createMergedGenerator</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AsyncGenerator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">generators</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">keyStrategyMap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AsyncGenerator</span><span class="o">&lt;&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ä½¿ç”¨StampedLockä¼˜åŒ–å¹¶å‘æ€§èƒ½</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">StampedLock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StampedLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">pollCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mergedResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AsyncGenerator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">activeGenerators</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CopyOnWriteArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">generators</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">AsyncGenerator</span><span class="p">.</span><span class="na">Data</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// ä¹è§‚è¯»é”å¿«é€Ÿæ£€æŸ¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">long</span><span class="w"> </span><span class="n">stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">tryOptimisticRead</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">boolean</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activeGenerators</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">.</span><span class="na">validate</span><span class="p">(</span><span class="n">stamp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">readLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">empty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activeGenerators</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">lock</span><span class="p">.</span><span class="na">unlockRead</span><span class="p">(</span><span class="n">stamp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">empty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">AsyncGenerator</span><span class="p">.</span><span class="na">Data</span><span class="p">.</span><span class="na">done</span><span class="p">(</span><span class="n">mergedResult</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// è½®è¯¢ç­–ç•¥é€‰æ‹©Generator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">AsyncGenerator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">current</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">long</span><span class="w"> </span><span class="n">writeStamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activeGenerators</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">AsyncGenerator</span><span class="p">.</span><span class="na">Data</span><span class="p">.</span><span class="na">done</span><span class="p">(</span><span class="n">mergedResult</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kt">int</span><span class="w"> </span><span class="n">currentIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pollCounter</span><span class="p">.</span><span class="na">updateAndGet</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activeGenerators</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">currentIdx</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">lock</span><span class="p">.</span><span class="na">unlockWrite</span><span class="p">(</span><span class="n">writeStamp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// åœ¨æ— é”çŠ¶æ€ä¸‹æ‰§è¡ŒGenerator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">AsyncGenerator</span><span class="p">.</span><span class="na">Data</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="na">next</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// å¤„ç†ç»“æœå¹¶æ›´æ–°çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">writeStamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">activeGenerators</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">current</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">isDone</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">isError</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">handleCompletedGenerator</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activeGenerators</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">return</span><span class="w"> </span><span class="n">AsyncGenerator</span><span class="p">.</span><span class="na">Data</span><span class="p">.</span><span class="na">done</span><span class="p">(</span><span class="n">mergedResult</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">handleCompletedGenerator</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">lock</span><span class="p">.</span><span class="na">unlockWrite</span><span class="p">(</span><span class="n">writeStamp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleCompletedGenerator</span><span class="p">(</span><span class="n">AsyncGenerator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">generator</span><span class="p">,</span><span class="w"> </span><span class="n">AsyncGenerator</span><span class="p">.</span><span class="na">Data</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// ç§»é™¤å®Œæˆçš„Generator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="na">isDone</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">isError</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">activeGenerators</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">generator</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// ä½¿ç”¨KeyStrategyåˆå¹¶ç»“æœ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">data</span><span class="p">.</span><span class="na">resultValue</span><span class="p">().</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">Map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mapResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">mergedResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OverAllState</span><span class="p">.</span><span class="na">updateState</span><span class="p">(</span><span class="n">mergedResult</span><span class="p">,</span><span class="w"> </span><span class="n">mapResult</span><span class="p">,</span><span class="w"> </span><span class="n">keyStrategyMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ ¸å¿ƒç®—æ³•ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li><strong>è½®è¯¢æœºåˆ¶</strong>ï¼šé€šè¿‡pollCounterå®ç°å…¬å¹³çš„è½®è¯¢è°ƒåº¦</li>
<li><strong>StampedLockä¼˜åŒ–</strong>ï¼šä½¿ç”¨ä¹è§‚è¯»é”æé«˜å¹¶å‘æ€§èƒ½</li>
<li><strong>çŠ¶æ€åˆå¹¶</strong>ï¼šé€šè¿‡KeyStrategyå®ç°çµæ´»çš„çŠ¶æ€åˆå¹¶ç­–ç•¥</li>
<li><strong>çº¿ç¨‹å®‰å…¨</strong>ï¼šCopyOnWriteArrayListç¡®ä¿å¹¶å‘è®¿é—®çš„å®‰å…¨æ€§</li>
</ul>
<h4 id="525-æµå¼è¾“å‡ºé…ç½®">5.2.5 æµå¼è¾“å‡ºé…ç½®
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&#34;/stream&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StreamingController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CompiledGraph</span><span class="w"> </span><span class="n">compiledGraph</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;/process&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">produces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">TEXT_EVENT_STREAM_VALUE</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Flux</span><span class="o">&lt;</span><span class="n">ServerSentEvent</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">processStream</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Flux</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">sink</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">AsyncGenerator</span><span class="o">&lt;</span><span class="n">NodeOutput</span><span class="o">&gt;</span><span class="w"> </span><span class="n">generator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compiledGraph</span><span class="p">.</span><span class="na">stream</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">RunnableConfig</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">threadId</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">generator</span><span class="p">.</span><span class="na">forEachAsync</span><span class="p">(</span><span class="n">output</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">output</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">StreamingOutput</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">StreamingOutput</span><span class="w"> </span><span class="n">streamingOutput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">StreamingOutput</span><span class="p">)</span><span class="w"> </span><span class="n">output</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">String</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">streamingOutput</span><span class="p">.</span><span class="na">chunk</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">sink</span><span class="p">.</span><span class="na">next</span><span class="p">(</span><span class="n">ServerSentEvent</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="n">chunk</span><span class="p">).</span><span class="na">build</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}).</span><span class="na">thenRun</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">sink</span><span class="p">.</span><span class="na">complete</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}).</span><span class="na">exceptionally</span><span class="p">(</span><span class="n">throwable</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">sink</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">throwable</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sink</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="53-å­å›¾èŠ‚ç‚¹">5.3 å­å›¾èŠ‚ç‚¹
</h3><p><strong>å­å›¾èŠ‚ç‚¹æ˜¯å·¥ä½œæµçš„æ¨¡å—åŒ–ç»„ä»¶</strong>ï¼Œå®ƒå…è®¸å°†å¤æ‚çš„å·¥ä½œæµåˆ†è§£ä¸ºå¯é‡ç”¨çš„å­æ¨¡å—ã€‚å­å›¾èŠ‚ç‚¹å°±åƒå‡½æ•°è°ƒç”¨ä¸€æ ·ï¼Œå¯ä»¥åœ¨ä¸»å·¥ä½œæµä¸­è°ƒç”¨é¢„å®šä¹‰çš„å­å·¥ä½œæµï¼Œå®ç°ä»£ç å¤ç”¨å’Œæ¨¡å—åŒ–è®¾è®¡ã€‚</p>
<h4 id="531-å­å›¾èŠ‚ç‚¹ç±»å‹">5.3.1 å­å›¾èŠ‚ç‚¹ç±»å‹
</h4><p>Spring AI Alibaba Graphæ”¯æŒä¸¤ç§ç±»å‹çš„å­å›¾èŠ‚ç‚¹ï¼š</p>
<h5 id="substategraphnode---æœªç¼–è¯‘å­å›¾èŠ‚ç‚¹">SubStateGraphNode - æœªç¼–è¯‘å­å›¾èŠ‚ç‚¹
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SubStateGraphNode</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="n">subGraph</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">SubStateGraphNode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="n">subGraph</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// åœ¨è¿è¡Œæ—¶ç¼–è¯‘å­å›¾</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">CompiledGraph</span><span class="w"> </span><span class="n">compiledSubGraph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subGraph</span><span class="p">.</span><span class="na">compile</span><span class="p">(</span><span class="n">config</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SubGraphAction</span><span class="p">(</span><span class="n">compiledSubGraph</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">subGraph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subGraph</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="subcompiledgraphnode---é¢„ç¼–è¯‘å­å›¾èŠ‚ç‚¹">SubCompiledGraphNode - é¢„ç¼–è¯‘å­å›¾èŠ‚ç‚¹
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SubCompiledGraphNode</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CompiledGraph</span><span class="w"> </span><span class="n">subGraph</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">SubCompiledGraphNode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">CompiledGraph</span><span class="w"> </span><span class="n">subGraph</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SubGraphAction</span><span class="p">(</span><span class="n">subGraph</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">subGraph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subGraph</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="532-å­å›¾å®šä¹‰ä¸ä½¿ç”¨">5.3.2 å­å›¾å®šä¹‰ä¸ä½¿ç”¨
</h4><p><strong>å®šä¹‰æ–‡æ¡£å¤„ç†å­å›¾</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DocumentProcessingSubGraph</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="nf">createDocumentProcessingGraph</span><span class="p">(</span><span class="n">ChatModel</span><span class="w"> </span><span class="n">chatModel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ChatClient</span><span class="w"> </span><span class="n">chatClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChatClient</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="n">chatModel</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æ–‡æ¡£æå–èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DocumentExtractorNode</span><span class="w"> </span><span class="n">extractorNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DocumentExtractorNode</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;document_path&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;extracted_text&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;pdf&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;docx&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;txt&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æ–‡æ¡£åˆ†æèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LlmNode</span><span class="w"> </span><span class="n">analysisNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LlmNode</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">chatClient</span><span class="p">(</span><span class="n">chatClient</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">systemPromptTemplate</span><span class="p">(</span><span class="s">&#34;ä½ æ˜¯ä¸€ä¸ªæ–‡æ¡£åˆ†æä¸“å®¶ï¼Œè¯·åˆ†ææ–‡æ¡£å†…å®¹å¹¶æå–å…³é”®ä¿¡æ¯ã€‚&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">userPromptTemplate</span><span class="p">(</span><span class="s">&#34;è¯·åˆ†æä»¥ä¸‹æ–‡æ¡£å†…å®¹ï¼š\n{extracted_text}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">outputKey</span><span class="p">(</span><span class="s">&#34;analysis_result&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">KeyStrategyFactory</span><span class="w"> </span><span class="n">stateFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">strategies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;document_path&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;extracted_text&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;analysis_result&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">strategies</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StateGraph</span><span class="p">(</span><span class="s">&#34;æ–‡æ¡£å¤„ç†å­å›¾&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">stateFactory</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;extractor&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">extractorNode</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;analyzer&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">analysisNode</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;extractor&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;extractor&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;analyzer&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;analyzer&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>åœ¨ä¸»å·¥ä½œæµä¸­ä½¿ç”¨å­å›¾</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MainWorkflowConfiguration</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="nf">mainWorkflow</span><span class="p">(</span><span class="n">ChatModel</span><span class="w"> </span><span class="n">chatModel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// åˆ›å»ºå­å›¾</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">StateGraph</span><span class="w"> </span><span class="n">documentProcessingSubGraph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DocumentProcessingSubGraph</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">createDocumentProcessingGraph</span><span class="p">(</span><span class="n">chatModel</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// åˆ›å»ºå…¶ä»–èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">QuestionClassifierNode</span><span class="w"> </span><span class="n">classifierNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QuestionClassifierNode</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">chatClient</span><span class="p">(</span><span class="n">ChatClient</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="n">chatModel</span><span class="p">).</span><span class="na">build</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">inputTextKey</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">outputKey</span><span class="p">(</span><span class="s">&#34;classifier_output&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">categories</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;document_processing&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;general_question&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LlmNode</span><span class="w"> </span><span class="n">generalAnswerNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LlmNode</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">chatClient</span><span class="p">(</span><span class="n">ChatClient</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="n">chatModel</span><span class="p">).</span><span class="na">build</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">systemPromptTemplate</span><span class="p">(</span><span class="s">&#34;ä½ æ˜¯ä¸€ä¸ªé€šç”¨åŠ©æ‰‹ï¼Œè¯·å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">userPromptTemplate</span><span class="p">(</span><span class="s">&#34;ç”¨æˆ·é—®é¢˜ï¼š{input}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">outputKey</span><span class="p">(</span><span class="s">&#34;general_answer&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">KeyStrategyFactory</span><span class="w"> </span><span class="n">stateFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">strategies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;classifier_output&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;document_path&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;extracted_text&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;analysis_result&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;general_answer&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">strategies</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StateGraph</span><span class="p">(</span><span class="s">&#34;ä¸»å·¥ä½œæµ&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">stateFactory</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;classifier&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">classifierNode</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;document_processor&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">documentProcessingSubGraph</span><span class="p">)</span><span class="w">  </span><span class="c1">// æ·»åŠ å­å›¾</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;general_answer&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">generalAnswerNode</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;classifier&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addConditionalEdges</span><span class="p">(</span><span class="s">&#34;classifier&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">edge_async</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ClassifierDispatcher</span><span class="p">()),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;document_processing&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;document_processor&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                       </span><span class="s">&#34;general_question&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;general_answer&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;document_processor&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;general_answer&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="533-å­å›¾æ‰§è¡Œæµç¨‹">5.3.3 å­å›¾æ‰§è¡Œæµç¨‹
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sequenceDiagram
</span></span><span class="line"><span class="cl">    participant Main as ä¸»å·¥ä½œæµ
</span></span><span class="line"><span class="cl">    participant SubNode as å­å›¾èŠ‚ç‚¹
</span></span><span class="line"><span class="cl">    participant SubGraph as å­å›¾CompiledGraph
</span></span><span class="line"><span class="cl">    participant SubNodes as å­å›¾å†…éƒ¨èŠ‚ç‚¹
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    Main-&gt;&gt;SubNode: æ‰§è¡Œå­å›¾èŠ‚ç‚¹
</span></span><span class="line"><span class="cl">    SubNode-&gt;&gt;SubGraph: è°ƒç”¨å­å›¾.invoke()
</span></span><span class="line"><span class="cl">    SubGraph-&gt;&gt;SubNodes: æ‰§è¡Œå­å›¾å†…éƒ¨æµç¨‹
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    loop å­å›¾å†…éƒ¨æ‰§è¡Œ
</span></span><span class="line"><span class="cl">        SubNodes-&gt;&gt;SubNodes: èŠ‚ç‚¹é—´çŠ¶æ€æµè½¬
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    SubNodes--&gt;&gt;SubGraph: è¿”å›å­å›¾ç»“æœ
</span></span><span class="line"><span class="cl">    SubGraph--&gt;&gt;SubNode: è¿”å›æ‰§è¡Œç»“æœ
</span></span><span class="line"><span class="cl">    SubNode--&gt;&gt;Main: æ›´æ–°ä¸»å·¥ä½œæµçŠ¶æ€
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="534-å­å›¾çŠ¶æ€ç®¡ç†">5.3.4 å­å›¾çŠ¶æ€ç®¡ç†
</h4><p><strong>çŠ¶æ€éš”ç¦»ä¸ä¼ é€’</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SubGraphAction</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">AsyncNodeActionWithConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CompiledGraph</span><span class="w"> </span><span class="n">subGraph</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">RunnableConfig</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// ä»ä¸»çŠ¶æ€ä¸­æå–å­å›¾éœ€è¦çš„æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">subGraphInput</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractSubGraphInput</span><span class="p">(</span><span class="n">state</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// æ‰§è¡Œå­å›¾</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">OverAllState</span><span class="o">&gt;</span><span class="w"> </span><span class="n">subGraphResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subGraph</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">subGraphInput</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// å°†å­å›¾ç»“æœæ˜ å°„å›ä¸»çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">mapSubGraphOutput</span><span class="p">(</span><span class="n">subGraphResult</span><span class="p">.</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&#34;å­å›¾æ‰§è¡Œå¤±è´¥&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">extractSubGraphInput</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æ ¹æ®å­å›¾çš„è¾“å…¥éœ€æ±‚æå–æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">state</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="s">&#34;document_path&#34;</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;document_path&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">state</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">input</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">mapSubGraphOutput</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">subGraphState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">subGraphState</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// å°†å­å›¾çš„è¾“å‡ºæ˜ å°„åˆ°ä¸»çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">subGraphState</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="s">&#34;analysis_result&#34;</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">output</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;analysis_result&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">subGraphState</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="s">&#34;extracted_text&#34;</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">output</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;extracted_text&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">output</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="54-ä¸­æ–­ä¸æ¢å¤æœºåˆ¶">5.4 ä¸­æ–­ä¸æ¢å¤æœºåˆ¶
</h3><p><strong>ä¸­æ–­ä¸æ¢å¤æœºåˆ¶æ˜¯å·¥ä½œæµçš„å®¹é”™ä¿éšœ</strong>ï¼Œå®ƒè®©å·¥ä½œæµèƒ½å¤Ÿåœ¨é‡åˆ°éœ€è¦äººå·¥å¹²é¢„æˆ–å¤–éƒ¨æ¡ä»¶ä¸æ»¡è¶³æ—¶ä¼˜é›…åœ°æš‚åœæ‰§è¡Œï¼Œå¹¶åœ¨æ¡ä»¶æ»¡è¶³åæ— ç¼æ¢å¤ã€‚è¿™ç§æœºåˆ¶å¯¹äºæ„å»ºå¯é çš„ä¼ä¸šçº§AIåº”ç”¨è‡³å…³é‡è¦ã€‚</p>
<h4 id="541-ä¸­æ–­æœºåˆ¶åŸç†">5.4.1 ä¸­æ–­æœºåˆ¶åŸç†
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">stateDiagram-v2
</span></span><span class="line"><span class="cl">    [*] --&gt; Executing: å¼€å§‹æ‰§è¡Œ
</span></span><span class="line"><span class="cl">    Executing --&gt; CheckingInterrupt: æ£€æŸ¥ä¸­æ–­æ¡ä»¶
</span></span><span class="line"><span class="cl">    CheckingInterrupt --&gt; Interrupted: æ»¡è¶³ä¸­æ–­æ¡ä»¶
</span></span><span class="line"><span class="cl">    CheckingInterrupt --&gt; ContinueExecuting: ç»§ç»­æ‰§è¡Œ
</span></span><span class="line"><span class="cl">    ContinueExecuting --&gt; Executing: ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
</span></span><span class="line"><span class="cl">    Interrupted --&gt; SavingSnapshot: ä¿å­˜çŠ¶æ€å¿«ç…§
</span></span><span class="line"><span class="cl">    SavingSnapshot --&gt; WaitingForResume: ç­‰å¾…æ¢å¤
</span></span><span class="line"><span class="cl">    WaitingForResume --&gt; LoadingSnapshot: åŠ è½½å¿«ç…§
</span></span><span class="line"><span class="cl">    LoadingSnapshot --&gt; Executing: æ¢å¤æ‰§è¡Œ
</span></span><span class="line"><span class="cl">    Executing --&gt; [*]: æ‰§è¡Œå®Œæˆ
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="542-ä¸­æ–­æ¡ä»¶é…ç½®">5.4.2 ä¸­æ–­æ¡ä»¶é…ç½®
</h4><p><strong>InterruptBefore - èŠ‚ç‚¹æ‰§è¡Œå‰ä¸­æ–­</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InterruptConfiguration</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompiledGraph</span><span class="w"> </span><span class="nf">interruptableGraph</span><span class="p">(</span><span class="n">StateGraph</span><span class="w"> </span><span class="n">stateGraph</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">stateGraph</span><span class="p">.</span><span class="na">compile</span><span class="p">(</span><span class="n">CompileConfig</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">withInterruptBefore</span><span class="p">(</span><span class="s">&#34;human_approval&#34;</span><span class="p">)</span><span class="w">  </span><span class="c1">// åœ¨human_approvalèŠ‚ç‚¹å‰ä¸­æ–­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>InterruptAfter - èŠ‚ç‚¹æ‰§è¡Œåä¸­æ–­</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">CompiledGraph</span><span class="w"> </span><span class="nf">interruptableGraph</span><span class="p">(</span><span class="n">StateGraph</span><span class="w"> </span><span class="n">stateGraph</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stateGraph</span><span class="p">.</span><span class="na">compile</span><span class="p">(</span><span class="n">CompileConfig</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">withInterruptAfter</span><span class="p">(</span><span class="s">&#34;data_processing&#34;</span><span class="p">)</span><span class="w">  </span><span class="c1">// åœ¨data_processingèŠ‚ç‚¹åä¸­æ–­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>åŠ¨æ€ä¸­æ–­æ¡ä»¶</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DynamicInterruptNode</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">AsyncNodeActionWithConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">RunnableConfig</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// æ£€æŸ¥æ˜¯å¦éœ€è¦ä¸­æ–­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldInterrupt</span><span class="p">(</span><span class="n">state</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// è®¾ç½®ä¸­æ–­æ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">state</span><span class="p">.</span><span class="na">setInterruptMessage</span><span class="p">(</span><span class="s">&#34;éœ€è¦äººå·¥å®¡æ‰¹ï¼Œè¯·æ£€æŸ¥æ•°æ®è´¨é‡&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;interrupt_reason&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;data_quality_check&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;requires_approval&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// æ­£å¸¸å¤„ç†é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">processData</span><span class="p">(</span><span class="n">state</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">shouldInterrupt</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è‡ªå®šä¹‰ä¸­æ–­æ¡ä»¶é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Double</span><span class="w"> </span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Double</span><span class="p">)</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="na">value</span><span class="p">(</span><span class="s">&#34;confidence_score&#34;</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="n">1</span><span class="p">.</span><span class="na">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">confidence</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">.</span><span class="na">8</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç½®ä¿¡åº¦ä½äº80%æ—¶ä¸­æ–­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="543-çŠ¶æ€å¿«ç…§ç®¡ç†">5.4.3 çŠ¶æ€å¿«ç…§ç®¡ç†
</h4><p><strong>å†…å­˜å¿«ç…§å­˜å‚¨</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MemorySnapshotManager</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">OverAllState</span><span class="o">&gt;</span><span class="w"> </span><span class="n">snapshots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">saveSnapshot</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">snapshotId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">snapshots</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">snapshotId</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="na">snapShot</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="n">state</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">snapshotId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">OverAllState</span><span class="w"> </span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">snapshotId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">OverAllState</span><span class="w"> </span><span class="n">snapshot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">snapshots</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">snapshotId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">snapshot</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&#34;å¿«ç…§ä¸å­˜åœ¨: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">snapshotId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">snapshot</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeSnapshot</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">snapshotId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">snapshots</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">snapshotId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æŒä¹…åŒ–å¿«ç…§å­˜å‚¨</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PersistentSnapshotManager</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">objectMapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">saveSnapshot</span><span class="p">(</span><span class="n">OverAllState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">snapshotId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">serializedState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objectMapper</span><span class="p">.</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="n">state</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;snapshot:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">snapshotId</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">serializedState</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofHours</span><span class="p">(</span><span class="n">24</span><span class="p">)</span><span class="w">  </span><span class="c1">// 24å°æ—¶è¿‡æœŸ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">snapshotId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&#34;ä¿å­˜å¿«ç…§å¤±è´¥&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">OverAllState</span><span class="w"> </span><span class="nf">loadSnapshot</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">snapshotId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">serializedState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;snapshot:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">snapshotId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">serializedState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&#34;å¿«ç…§ä¸å­˜åœ¨: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">snapshotId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">objectMapper</span><span class="p">.</span><span class="na">readValue</span><span class="p">(</span><span class="n">serializedState</span><span class="p">,</span><span class="w"> </span><span class="n">OverAllState</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&#34;åŠ è½½å¿«ç…§å¤±è´¥&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="6-å¿«é€Ÿå¼€å§‹ä¸å®æˆ˜æŒ‡å—">6. å¿«é€Ÿå¼€å§‹ä¸å®æˆ˜æŒ‡å—
</h2><h3 id="61-ç¯å¢ƒå‡†å¤‡">6.1 ç¯å¢ƒå‡†å¤‡
</h3><h4 id="611-ä¾èµ–é…ç½®">6.1.1 ä¾èµ–é…ç½®
</h4><p>åœ¨æ‚¨çš„Spring Booté¡¹ç›®ä¸­æ·»åŠ Spring AI Alibaba Graphä¾èµ–ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;spring-ai-alibaba.version&gt;</span>1.0.0.3-SNAPSHOT<span class="nt">&lt;/spring-ai-alibaba.version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud.ai<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-ai-alibaba-starter-dashscope<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${spring-ai-alibaba.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud.ai<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-ai-alibaba-graph-core<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;version&gt;</span>${spring-ai-alibaba.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="62-å¿«é€Ÿå¼€å§‹æµç¨‹">6.2 å¿«é€Ÿå¼€å§‹æµç¨‹
</h3><h4 id="621-åˆ›å»ºç¬¬ä¸€ä¸ªå·¥ä½œæµ">6.2.1 åˆ›å»ºç¬¬ä¸€ä¸ªå·¥ä½œæµ
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyFirstGraphConfiguration</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">StateGraph</span><span class="w"> </span><span class="nf">myFirstGraph</span><span class="p">(</span><span class="n">ChatModel</span><span class="w"> </span><span class="n">chatModel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 1. åˆ›å»ºChatClient</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ChatClient</span><span class="w"> </span><span class="n">chatClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChatClient</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="n">chatModel</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 2. å®šä¹‰èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LlmNode</span><span class="w"> </span><span class="n">welcomeNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LlmNode</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">chatClient</span><span class="p">(</span><span class="n">chatClient</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">systemPromptTemplate</span><span class="p">(</span><span class="s">&#34;ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„åŠ©æ‰‹&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">userPromptTemplate</span><span class="p">(</span><span class="s">&#34;æ¬¢è¿ç”¨æˆ·ï¼š{input}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">outputKey</span><span class="p">(</span><span class="s">&#34;welcome_message&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 3. å®šä¹‰çŠ¶æ€ç­–ç•¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">KeyStrategyFactory</span><span class="w"> </span><span class="n">stateFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">KeyStrategy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">strategies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">strategies</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;welcome_message&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplaceStrategy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">strategies</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 4. æ„å»ºå·¥ä½œæµ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StateGraph</span><span class="p">(</span><span class="s">&#34;æˆ‘çš„ç¬¬ä¸€ä¸ªå·¥ä½œæµ&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">stateFactory</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addNode</span><span class="p">(</span><span class="s">&#34;welcome&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node_async</span><span class="p">(</span><span class="n">welcomeNode</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;welcome&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addEdge</span><span class="p">(</span><span class="s">&#34;welcome&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompiledGraph</span><span class="w"> </span><span class="nf">compiledGraph</span><span class="p">(</span><span class="n">StateGraph</span><span class="w"> </span><span class="n">myFirstGraph</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">myFirstGraph</span><span class="p">.</span><span class="na">compile</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="622-ä½¿ç”¨å·¥ä½œæµ">6.2.2 ä½¿ç”¨å·¥ä½œæµ
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GraphController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CompiledGraph</span><span class="w"> </span><span class="n">compiledGraph</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&#34;/chat&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">chat</span><span class="p">(</span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">OverAllState</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compiledGraph</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;input&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">OverAllState</span><span class="p">::</span><span class="n">data</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="63-å®Œæ•´ç¤ºä¾‹é¡¹ç›®">6.3 å®Œæ•´ç¤ºä¾‹é¡¹ç›®
</h3><p>ä¸ºäº†å¸®åŠ©å¼€å‘è€…æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨Spring AI Alibaba Graphï¼Œæˆ‘ä»¬æä¾›äº†å®Œæ•´çš„ç¤ºä¾‹é¡¹ç›®ï¼š</p>
<p><strong>ğŸ“š å®˜æ–¹ç¤ºä¾‹ä»“åº“</strong>ï¼š<a class="link" href="https://github.com/springaialibaba/spring-ai-alibaba-examples/tree/main/spring-ai-alibaba-graph-example"  target="_blank" rel="noopener"
    >spring-ai-alibaba-graph-example</a></p>
<p><strong>å¿«é€Ÿä½“éªŒæ­¥éª¤</strong>ï¼š</p>
<ol>
<li>
<p><strong>å…‹éš†ä»“åº“</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/springaialibaba/spring-ai-alibaba-examples.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> spring-ai-alibaba-examples/spring-ai-alibaba-graph-example
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>é…ç½®ç¯å¢ƒ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># è®¾ç½®DashScope API Key</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">AI_DASHSCOPE_API_KEY</span><span class="o">=</span>your_api_key_here
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>è¿è¡Œç¤ºä¾‹</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mvn spring-boot:run
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="64-ç¤¾åŒºæ”¯æŒ">6.4 ç¤¾åŒºæ”¯æŒ
</h3><p><strong>æŠ€æœ¯æ”¯æŒ</strong>ï¼š</p>
<ul>
<li><strong>GitHub Issues</strong>ï¼š<a class="link" href="https://github.com/alibaba/spring-ai-alibaba/issues"  target="_blank" rel="noopener"
    >æäº¤é—®é¢˜å’Œå»ºè®®</a></li>
<li><strong>å®˜æ–¹æ–‡æ¡£</strong>ï¼š<a class="link" href="https://java2ai.com/"  target="_blank" rel="noopener"
    >å®Œæ•´æ–‡æ¡£ç«™ç‚¹</a></li>
<li><strong>ç¤ºä¾‹ä»£ç </strong>ï¼š<a class="link" href="https://github.com/springaialibaba/spring-ai-alibaba-examples"  target="_blank" rel="noopener"
    >æ›´å¤šç¤ºä¾‹</a></li>
</ul>
<p>é€šè¿‡ä»¥ä¸ŠæŒ‡å—å’Œå®Œæ•´çš„ç¤ºä¾‹é¡¹ç›®ï¼Œæ‚¨å¯ä»¥å¿«é€ŸæŒæ¡Spring AI Alibaba Graphçš„ä½¿ç”¨æ–¹æ³•ï¼Œå¹¶åœ¨å®é™…é¡¹ç›®ä¸­é«˜æ•ˆåœ°æ„å»ºæ™ºèƒ½åŒ–åº”ç”¨ã€‚</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/java/">Java</a>
        
            <a href="/tags/llm/">LLM</a>
        
            <a href="/tags/infrastructure/">Infrastructure</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/langsmith%E8%B0%83%E7%A0%94%E8%AE%B0%E5%BD%95/">
        
        

        <div class="article-details">
            <h2 class="article-title">LangSmithè°ƒç ”è®°å½•</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/%E5%85%AB%E8%82%A1%E6%96%87%E4%B9%8Bjava%E9%9B%86%E5%90%88/">
        
        

        <div class="article-details">
            <h2 class="article-title">å…«è‚¡æ–‡ä¹‹Javaé›†åˆ</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/%E5%85%AB%E8%82%A1%E6%96%87%E4%B9%8Bjava%E5%9F%BA%E7%A1%80/">
        
        

        <div class="article-details">
            <h2 class="article-title">å…«è‚¡æ–‡ä¹‹JavaåŸºç¡€</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/%E5%85%AB%E8%82%A1%E6%96%87%E4%B9%8Bjava%E5%B9%B6%E5%8F%91/">
        
        

        <div class="article-details">
            <h2 class="article-title">å…«è‚¡æ–‡ä¹‹Javaå¹¶å‘</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/spring-ai-alibaba-graph-core-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">
        
        

        <div class="article-details">
            <h2 class="article-title">spring-ai-alibaba-graph-core æºç é˜…è¯»</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 sixiyida
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
